<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ORDINA">
    <link rel="apple-touch-icon"
        href="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png">

    <!-- Встроенные модули для работы без сервера -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .tab-active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .task-tab-active {
            background-color: #3b82f6;
            color: white;
        }

        .calendar-day {
            min-height: 120px;
        }

        .calendar-day-today {
            background-color: #eff6ff;
        }

        .calendar-day-number {
            width: 32px;
            height: 32px;
        }

        .calendar-day-today .calendar-day-number {
            background-color: #3b82f6;
            color: white;
        }

        .currency-btn-active {
            background-color: #3b82f6;
            color: white;
        }

        img[alt="ORDINA Logo"] {
            background: transparent !important;
            background-color: transparent !important;
            mix-blend-mode: multiply;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success {
            background-color: #ecfdf5;
            color: #065f46;
        }

        .toast-error {
            background-color: #fef2f2;
            color: #991b1b;
        }

        /* Modal Animation */
        dialog[open] {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Улучшенные стили для логотипа */
        .logo-container {
            position: relative;
        }

        .logo-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 2rem;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .logo-container:hover::before {
            opacity: 1;
        }

        /* Адаптивные отступы для контента */
        @media (max-width: 640px) {
            #app {
                padding-left: 5rem !important;
            }
        }

        @media (min-width: 641px) and (max-width: 768px) {
            #app {
                padding-left: 7rem !important;
            }
        }

        /* Плавное появление логотипа */
        .logo-container img {
            animation: logoFadeIn 1s ease-out;
        }

        @keyframes logoFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 0.9;
                transform: translateY(0) scale(1);
            }
        }

        /* Touch-устройства */
        @media (hover: none) and (pointer: coarse) {

            /* Отключаем hover эффекты на touch */
            .hover\:scale-105:hover {
                transform: none;
            }

            .hover\:-translate-y-1:hover {
                transform: none;
            }

            /* Увеличиваем активные области */
            button,
            .tab-button,
            [role="button"] {
                min-height: 44px;
                min-width: 44px;
            }

            /* Улучшенная панель для touch */
            .fixed.top-4.right-4 {
                padding: 1.25rem !important;
                border-radius: 2rem !important;
            }

            .fixed.top-4.right-4 button {
                padding: 1rem !important;
                border-radius: 1rem !important;
            }

            /* Увеличенные элементы управления */
            input[type="range"] {
                height: 1.5rem !important;
                -webkit-appearance: none;
                appearance: none;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 1.5rem;
                height: 1.5rem;
                -webkit-appearance: none;
                appearance: none;
                background: #3b82f6;
                border-radius: 50%;
                cursor: pointer;
            }
        }

        /* Улучшенная навигация */
        .tab-button {
            position: relative;
            overflow: hidden;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .tab-button:hover::before {
            left: 100%;
        }

        /* Улучшенные карточки */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        /* Responsive Tables (Card View on Mobile) */
        @media screen and (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 1rem;
                margin-bottom: 1rem;
                padding: 1.5rem;
                background-color: #ffffff;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
            }

            .responsive-table tr:last-child {
                margin-bottom: 0;
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
                font-size: 0.95rem;
            }

            .responsive-table td:last-child {
                border-bottom: none;
                padding-top: 1rem;
                justify-content: flex-end;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563;
                margin-right: 1rem;
                font-size: 0.875rem;
            }

            /* Мобильная панель управления */
            .fixed.top-4.right-4 {
                position: fixed;
                bottom: 1rem;
                top: auto;
                right: 1rem;
                left: 1rem;
                width: auto;
                border-radius: 1.5rem 1.5rem 1.5rem 1.5rem;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
            }

            .fixed.top-4.right-4 .flex {
                flex-wrap: wrap;
                justify-content: space-around;
                align-items: center;
                gap: 1rem;
            }

            /* Увеличенные touch targets на мобильных */
            .fixed.top-4.right-4 button {
                min-height: 44px;
                min-width: 44px;
                padding: 0.75rem;
                font-size: 0.875rem;
            }

            .fixed.top-4.right-4 .w-6.h-6 {
                width: 2rem !important;
                height: 2rem !important;
                font-size: 0.75rem;
            }

            .fixed.top-4.right-4 .w-7.h-7 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }

            /* Мобильный логотип */
            .fixed.top-4.left-4 {
                top: 1rem;
                left: 1rem;
            }

            .fixed.top-4.left-4 img {
                height: 3rem !important;
            }

            /* Мобильные карточки статистики */
            .stat-card {
                padding: 1.5rem;
            }

            .stat-card p {
                font-size: 2rem !important;
            }
        }

        /* Планшетные стили */
        @media screen and (min-width: 641px) and (max-width: 1024px) {
            .fixed.top-4.right-4 {
                top: 1rem;
                bottom: auto;
                right: 1rem;
                left: auto;
                width: auto;
                border-radius: 1rem;
                padding: 0.75rem;
            }

            .fixed.top-4.right-4 .flex {
                gap: 0.75rem;
                justify-content: flex-end;
            }

            .fixed.top-4.left-4 img {
                height: 4rem !important;
            }
        }

        /* Дополнительные мобильные стили */
        @media screen and (max-width: 640px) {
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .stat-card h3 {
                font-size: 1rem;
            }

            .stat-card .w-12.h-12 {
                width: 2.5rem;
                height: 2.5rem;
            }

            .stat-card .w-12.h-12 svg {
                width: 1.25rem;
                height: 1.25rem;
            }

            /* Мобильная навигация */
            .tab-button {
                padding: 1rem 0.75rem;
                min-height: 44px;
            }

            /* Увеличенные отступы для контента */
            #app {
                padding-left: 1rem !important;
                padding-bottom: 6rem !important;
            }
        }

        /* Accessibility стили */
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        .focus-visible,
        *:focus-visible {
            outline: 3px solid #3b82f6 !important;
            outline-offset: 2px !important;
            border-radius: 4px;
        }

        button:focus-visible,
        [role="button"]:focus-visible {
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           УЛУЧШЕННАЯ ТЕМНАЯ ТЕМА - Правильная видимость всех элементов
           ═══════════════════════════════════════════════════════════════ */
        
        :root {
            /* Светлая тема */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
        }

        .dark {
            /* Темная тема - улучшенные цвета для читаемости */
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #475569;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Основные фоны */
        .dark .bg-white {
            background-color: var(--bg-primary) !important;
        }

        .dark .bg-gray-50 {
            background-color: var(--bg-secondary) !important;
        }

        .dark .bg-gray-100 {
            background-color: var(--bg-tertiary) !important;
        }

        /* Текст */
        .dark .text-gray-800,
        .dark .text-gray-900 {
            color: var(--text-primary) !important;
        }

        .dark .text-gray-600,
        .dark .text-gray-700 {
            color: var(--text-secondary) !important;
        }

        .dark .text-gray-500 {
            color: var(--text-tertiary) !important;
        }

        /* Границы */
        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: var(--border-color) !important;
        }

        /* Карточки статистики */
        .dark .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
            border-color: var(--border-color) !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
        }

        .dark .stat-card:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3) !important;
        }

        /* Навигация */
        .dark nav {
            background-color: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }

        .dark .tab-button {
            color: var(--text-secondary) !important;
        }

        .dark .tab-button:hover {
            color: var(--text-primary) !important;
            background-color: var(--bg-tertiary) !important;
        }

        .dark .tab-active {
            color: var(--accent-color) !important;
            border-bottom-color: var(--accent-color) !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }

        /* Панели управления */
        .dark .fixed.top-4.right-4,
        .dark .fixed.top-4.left-4 {
            background: rgba(30, 41, 59, 0.95) !important;
            border-color: var(--border-color) !important;
            backdrop-filter: blur(20px);
        }

        /* Таблицы */
        .dark table {
            color: var(--text-primary) !important;
        }

        .dark thead {
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
        }

        .dark thead th {
            color: var(--accent-color) !important;
        }

        .dark tbody tr {
            background-color: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }

        .dark tbody tr:hover {
            background-color: var(--bg-tertiary) !important;
        }

        .dark tbody td {
            color: var(--text-primary) !important;
        }

        /* Формы и инпуты */
        .dark input,
        .dark select,
        .dark textarea {
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .dark input::placeholder,
        .dark textarea::placeholder {
            color: var(--text-tertiary) !important;
        }

        .dark input:focus,
        .dark select:focus,
        .dark textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important;
        }

        /* Кнопки */
        .dark button {
            color: var(--text-primary) !important;
        }

        .dark .bg-blue-600 {
            background-color: var(--accent-color) !important;
        }

        .dark .bg-blue-600:hover {
            background-color: var(--accent-hover) !important;
        }

        /* Модальные окна */
        .dark dialog {
            background-color: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .dark dialog h3 {
            color: var(--accent-color) !important;
        }

        /* Loading overlay */
        .dark #loading-overlay {
            background-color: rgba(15, 23, 42, 0.9) !important;
        }

        .dark #loading-overlay p {
            color: var(--text-primary) !important;
        }

        /* Toast уведомления */
        .dark .toast-success {
            background-color: #064e3b !important;
            color: #d1fae5 !important;
        }

        .dark .toast-error {
            background-color: #7f1d1d !important;
            color: #fecaca !important;
        }

        /* Календарь */
        .dark .calendar-day {
            background-color: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }

        .dark .calendar-day-today {
            background-color: rgba(96, 165, 250, 0.2) !important;
        }

        .dark .calendar-day-today .calendar-day-number {
            background-color: var(--accent-color) !important;
        }

        /* Spotify плеер */
        .dark #spotify-player-container {
            background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%) !important;
        }

        /* Виджет погоды */
        .dark #weather-widget {
            background-color: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        /* Скроллбар для темной темы */
        .dark ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* Переключатель темы */
        #theme-toggle {
            position: relative;
            overflow: hidden;
        }

        #theme-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        #theme-toggle:hover::before {
            left: 100%;
        }

        * {
            transition: background-color 0.3s ease,
                border-color 0.3s ease,
                color 0.3s ease;
        }
    </style>
</head>

<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-4 text-lg font-semibold text-gray-700" data-i18n="loading">Загрузка данных...</p>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-container"
        class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 py-4 px-4">
        <div class="max-w-sm w-full space-y-6">
            <div class="flex justify-center space-x-2 mb-4">
                <button id="lang-ru-login" title="Русский"
                    class="px-3 py-1 text-xs font-medium rounded-lg bg-blue-600 text-white">RU</button>
                <button id="lang-en-login" title="English"
                    class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">EN</button>
                <button id="lang-az-login" title="Azərbaycan"
                    class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">AZ</button>
            </div>
            <div class="text-center">
                <div class="mb-6 logo-container">
                    <img src="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png"
                        alt="ORDINA Logo"
                        class="mx-auto h-56 sm:h-64 md:h-72 w-auto drop-shadow-2xl hover:scale-105 transition-transform duration-300">
                </div>
                <h2 class="text-base sm:text-lg font-bold text-gray-800 mb-1" data-i18n="authTitle">Войдите в свой
                    аккаунт</h2>
                <p class="text-xs text-gray-600">Добро пожаловать в ORDINA</p>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-3 sm:p-4 space-y-3">
                <button type="button" id="google-signin-btn"
                    class="group relative w-full flex justify-center items-center py-2 px-3 border border-gray-300 text-xs font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="h-3 w-3 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px"
                        height="48px">
                        <path fill="#FFC107"
                            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z">
                        </path>
                        <path fill="#FF3D00"
                            d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z">
                        </path>
                        <path fill="#4CAF50"
                            d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.521-3.108-11.28-7.481l-6.522,5.025C9.505,39.556,16.227,44,24,44z">
                        </path>
                        <path fill="#1976D2"
                            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.566,44,30.84,44,24C44,22.659,43.862,21.35,43.611,20.083z">
                        </path>
                    </svg>
                    <span data-i18n="loginWithGoogle">Войти через Google</span>
                </button>
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200"></div>
                    </div>
                    <div class="relative flex justify-center text-xs"><span
                            class="px-2 bg-white text-gray-400 font-medium">или</span></div>
                </div>
                <form id="auth-form" class="space-y-3">
                    <div class="space-y-2">
                        <div>
                            <label for="email-address"
                                class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                            <input id="email-address" name="email" type="email" autocomplete="email" required
                                class="w-full px-2.5 py-2 border border-gray-300 rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm"
                                placeholder="Введите ваш email">
                        </div>
                        <div>
                            <label for="password" class="block text-xs font-medium text-gray-700 mb-1">Пароль</label>
                            <input id="password" name="password" type="password" autocomplete="current-password"
                                required
                                class="w-full px-2.5 py-2 border border-gray-300 rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm"
                                placeholder="Введите пароль">
                        </div>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs text-center"></p>
                    <div class="space-y-2">
                        <button type="submit" id="login-btn"
                            class="w-full flex justify-center py-2 px-3 border border-transparent text-xs font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-lg hover:shadow-xl"
                            data-i18n="login">Войти</button>
                        <button type="button" id="register-btn"
                            class="w-full flex justify-center py-2 px-3 border border-gray-300 text-xs font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
                            data-i18n="register">Зарегистрироваться</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="app"
        class="max-w-7xl mx-auto p-4 sm:p-6 md:p-8 pl-20 sm:pl-28 md:pl-36 lg:pl-44 relative opacity-0 transition-opacity duration-300 hidden">
        <!-- Фиксированный большой логотип слева -->
        <div class="fixed top-4 left-4 z-30 pointer-events-none">
            <div class="logo-container relative">
                <!-- Декоративный фон -->
                <div
                    class="absolute inset-0 bg-gradient-to-br from-blue-50/30 to-purple-50/30 rounded-3xl blur-xl transform scale-110">
                </div>
                <img src="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png"
                    alt="ORDINA Logo"
                    class="relative h-32 sm:h-40 md:h-48 lg:h-56 w-auto opacity-90 hover:opacity-100 drop-shadow-2xl transition-all duration-500 pointer-events-auto hover:scale-105">
            </div>
        </div>

        <!-- Компактная панель управления -->
        <div
            class="fixed top-4 right-4 z-25 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl p-3 border border-gray-200/50">
            <div class="flex items-center gap-3">
                <!-- Валюта -->
                <div class="flex items-center border border-gray-300 rounded-lg p-1 text-xs" role="group"
                    aria-label="Выбор валюты">
                    <button id="currency-azn" class="px-2 py-1 rounded-md currency-btn-active text-xs"
                        aria-label="Переключить на азербайджанский манат" aria-pressed="true" role="button">AZN</button>
                    <button id="currency-usd" class="px-2 py-1 rounded-md text-xs"
                        aria-label="Переключить на доллары США" aria-pressed="false" role="button">USD</button>
                </div>

                <!-- Языки -->
                <div class="flex items-center space-x-1" role="group" aria-label="Выбор языка">
                    <button id="lang-ru" title="Русский"
                        class="w-6 h-6 rounded-sm bg-red-500 text-white text-xs font-bold hover:bg-red-600 transition"
                        aria-label="Переключить на русский язык" aria-pressed="true" role="button">RU</button>
                    <button id="lang-en" title="English"
                        class="w-6 h-6 rounded-sm bg-blue-500 text-white text-xs font-bold hover:bg-blue-600 transition"
                        aria-label="Switch to English" aria-pressed="false" role="button">EN</button>
                    <button id="lang-az" title="Azərbaycan"
                        class="w-6 h-6 rounded-sm bg-green-500 text-white text-xs font-bold hover:bg-green-600 transition"
                        aria-label="Azərbaycan dilinə keçin" aria-pressed="false" role="button">AZ</button>
                </div>

                <!-- Музыка: Радио / Spotify -->
                <div class="flex items-center space-x-2">
                    <!-- Переключатель Радио/Spotify -->
                    <div class="flex items-center border border-gray-300 rounded-lg p-1 text-xs" role="group"
                        aria-label="Выбор источника музыки">
                        <button id="music-radio-btn" class="px-2 py-1 rounded-md bg-blue-600 text-white text-xs"
                            aria-label="Радио" aria-pressed="true" role="button" title="AzerbaiJazz Radio">
                            📻
                        </button>
                        <button id="music-spotify-btn" class="px-2 py-1 rounded-md text-xs"
                            aria-label="Spotify" aria-pressed="false" role="button" title="Spotify">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Радио плеер -->
                    <div id="radio-controls" class="flex items-center space-x-2">
                        <audio id="radio-player" src="https://stream.zeno.fm/tjqlpbsxi4ytv"></audio>
                        <button id="radio-play-pause-btn"
                            class="w-7 h-7 flex items-center justify-center rounded-full bg-blue-600 text-white hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            title="Play/Pause" aria-label="Воспроизвести радио" aria-pressed="false"
                            role="button" tabindex="0">
                            <svg id="radio-play-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path>
                            </svg>
                            <svg id="radio-pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"></path>
                            </svg>
                        </button>
                        <input type="range" id="radio-volume-slider" min="0" max="1" step="0.01" value="1"
                            class="w-16 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                            aria-label="Громкость радио" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1"
                            aria-valuetext="100%" role="slider">
                    </div>

                    <!-- Spotify плеер (компактный) -->
                    <div id="spotify-controls" class="hidden flex items-center space-x-2">
                        <button id="spotify-compact-connect-btn"
                            class="px-3 py-1 rounded-lg bg-green-600 text-white text-xs hover:bg-green-700 transition"
                            title="Подключить Spotify">
                            Войти
                        </button>
                        <div id="spotify-compact-player" class="hidden flex items-center space-x-2">
                            <button id="spotify-compact-prev"
                                class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"></path>
                                </svg>
                            </button>
                            <button id="spotify-compact-play-pause"
                                class="w-7 h-7 flex items-center justify-center rounded-full bg-green-600 text-white hover:bg-green-700 transition">
                                <svg id="spotify-compact-play-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path>
                                </svg>
                                <svg id="spotify-compact-pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"></path>
                                </svg>
                            </button>
                            <button id="spotify-compact-next"
                                class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798l-5.445-3.63z"></path>
                                </svg>
                            </button>
                            <span id="spotify-compact-track" class="text-xs text-gray-600 max-w-32 truncate" title="">—</span>
                        </div>
                    </div>
                </div>

                <!-- Выход -->
                <button id="logout-btn"
                    class="text-xs font-medium text-gray-600 hover:text-red-600 transition px-2 py-1 rounded-lg hover:bg-red-50"
                    data-i18n="logout">Выйти</button>
            </div>
        </div>

        <header class="mb-8 pt-8">
            <div class="text-center max-w-2xl mx-auto">
                <p class="text-gray-600 text-lg sm:text-xl md:text-2xl font-medium leading-relaxed"
                    data-i18n="appSubtitle">Управляйте своими финансами с легкостью</p>
                <div class="mt-4 h-1 w-24 bg-gradient-to-r from-blue-500 to-purple-500 mx-auto rounded-full"></div>
            </div>
        </header>

        <nav class="bg-white rounded-2xl shadow-lg mb-8 sticky top-4 z-10" role="navigation"
            aria-label="Основная навигация">
            <div class="flex border-b border-gray-100 overflow-x-auto" role="tablist">
                <button data-tab="dashboard"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent tab-active whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabDashboard" role="tab" aria-selected="true" aria-controls="dashboard-page"
                    tabindex="0">Сводка</button>
                <button data-tab="debts"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabDebts" role="tab" aria-selected="false" aria-controls="debts-page"
                    tabindex="-1">Долги</button>
                <button data-tab="recurring-expenses"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabRecurringExpenses" role="tab" aria-selected="false"
                    aria-controls="recurring-expenses-page" tabindex="-1">Ежемесячные расходы</button>
                <button data-tab="expenses"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabMonthlyExpenses" role="tab" aria-selected="false" aria-controls="expenses-page"
                    tabindex="-1">Расходы месяца</button>
                <button data-tab="tasks"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabTasks" role="tab" aria-selected="false" aria-controls="tasks-page"
                    tabindex="-1">Список задач</button>
                <button data-tab="calendar"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabCalendar" role="tab" aria-selected="false" aria-controls="calendar-page"
                    tabindex="-1">Календарь</button>
                <button data-tab="payments"
                    class="tab-button px-4 sm:px-6 py-4 border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200"
                    data-i18n="tabPayments" role="tab" aria-selected="false" aria-controls="payments-page"
                    tabindex="-1">Оплата</button>
            </div>
        </nav>

        <main>
            <div id="dashboard-page" class="page-content" role="tabpanel" aria-labelledby="tab-dashboard">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-6">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800" data-i18n="dashboardTitle">Сводка за
                            месяц</h2>
                    </div>
                    <div class="w-full lg:w-auto">
                        <p id="current-datetime"
                            class="font-semibold text-lg text-gray-700 mb-2 text-center lg:text-right"></p>
                        <select id="month-selector"
                            class="bg-white border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent block w-full lg:w-48 p-3 shadow-sm hover:shadow-md transition-all duration-200"></select>
                    </div>
                </div>
                <div id="dashboard-loading" class="text-center p-8" data-i18n="loading">Загрузка данных...</div>
                <div id="dashboard-content" class="hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                        <div
                            class="stat-card bg-gradient-to-br from-green-50 to-green-100 p-8 rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-green-200 transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-green-700" data-i18n="dashRecurringPaid">
                                    Ежемесячные (оплачено)</h3>
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <p id="total-recurring-paid" class="text-4xl sm:text-5xl font-bold text-green-600">0 AZN</p>
                        </div>

                        <div
                            class="stat-card bg-gradient-to-br from-yellow-50 to-yellow-100 p-8 rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-yellow-200 transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-yellow-700" data-i18n="dashRecurringRemaining">
                                    Ежемесячные (осталось)</h3>
                                <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <p id="total-recurring-remaining" class="text-4xl sm:text-5xl font-bold text-yellow-600">0
                                AZN</p>
                        </div>

                        <div
                            class="stat-card bg-gradient-to-br from-red-50 to-red-100 p-8 rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-red-200 transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-red-700" data-i18n="dashMonthlyExpenses">Расходы
                                    за месяц</h3>
                                <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <p id="total-monthly-outflow" class="text-4xl sm:text-5xl font-bold text-red-600">0 AZN</p>
                        </div>

                        <div
                            class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 p-8 rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-purple-200 transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-purple-700" data-i18n="dashTotalDebt">Остаток
                                    общего долга</h3>
                                <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z">
                                        </path>
                                    </svg>
                                </div>
                            </div>
                            <p id="total-debt-remaining" class="text-4xl font-bold text-orange-600">0 AZN</p>
                        </div>

                        <div
                            class="stat-card bg-gradient-to-br from-indigo-50 to-indigo-100 p-8 rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-indigo-200 transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-indigo-700" data-i18n="dashTasksMonth">Осталось
                                    задач (месяц)</h3>
                                <div class="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <p id="tasks-remaining-month" class="text-4xl font-bold text-indigo-600">0</p>
                        </div>

                        <div
                            class="stat-card bg-gradient-to-br from-pink-50 to-pink-100 p-8 rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-pink-200 transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-pink-700" data-i18n="dashTasksYear">Осталось задач
                                    (год)</h3>
                                <div class="w-12 h-12 bg-pink-500 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <p id="tasks-remaining-year" class="text-4xl font-bold text-pink-600">0</p>
                        </div>
                    </div>

                    <!-- Виджеты погоды и Spotify -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Виджет погоды -->
                        <div id="weather-widget"
                            class="bg-gradient-to-br from-blue-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    <span data-i18n="weatherTitle">Погода</span>
                                </h3>
                                <button id="refresh-weather-btn"
                                    class="p-2 rounded-lg hover:bg-white/20 transition-colors" title="Обновить погоду">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>

                            <div id="weather-loading" class="text-center py-8">
                                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <p class="mt-3 text-white/80" data-i18n="weatherLoading">Загрузка погоды...</p>
                            </div>

                            <div id="weather-error" class="hidden text-center py-8">
                                <svg class="w-12 h-12 text-white/80 mx-auto mb-3" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="text-white/80 mb-2" data-i18n="weatherError">Не удалось загрузить погоду</p>
                                <p class="text-sm text-white/60" data-i18n="weatherErrorHint">Разрешите доступ к
                                    геолокации</p>
                            </div>

                            <div id="weather-content" class="hidden">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p id="weather-city" class="text-2xl font-bold mb-1">—</p>
                                        <p id="weather-description" class="text-lg text-white/90 capitalize">—</p>
                                    </div>
                                    <div class="text-right">
                                        <p id="weather-temp" class="text-5xl font-bold">—°</p>
                                        <p id="weather-feels-like" class="text-sm text-white/80">Ощущается: —°</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-4 mt-6 pt-4 border-t border-white/20">
                                    <div class="text-center">
                                        <svg class="w-6 h-6 mx-auto mb-1 text-white/80" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M5.5 2a.5.5 0 000 1h9a.5.5 0 000-1h-9zM3 5.5A1.5 1.5 0 014.5 4h11A1.5 1.5 0 0117 5.5v9a1.5 1.5 0 01-1.5 1.5h-11A1.5 1.5 0 013 14.5v-9z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <p id="weather-humidity" class="text-sm text-white/80">—%</p>
                                        <p class="text-xs text-white/60" data-i18n="weatherHumidity">Влажность</p>
                                    </div>
                                    <div class="text-center">
                                        <svg class="w-6 h-6 mx-auto mb-1 text-white/80" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <p id="weather-wind" class="text-sm text-white/80">— м/с</p>
                                        <p class="text-xs text-white/60" data-i18n="weatherWind">Ветер</p>
                                    </div>
                                    <div class="text-center">
                                        <svg class="w-6 h-6 mx-auto mb-1 text-white/80" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <p id="weather-pressure" class="text-sm text-white/80">— мм</p>
                                        <p class="text-xs text-white/60" data-i18n="weatherPressure">Давление</p>
                                    </div>
                                </div>
                            </div>
                        </div>



                    <!-- Виджет новостей -->
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-8 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
                                <svg class="w-7 h-7 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z"
                                        clip-rule="evenodd"></path>
                                    <path d="M15 7h1a2 2 0 012 2v5.5a1.5 1.5 0 01-3 0V7z"></path>
                                </svg>
                                <span data-i18n="newsTitle">Новости</span>
                            </h3>
                            <button id="refresh-news-btn"
                                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                title="Обновить новости">
                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <div id="news-loading" class="text-center py-8">
                            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p class="mt-3 text-gray-600 dark:text-gray-400" data-i18n="newsLoading">Загрузка
                                новостей...</p>
                        </div>

                        <div id="news-error" class="hidden text-center py-8">
                            <svg class="w-12 h-12 text-red-500 mx-auto mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-gray-600 dark:text-gray-400" data-i18n="newsError">Не удалось загрузить
                                новости</p>
                        </div>

                        <div id="news-content" class="hidden space-y-4">
                            <!-- Новости будут добавлены динамически -->
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold mb-4" data-i18n="dashTopCategories">Топ категорий расходов</h3>
                        <div class="max-h-96"><canvas id="expenses-chart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="debts-page" class="page-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold" data-i18n="debtsTitle">Общие долги</h2><button id="add-debt-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                        data-i18n="addDebt">Добавить долг</button>
                </div>
                <div id="debts-table-wrapper"
                    class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                    <table class="w-full text-sm text-left responsive-table">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-3" data-i18n="debtName">Долг (Имя)</th>
                                <th class="px-6 py-3" data-i18n="amount">Сумма</th>
                                <th class="px-6 py-3" data-i18n="paid">Оплачено</th>
                                <th class="px-6 py-3" data-i18n="remaining">Осталось</th>
                                <th class="px-6 py-3" data-i18n="lastPaymentDate">Дата последней оплаты</th>
                                <th class="px-6 py-3" data-i18n="comments">Комментарии</th>
                                <th class="px-6 py-3" data-i18n="actions">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="debts-table"></tbody>
                    </table>
                </div>
                <div id="debts-empty" class="hidden"></div>
            </div>

            <div id="recurring-expenses-page" class="page-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold"><span data-i18n="recurringTitle">Ежемесячные расходы</span>
                        (<span id="recurring-month-name"></span>)</h2><button id="add-recurring-expense-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                        data-i18n="addTemplate">Добавить шаблон</button>
                </div>
                <div id="recurring-expenses-table-wrapper"
                    class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                    <table class="w-full text-sm text-left responsive-table">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-3" data-i18n="name">Наименование</th>
                                <th class="px-6 py-3" data-i18n="amount">Сумма</th>
                                <th class="px-6 py-3" data-i18n="paymentDay">День оплаты</th>
                                <th class="px-6 py-3" data-i18n="status">Статус оплаты</th>
                                <th class="px-6 py-3" data-i18n="details">Детали</th>
                                <th class="px-6 py-3" data-i18n="templateActions">Действия с шаблоном</th>
                            </tr>
                        </thead>
                        <tbody id="recurring-expenses-table"></tbody>
                    </table>
                </div>
                <div id="recurring-expenses-empty" class="hidden"></div>
            </div>

            <div id="expenses-page" class="page-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold"><span data-i18n="expensesTitle">Все расходы за</span> <span
                            class="current-month-name"></span></h2>
                    <div class="flex space-x-2"><button id="manage-categories-btn"
                            class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                            data-i18n="manageCategories">Управление категориями</button><button id="add-expense-btn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                            data-i18n="addExpense">Добавить расход</button></div>
                </div>
                <div id="expenses-table-wrapper"
                    class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                    <table class="w-full text-sm text-left responsive-table">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-3" data-i18n="name">Наименование</th>
                                <th class="px-6 py-3" data-i18n="category">Категория</th>
                                <th class="px-6 py-3" data-i18n="amount">Сумма</th>
                                <th class="px-6 py-3" data-i18n="date">Дата</th>
                                <th class="px-6 py-3" data-i18n="actions">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table"></tbody>
                    </table>
                </div>
                <div id="expenses-empty" class="hidden"></div>
            </div>

            <div id="tasks-page" class="page-content hidden">
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex -mb-px" aria-label="Tabs"><button class="task-tab-button task-tab-active"
                            data-task-tab="today"><span data-i18n="taskToday">На сегодня</span> (<span
                                id="today-date"></span>)</button><button class="task-tab-button"
                            data-task-tab="month"><span data-i18n="taskMonth">На месяц</span></button><button
                            class="task-tab-button" data-task-tab="year"><span data-i18n="taskYear">На
                                год</span></button></nav>
                </div>
                <div id="task-tab-today" class="task-tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" data-i18n="taskTodayTitle">Задачи на сегодня</h3><button
                            id="add-daily-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"
                            data-i18n="addTask">Добавить задачу</button>
                    </div>
                    <div id="daily-tasks-table-wrapper"
                        class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                        <table class="w-full text-sm text-left responsive-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="w-1/3 px-6 py-3" data-i18n="name">Имя</th>
                                    <th class="px-6 py-3" data-i18n="status">Статус</th>
                                    <th class="w-1/3 px-6 py-3" data-i18n="notes">Заметки</th>
                                    <th class="px-6 py-3" data-i18n="actions">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="daily-tasks-table"></tbody>
                        </table>
                    </div>
                    <div id="daily-tasks-empty" class="hidden"></div>
                </div>
                <div id="task-tab-month" class="task-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" data-i18n="taskMonthTitle">Задачи на месяц</h3><button
                            id="add-monthly-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"
                            data-i18n="addTask">Добавить задачу</button>
                    </div>
                    <div id="monthly-tasks-table-wrapper"
                        class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                        <table class="w-full text-sm text-left responsive-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="px-6 py-3" data-i18n="name">Имя</th>
                                    <th class="px-6 py-3" data-i18n="deadline">Дедлайн</th>
                                    <th class="px-6 py-3" data-i18n="status">Статус</th>
                                    <th class="px-6 py-3" data-i18n="actions">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-tasks-table"></tbody>
                        </table>
                    </div>
                    <div id="monthly-tasks-empty" class="hidden"></div>
                </div>
                <div id="task-tab-year" class="task-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" data-i18n="taskYearTitle">Задачи на год</h3><button
                            id="add-yearly-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"
                            data-i18n="addTask">Добавить задачу</button>
                    </div>
                    <div id="yearly-tasks-table-wrapper"
                        class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                        <table class="w-full text-sm text-left responsive-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="w-1/3 px-6 py-3" data-i18n="name">Имя</th>
                                    <th class="px-6 py-3" data-i18n="deadline">Дедлайн</th>
                                    <th class="px-6 py-3" data-i18n="status">Статус</th>
                                    <th class="w-1/3 px-6 py-3" data-i18n="notes">Заметки</th>
                                    <th class="px-6 py-3" data-i18n="actions">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="yearly-tasks-table"></tbody>
                        </table>
                    </div>
                    <div id="yearly-tasks-empty" class="hidden"></div>
                </div>
            </div>

            <div id="calendar-page" class="page-content hidden">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex justify-between items-center mb-4"><button id="prev-month-btn"
                            class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                        <h2 id="calendar-month-year" class="text-xl font-semibold"></h2><button id="next-month-btn"
                            class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                    </div>
                    <div id="calendar-weekdays"
                        class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600 text-sm mb-2"></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>

            <div id="payments-page" class="page-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                    <svg class="w-24 h-24 mx-auto text-blue-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="paymentsTitle">Платежи</h2>
                    <p class="text-gray-600 mb-6" data-i18n="paymentsDescription">Функция платежей будет доступна в следующей версии</p>
                    <button onclick="switchTab('dashboard')" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">
                        <span data-i18n="backToDashboard">Вернуться на главную</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Модальные окна -->
    <dialog id="debt-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="debt-modal-title" class="text-xl font-semibold mb-4" data-i18n="addDebt"></h3>
            <form id="debt-form" data-original-paid="0"><input type="hidden" id="debt-id">
                <div class="mb-4"><label for="debt-name" class="block mb-2 text-sm font-medium"
                        data-i18n="debtorName">Имя должника/Название</label><input type="text" id="debt-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="debt-total" class="block mb-2 text-sm font-medium"><span
                            data-i18n="totalAmount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="debt-total" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="debt-paid" class="block mb-2 text-sm font-medium"><span
                            data-i18n="paidAmount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="debt-paid" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required value="0"></div>
                <div class="mb-4"><label for="debt-comment" class="block mb-2 text-sm font-medium"
                        data-i18n="comment">Комментарий</label><textarea id="debt-comment" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="debt-payment-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 class="text-xl font-semibold mb-4" data-i18n="addDebtPayment">Добавить платеж по долгу</h3>
            <form id="debt-payment-form"><input type="hidden" id="debt-payment-id">
                <div class="mb-4"><label for="debt-payment-amount" class="block mb-2 text-sm font-medium"><span
                            data-i18n="paymentAmount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="debt-payment-amount" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="add">Добавить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="recurring-expense-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="recurring-expense-modal-title" class="text-xl font-semibold mb-4" data-i18n="addTemplate"></h3>
            <form id="recurring-expense-form"><input type="hidden" id="recurring-expense-id">
                <div class="mb-4"><label for="recurring-expense-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Наименование</label><input type="text" id="recurring-expense-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="recurring-expense-amount" class="block mb-2 text-sm font-medium"><span
                            data-i18n="amount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="recurring-expense-amount" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="recurring-expense-due-day" class="block mb-2 text-sm font-medium"
                        data-i18n="paymentDayNum">День оплаты (1-31)</label><input type="number"
                        id="recurring-expense-due-day" min="1" max="31"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="recurring-expense-details" class="block mb-2 text-sm font-medium"
                        data-i18n="details">Детали</label><textarea id="recurring-expense-details" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="expense-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="expense-modal-title" class="text-xl font-semibold mb-4" data-i18n="addExpense"></h3>
            <form id="expense-form"><input type="hidden" id="expense-id">
                <div class="mb-4"><label for="expense-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Наименование</label><input type="text" id="expense-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="expense-category" class="block mb-2 text-sm font-medium"
                        data-i18n="category">Категория</label><input type="text" id="expense-category"
                        list="expense-categories-list" class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"
                        required><datalist id="expense-categories-list"></datalist></div>
                <div class="mb-4"><label for="expense-amount" class="block mb-2 text-sm font-medium"><span
                            data-i18n="amount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="expense-amount" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="expense-date" class="block mb-2 text-sm font-medium"
                        data-i18n="date">Дата</label><input type="date" id="expense-date"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="daily-task-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="daily-task-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="daily-task-form"><input type="hidden" id="daily-task-id">
                <div class="mb-4"><label for="daily-task-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Имя</label><input type="text" id="daily-task-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="daily-task-notes" class="block mb-2 text-sm font-medium"
                        data-i18n="notes">Заметки</label><textarea id="daily-task-notes" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="monthly-task-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="monthly-task-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="monthly-task-form"><input type="hidden" id="monthly-task-id">
                <div class="mb-4"><label for="monthly-task-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Имя</label><input type="text" id="monthly-task-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="monthly-task-deadline" class="block mb-2 text-sm font-medium"
                        data-i18n="deadline">Дедлайн</label><input type="date" id="monthly-task-deadline"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="yearly-task-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="yearly-task-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="yearly-task-form"><input type="hidden" id="yearly-task-id">
                <div class="mb-4"><label for="yearly-task-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Имя</label><input type="text" id="yearly-task-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="yearly-task-deadline" class="block mb-2 text-sm font-medium"
                        data-i18n="deadline">Дедлайн</label><input type="date" id="yearly-task-deadline"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="yearly-task-notes" class="block mb-2 text-sm font-medium"
                        data-i18n="notes">Заметки</label><textarea id="yearly-task-notes" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="event-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="event-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="event-form"><input type="hidden" id="event-id">
                <div class="mb-4"><label for="event-category" class="block mb-2 text-sm font-medium"
                        data-i18n="category">Категория</label><select id="event-category"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="event" data-i18n="categoryEvent">Событие</option>
                        <option value="birthday" data-i18n="categoryBirthday">День рождения</option>
                        <option value="meeting" data-i18n="categoryMeeting">Встреча</option>
                        <option value="wedding" data-i18n="categoryWedding">Свадьба</option>
                    </select></div>
                <div id="event-fields-event" class="event-category-fields">
                    <div class="mb-4"><label for="event-name-generic" class="block mb-2 text-sm font-medium"
                            data-i18n="eventName">Название события</label><input type="text" id="event-name-generic"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                </div>
                <div id="event-fields-birthday" class="event-category-fields hidden">
                    <div class="mb-4"><label for="event-birthday-name" class="block mb-2 text-sm font-medium"
                            data-i18n="birthdayName">Имя именинника</label><input type="text" id="event-birthday-name"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                    <div class="mb-4"><label for="event-birthday-year" class="block mb-2 text-sm font-medium"
                            data-i18n="birthYear">Год рождения (опционально)</label><input type="number"
                            id="event-birthday-year" placeholder="1990"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                </div>
                <div id="event-fields-meeting" class="event-category-fields hidden">
                    <div class="mb-4"><label for="event-meeting-with" class="block mb-2 text-sm font-medium"
                            data-i18n="meetingWith">С кем</label><input type="text" id="event-meeting-with"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="event-meeting-time" class="block mb-2 text-sm font-medium"
                                data-i18n="time">Время (опц.)</label><input type="time" id="event-meeting-time"
                                class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                        <div><label for="event-meeting-place" class="block mb-2 text-sm font-medium"
                                data-i18n="place">Место (опц.)</label><input type="text" id="event-meeting-place"
                                class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                    </div>
                </div>
                <div id="event-fields-wedding" class="event-category-fields hidden">
                    <div class="mb-4"><label for="event-wedding-names" class="block mb-2 text-sm font-medium"
                            data-i18n="weddingNames">Имена пары</label><input type="text" id="event-wedding-names"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                </div>
                <div class="mb-4"><label for="event-date" class="block mb-2 text-sm font-medium"
                        data-i18n="date">Дата</label><input type="date" id="event-date"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex items-center mb-4"><input id="event-create-task" type="checkbox" checked
                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><label
                        for="event-create-task" class="ml-2 text-sm font-medium text-gray-900"
                        data-i18n="createTaskForEvent">Создать задачу для этого события</label></div>
                <div class="flex justify-between items-center mt-6"><button type="button" id="delete-event-btn"
                        class="text-red-600 hover:text-red-800 hidden" data-i18n="delete">Удалить</button>
                    <div class="flex justify-end gap-4"><button type="button"
                            class="cancel-btn text-gray-600 hover:text-gray-900"
                            data-i18n="cancel">Отмена</button><button type="submit"
                            class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                            data-i18n="save">Сохранить</button></div>
                </div>
            </form>
        </div>
    </dialog>
    <dialog id="category-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 class="text-xl font-semibold mb-4" data-i18n="manageCategoriesTitle">Управление категориями</h3>
            <form id="category-form" class="mb-4">
                <div class="flex gap-2"><input type="text" id="category-name" placeholder="Новая категория"
                        class="flex-grow bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="add">Добавить</button></div>
            </form>
            <div id="category-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-end mt-6"><button type="button"
                    class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="close">Закрыть</button></div>
        </div>
    </dialog>

    <!-- Custom Confirm Modal -->
    <dialog id="confirm-modal" class="p-0 rounded-lg shadow-xl w-full max-w-sm">
        <div class="p-6 text-center">
            <svg class="mx-auto mb-4 text-gray-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 20 20">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <p id="confirm-modal-text" class="mb-5 text-lg font-normal text-gray-600"></p>
            <button id="confirm-modal-yes" type="button"
                class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center me-2">
                Да, удалить
            </button>
            <button id="confirm-modal-no" type="button"
                class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                Нет, отмена
            </button>
        </div>
    </dialog>

    <!-- Toast Container -->
    <div id="toast-container"></div>


    <script type="module" defer>
        // Встроенные модули для работы без сервера

        // Utils класс
        class Utils {
            static safeGetElement(elementId) {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`Element with id '${elementId}' not found`);
                }
                return element;
            }

            static safeAddEventListener(elementId, event, handler) {
                const element = this.safeGetElement(elementId);
                if (element && !element.dataset.listenerAdded) {
                    element.addEventListener(event, handler);
                    element.dataset.listenerAdded = 'true';
                }
            }

            static safeQuerySelector(selector, context = document) {
                const element = context.querySelector(selector);
                if (!element) {
                    console.warn(`Element with selector '${selector}' not found`);
                }
                return element;
            }

            static getTodayISOString() {
                const today = new Date();
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Baku' };
                return new Intl.DateTimeFormat('en-CA', options).format(today);
            }

            static formatISODateForDisplay(isoString, options = {}) {
                const [year, month, day] = isoString.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const defaultOptions = { day: 'numeric', month: 'long' };
                if (options.year) defaultOptions.year = 'numeric';
                return date.toLocaleDateString(window.currentLang === 'ru' ? 'ru-RU' : 'en-US', { ...defaultOptions, ...options });
            }

            static formatCurrency(amount, currency = 'AZN', exchangeRate = 1.7) {
                if (typeof amount !== 'number') amount = 0;
                const value = currency === 'USD' ? amount / exchangeRate : amount;
                const symbol = currency === 'USD' ? '$' : 'AZN';
                return `${value.toFixed(2)} ${symbol}`;
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }

            static isMobile() {
                return window.innerWidth <= 768;
            }

            // Lazy loading для изображений
            static lazyLoadImages() {
                const images = document.querySelectorAll('img[data-src]');
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            observer.unobserve(img);
                        }
                    });
                });

                images.forEach(img => imageObserver.observe(img));
            }

            // Pagination helper
            static paginate(array, page = 1, perPage = 25) {
                const start = (page - 1) * perPage;
                const end = start + perPage;
                return {
                    data: array.slice(start, end),
                    currentPage: page,
                    totalPages: Math.ceil(array.length / perPage),
                    totalItems: array.length,
                    hasNext: end < array.length,
                    hasPrev: page > 1
                };
            }

            // Группировка данных по дате
            static groupByDate(items, dateField = 'date') {
                return items.reduce((groups, item) => {
                    const date = item[dateField] || item.data?.()?.[dateField];
                    if (!date) return groups;
                    
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(item);
                    return groups;
                }, {});
            }

            // Сортировка с кэшированием
            static sortWithCache(array, sortFn, cacheKey) {
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) {
                    try {
                        return JSON.parse(cached);
                    } catch (e) {
                        console.warn('Cache parse error:', e);
                    }
                }
                
                const sorted = [...array].sort(sortFn);
                try {
                    sessionStorage.setItem(cacheKey, JSON.stringify(sorted));
                } catch (e) {
                    console.warn('Cache save error:', e);
                }
                return sorted;
            }
        }



        // KeyboardNavigation класс
        class KeyboardNavigation {
            constructor() {
                this.focusableElements = [
                    'button:not([disabled])',
                    'input:not([disabled])',
                    'select:not([disabled])',
                    'textarea:not([disabled])',
                    'a[href]',
                    '[tabindex]:not([tabindex="-1"])'
                ].join(', ');

                this.currentModal = null;
                this.previousFocus = null;

                this.init();
            }

            init() {
                this.setupGlobalKeyboardHandlers();
                this.setupTabNavigation();
            }

            setupGlobalKeyboardHandlers() {
                document.addEventListener('keydown', (e) => {
                    switch (e.key) {
                        case 'Escape':
                            this.handleEscape(e);
                            break;
                        case 'Tab':
                            this.handleTab(e);
                            break;
                        case 'Enter':
                        case ' ':
                            this.handleActivation(e);
                            break;
                        case 'ArrowLeft':
                        case 'ArrowRight':
                            this.handleArrowNavigation(e);
                            break;
                        case 'Home':
                        case 'End':
                            this.handleHomeEnd(e);
                            break;
                    }
                });
            }

            handleEscape(e) {
                if (this.currentModal) {
                    e.preventDefault();
                    this.closeModal(this.currentModal);
                }
            }

            handleTab(e) {
                if (this.currentModal) {
                    this.trapFocus(e, this.currentModal);
                }
            }

            handleActivation(e) {
                const target = e.target;

                if (target.getAttribute('role') === 'button' && target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    target.click();
                }

                if (target.getAttribute('role') === 'tab') {
                    e.preventDefault();
                    target.click();
                }
            }

            handleArrowNavigation(e) {
                const target = e.target;

                if (target.getAttribute('role') === 'tab') {
                    e.preventDefault();
                    this.navigateTabs(target, e.key === 'ArrowRight' ? 1 : -1);
                }
            }

            handleHomeEnd(e) {
                const target = e.target;

                if (target.getAttribute('role') === 'tab') {
                    e.preventDefault();
                    const tablist = target.closest('[role="tablist"]');
                    const tabs = tablist.querySelectorAll('[role="tab"]');
                    const targetTab = e.key === 'Home' ? tabs[0] : tabs[tabs.length - 1];
                    this.focusTab(targetTab);
                }
            }

            navigateTabs(currentTab, direction) {
                const tablist = currentTab.closest('[role="tablist"]');
                const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                const currentIndex = tabs.indexOf(currentTab);

                let nextIndex = currentIndex + direction;
                if (nextIndex < 0) nextIndex = tabs.length - 1;
                if (nextIndex >= tabs.length) nextIndex = 0;

                this.focusTab(tabs[nextIndex]);
            }

            focusTab(tab) {
                const tablist = tab.closest('[role="tablist"]');
                tablist.querySelectorAll('[role="tab"]').forEach(t => {
                    t.setAttribute('tabindex', '-1');
                });

                tab.setAttribute('tabindex', '0');
                tab.focus();
            }

            setupTabNavigation() {
                const tablist = document.querySelector('[role="tablist"]');
                if (tablist) {
                    const tabs = tablist.querySelectorAll('[role="tab"]');
                    tabs.forEach((tab, index) => {
                        tab.setAttribute('tabindex', index === 0 ? '0' : '-1');
                    });
                }
            }

            closeModal(modal) {
                if (modal && modal.close) {
                    modal.close();
                }

                this.currentModal = null;

                if (this.previousFocus) {
                    this.previousFocus.focus();
                    this.previousFocus = null;
                }
            }

            trapFocus(e, modal) {
                const focusableElements = modal.querySelectorAll(this.focusableElements);
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }

            announceToScreenReader(message, assertive = false) {
                const liveRegion = document.getElementById(assertive ? 'assertive-live-region' : 'live-region');
                if (liveRegion) {
                    liveRegion.textContent = message;
                    setTimeout(() => {
                        liveRegion.textContent = '';
                    }, 1000);
                }
            }

            initAccessibility() {
                this.setupLiveRegions();
                this.setupSkipLinks();
            }

            setupLiveRegions() {
                const liveRegion = document.createElement('div');
                liveRegion.setAttribute('aria-live', 'polite');
                liveRegion.setAttribute('aria-atomic', 'true');
                liveRegion.className = 'sr-only';
                liveRegion.id = 'live-region';
                document.body.appendChild(liveRegion);

                const assertiveLiveRegion = document.createElement('div');
                assertiveLiveRegion.setAttribute('aria-live', 'assertive');
                assertiveLiveRegion.setAttribute('aria-atomic', 'true');
                assertiveLiveRegion.className = 'sr-only';
                assertiveLiveRegion.id = 'assertive-live-region';
                document.body.appendChild(assertiveLiveRegion);
            }

            setupSkipLinks() {
                const skipLink = document.createElement('a');
                skipLink.href = '#main-content';
                skipLink.textContent = 'Перейти к основному содержимому';
                skipLink.className = 'skip-link';
                skipLink.style.cssText = `
                    position: absolute;
                    top: -40px;
                    left: 6px;
                    background: #3b82f6;
                    color: white;
                    padding: 8px 16px;
                    text-decoration: none;
                    border-radius: 4px;
                    z-index: 1000;
                    font-weight: 600;
                `;

                skipLink.addEventListener('focus', () => {
                    skipLink.style.top = '6px';
                });

                skipLink.addEventListener('blur', () => {
                    skipLink.style.top = '-40px';
                });

                document.body.insertBefore(skipLink, document.body.firstChild);

                const main = document.querySelector('main');
                if (main && !main.id) {
                    main.id = 'main-content';
                }
            }
        }

        // Импорт Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot,
            collection, query, where, Timestamp, writeBatch, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDi0cFirxRJ9eC6mvy1WEDpB9MPzDDac3g",
            authDomain: "life-order-assistant.firebaseapp.com",
            projectId: "life-order-assistant",
            storageBucket: "life-order-assistant.appspot.com",
            messagingSenderId: "284691407205",
            appId: "1:284691407205:web:a6e935c498b280ce55c18c",
            measurementId: "G-E1MWRNNKDM"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app').innerHTML = `<div class="p-4 text-center text-red-500">
                <h1 class="text-2xl font-bold">Ошибка конфигурации Firebase</h1>
                <p>Пожалуйста, убедитесь, что вы правильно вставили ваш <b>firebaseConfig</b> в HTML-файл.</p>
            </div>`;
        }

        let userId = null;
        let currentMonthId;
        let selectedMonthId;

        let currentCurrency = localStorage.getItem('currency') || 'AZN';
        const exchangeRate = 1.70;

        let allDebts = [], allExpenses = [], allRecurringTemplates = [], currentMonthStatuses = {};
        let dailyTasks = [], monthlyTasks = [], yearlyTasks = [];
        let calendarEvents = [];
        let calendarDate = new Date();

        let debtsCol, recurringExpensesCol, expensesCol, monthlyDataCol, recurringExpenseStatusesCol;
        let dailyTasksCol, monthlyTasksCol, yearlyTasksCol, calendarEventsCol, categoriesCol;

        let unsubscribes = [];
        let expensesChart = null;
        let dateTimeInterval = null;

        const translations = {
            ru: {
                appTitle: "ORDINA", appSubtitle: "Управляйте своими финансами с легкостью.",
                tabDashboard: "Сводка", tabDebts: "Долги", tabRecurringExpenses: "Ежемесячные расходы", tabMonthlyExpenses: "Расходы месяца", tabTasks: "Список задач", tabCalendar: "Календарь",
                dashboardTitle: "Сводка за месяц", loading: "Загрузка данных...",
                dashRecurringPaid: "Ежемесячные (оплачено)", dashRecurringRemaining: "Ежемесячные (осталось)", dashMonthlyExpenses: "Расходы за месяц", dashTotalDebt: "Остаток общего долга", dashTopCategories: "Топ категорий расходов",
                debtsTitle: "Общие долги", addDebt: "Добавить долг", debtName: "Долг (Имя)", amount: "Сумма", paid: "Оплачено", remaining: "Осталось", lastPaymentDate: "Дата последней оплаты", comments: "Комментарии", actions: "Действия", emptyDebts: "Список долгов пуст. Нажмите кнопку 'Добавить долг', чтобы начать.",
                recurringTitle: "Ежемесячные расходы", addTemplate: "Добавить шаблон", paymentDay: "День оплаты", status: "Статус", details: "Детали", templateActions: "Действия с шаблоном", emptyRecurring: "Список ежемесячных расходов пуст. Создайте шаблон.",
                expensesTitle: "Все расходы за", addExpense: "Добавить расход", category: "Категория", date: "Дата", emptyExpenses: "Расходов в этом месяце еще нет.",
                taskToday: "На сегодня", taskMonth: "На месяц", taskYear: "На год", taskTodayTitle: "Задачи на сегодня", taskMonthTitle: "Задачи на месяц", taskYearTitle: "Задачи на год", addTask: "Добавить задачу", name: "Имя", notes: "Заметки", deadline: "Дедлайн", emptyTasks: "Список задач пуст.",
                cancel: "Отмена", save: "Сохранить", add: "Добавить", delete: "Удалить", close: "Закрыть",
                debtorName: "Имя должника/Название", totalAmount: "Общая сумма", paidAmount: "Оплаченная сумма", comment: "Комментарий",
                addDebtPayment: "Добавить платеж по долгу", paymentAmount: "Сумма платежа", paymentDayNum: "День оплаты (1-31)",
                deleteConfirm: "Вы уверены, что хотите удалить это?",
                paidStatus: "Оплачено", unpaidStatus: "Не оплачено",
                statusDone: "Выполнено", statusNotDone: "Не выполнено", statusSkipped: "Пропущено",
                editDebt: "Редактировать долг", editTemplate: "Редактировать шаблон", editExpense: "Редактировать расход", editTask: "Редактировать задачу",
                addTaskForToday: "Добавить задачу на сегодня", addTaskForMonth: "Добавить задачу на месяц", addTaskForYear: "Добавить задачу на год",
                chartLabel: "Расходы",
                dashTasksMonth: "Осталось задач (месяц)", dashTasksYear: "Осталось задач (год)",
                debtRepayments: "Погашение долгов", recurringPayments: "Ежемесячные платежи",
                placeholderComment: "Добавить комментарий...",
                addEvent: "Добавить событие", editEvent: "Редактировать событие", eventName: "Название события", createTaskForEvent: "Создать задачу для этого события",
                weekdays: ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"],
                categoryEvent: "Событие", categoryBirthday: "День рождения", categoryMeeting: "Встреча", categoryWedding: "Свадьба",
                birthdayName: "Имя именинника", birthYear: "Год рождения (опционально)", meetingWith: "С кем", time: "Время (опц.)", place: "Место (опц.)", weddingNames: "Имена пары",
                taskCongratulate: "Поздравить", taskTurning: "исполняется", taskYearsOld: "лет", taskMeetWith: "Встретиться с", taskWeddingOf: "Свадьба",
                authTitle: "Войдите в свой аккаунт", login: "Войти", register: "Зарегистрироваться", logout: "Выйти", loginWithGoogle: "Войти через Google",
                authInvalidEmail: "Неверный формат email адреса.",
                authEmailInUse: "Этот email уже зарегистрирован.",
                authWeakPassword: "Пароль слишком слабый. Он должен содержать не менее 6 символов.",
                authInvalidCredentials: "Неверный email или пароль.",
                authGenericError: "Произошла ошибка. Попробуйте снова.",
                manageCategories: "Управление категориями", manageCategoriesTitle: "Управление категориями",
                toastSuccess: "Успешно сохранено!", toastError: "Ошибка сохранения!", toastDeleted: "Запись удалена.",
                radioTitle: "AzerbaiJazz Radio",
                tabPayments: "Ödənişlər",
                paymentsTitle: "Платежи",
                paymentsDescription: "Функция платежей будет доступна в следующей версии",
                backToDashboard: "Вернуться на главную",
            },
            en: {
                appTitle: "ORDINA", appSubtitle: "Manage your finances with ease.",
                tabDashboard: "Dashboard", tabDebts: "Debts", tabRecurringExpenses: "Recurring Expenses", tabMonthlyExpenses: "Monthly Expenses", tabTasks: "Task List", tabCalendar: "Calendar",
                dashboardTitle: "Monthly Dashboard", loading: "Loading data...",
                dashRecurringPaid: "Recurring (Paid)", dashRecurringRemaining: "Recurring (Remaining)", dashMonthlyExpenses: "Monthly Expenses", dashTotalDebt: "Total Debt Remaining", dashTopCategories: "Top Expense Categories",
                debtsTitle: "All Debts", addDebt: "Add Debt", debtName: "Debt (Name)", amount: "Amount", paid: "Paid", remaining: "Remaining", lastPaymentDate: "Last Payment Date", comments: "Comments", actions: "Actions", emptyDebts: "Debt list is empty. Click 'Add Debt' to start.",
                recurringTitle: "Recurring Expenses", addTemplate: "Add Template", paymentDay: "Payment Day", status: "Status", details: "Details", templateActions: "Template Actions", emptyRecurring: "Recurring expense list is empty. Create a template.",
                expensesTitle: "All Expenses for", addExpense: "Add Expense", category: "Category", date: "Date", emptyExpenses: "No expenses for this month yet.",
                taskToday: "Today", taskMonth: "Month", taskYear: "Year", taskTodayTitle: "Today's Tasks", taskMonthTitle: "Monthly Tasks", taskYearTitle: "Yearly Tasks", addTask: "Add Task", name: "Name", notes: "Notes", deadline: "Deadline", emptyTasks: "Task list is empty.",
                cancel: "Cancel", save: "Save", add: "Add", delete: "Delete", close: "Close",
                debtorName: "Debtor Name/Title", totalAmount: "Total Amount", paidAmount: "Paid Amount", comment: "Comment",
                addDebtPayment: "Add Debt Payment", paymentAmount: "Payment Amount", paymentDayNum: "Payment Day (1-31)",
                deleteConfirm: "Are you sure you want to delete this?",
                paidStatus: "Paid", unpaidStatus: "Unpaid",
                statusDone: "Done", statusNotDone: "Not Done", statusSkipped: "Skipped",
                editDebt: "Edit Debt", editTemplate: "Edit Template", editExpense: "Edit Expense", editTask: "Edit Task",
                addTaskForToday: "Add Task for Today", addTaskForMonth: "Add Task for Month", addTaskForYear: "Add Task for Year",
                chartLabel: "Expenses",
                dashTasksMonth: "Tasks Remaining (Month)", dashTasksYear: "Tasks Remaining (Year)",
                debtRepayments: "Debt Repayments", recurringPayments: "Recurring Payments",
                placeholderComment: "Add a comment...",
                addEvent: "Add Event", editEvent: "Edit Event", eventName: "Event Name", createTaskForEvent: "Create a task for this event",
                weekdays: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                categoryEvent: "Event", categoryBirthday: "Birthday", categoryMeeting: "Meeting", categoryWedding: "Wedding",
                birthdayName: "Birthday person's name", birthYear: "Year of birth (optional)", meetingWith: "With whom", time: "Time (opt.)", place: "Place (opt.)", weddingNames: "Couple's names",
                taskCongratulate: "Congratulate", taskTurning: "turning", taskYearsOld: "years old", taskMeetWith: "Meet with", taskWeddingOf: "Wedding of",
                authTitle: "Sign in to your account", login: "Sign in", register: "Register", logout: "Log out", loginWithGoogle: "Sign in with Google",
                authInvalidEmail: "Invalid email format.",
                authEmailInUse: "This email is already in use.",
                authWeakPassword: "Password is too weak. It should be at least 6 characters.",
                authInvalidCredentials: "Invalid email or password.",
                authGenericError: "An error occurred. Please try again.",
                manageCategories: "Manage Categories", manageCategoriesTitle: "Manage Categories",
                toastSuccess: "Saved successfully!", toastError: "Error saving!", toastDeleted: "Entry deleted.",
                radioTitle: "AzerbaiJazz Radio",
                tabPayments: "Payments",
                paymentsTitle: "Payments",
                paymentsDescription: "Payment feature will be available in the next version",
                backToDashboard: "Back to Dashboard",
            },
            az: {
                appTitle: "ORDINA", appSubtitle: "Maliyyələrinizi asanlıqla idarə edin.",
                tabDashboard: "Ümumi", tabDebts: "Borclar", tabRecurringExpenses: "Aylıq xərclər", tabMonthlyExpenses: "Aylıq xərclər", tabTasks: "Tapşırıqlar", tabCalendar: "Təqvim",
                dashboardTitle: "Aylıq ümumi", loading: "Məlumatlar yüklənir...",
                dashRecurringPaid: "Aylıq (ödənilmiş)", dashRecurringRemaining: "Aylıq (qalan)", dashMonthlyExpenses: "Aylıq xərclər", dashTotalDebt: "Ümumi borc qalığı", dashTopCategories: "Əsas xərc kateqoriyaları",
                debtsTitle: "Bütün borclar", addDebt: "Borç əlavə et", debtName: "Borç (Ad)", amount: "Məbləğ", paid: "Ödənilmiş", remaining: "Qalan", lastPaymentDate: "Son ödəniş tarixi", comments: "Şərhlər", actions: "Əməлијјатлар", emptyDebts: "Borclar siyahısı boşdur. Başlamaq üçün 'Borç əlavə et' düyməsini basın.",
                recurringTitle: "Aylıq xərclər", addTemplate: "Şablon əlavə et", paymentDay: "Ödəniş günü", status: "Status", details: "Təfərrüatlar", templateActions: "Şablon əməliyyatları", emptyRecurring: "Aylıq xərclər siyahısı boşdur. Şablon yaradın.",
                expensesTitle: "Bütün xərclər", addExpense: "Xərc əlavə et", category: "Kateqoriya", date: "Tarix", emptyExpenses: "Bu ay üçün hələ xərc yoxdur.",
                taskToday: "Bu gün", taskMonth: "Ay", taskYear: "İl", taskTodayTitle: "Bu günkü tapşırıqlar", taskMonthTitle: "Aylıq tapşırıqlar", taskYearTitle: "İllik tapşırıqlar", addTask: "Tapşırıq əlavə et", name: "Ad", notes: "Qeydlər", deadline: "Müddət", emptyTasks: "Tapşırıqlar siyahısı boşdur.",
                cancel: "Ləğv et", save: "Saxla", add: "Əlavə et", delete: "Sil", close: "Bağla",
                debtorName: "Borclu adı/Başlıq", totalAmount: "Ümumi məbləğ", paidAmount: "Ödənilmiş məbləğ", comment: "Şərh",
                addDebtPayment: "Borç ödənişi əlavə et", paymentAmount: "Ödəniş məbləği", paymentDayNum: "Ödəniş günü (1-31)",
                deleteConfirm: "Bunu silmək istədiyinizə əminsiniz?",
                paidStatus: "Ödənilmiş", unpaidStatus: "Ödənilməmiş",
                statusDone: "Tamamlanmış", statusNotDone: "Tamamlanmamış", statusSkipped: "Keçilmiş",
                editDebt: "Borcu redaktə et", editTemplate: "Şablonu redaktə et", editExpense: "Xərci redaktə et", editTask: "Tapşırığı redaktə et",
                addTaskForToday: "Bu gün üçün tapşırıq əlavə et", addTaskForMonth: "Ay üçün tapşırıq əlavə et", addTaskForYear: "İl üçün tapşırıq əlavə et",
                chartLabel: "Xərclər",
                dashTasksMonth: "Qalan tapşırıqlar (ay)", dashTasksYear: "Qalan tapşırıqlar (il)",
                debtRepayments: "Borç ödənişləri", recurringPayments: "Aylıq ödənişlər",
                placeholderComment: "Şərh əlavə edin...",
                addEvent: "Tədbir əlavə et", editEvent: "Tədbiri redaktə et", eventName: "Tədbir adı", createTaskForEvent: "Bu tədbir üçün tapşırıq yaradın",
                weekdays: ["B.E", "Ç.A", "Ç", "C.A", "C", "Ş", "B"],
                categoryEvent: "Tədbir", categoryBirthday: "Ad günü", categoryMeeting: "Görüş", categoryWedding: "Toy",
                birthdayName: "Ad günü olan şəxsin adı", birthYear: "Doğum ili (istəyə bağlı)", meetingWith: "Kiminlə", time: "Vaxt (istəyə bağlı)", place: "Yer (istəyə bağlı)", weddingNames: "Cütlüyün adları",
                taskCongratulate: "Təbrik et", taskTurning: "yaşını tamamlayır", taskYearsOld: "yaşında", taskMeetWith: "ilə görüş", taskWeddingOf: "Toyu",
                authTitle: "Hesabınıza daxil olun", login: "Daxil ol", register: "Qeydiyyat", logout: "Çıxış", loginWithGoogle: "Google ilə daxil ol",
                authInvalidEmail: "Yanlış email formatı.",
                authEmailInUse: "Bu email artıq istifadə olunur.",
                authWeakPassword: "Parol çox zəifdir. Ən azı 6 simvol olmalıdır.",
                authInvalidCredentials: "Yanlış email və ya parol.",
                authGenericError: "Xəta baş verdi. Yenidən cəhd edin.",
                manageCategories: "Kateqoriyaları idarə et", manageCategoriesTitle: "Kateqoriyaları idarə et",
                toastSuccess: "Uğurla yadda saxlanıldı!", toastError: "Yaddaş xətası!", toastDeleted: "Yazı silindi.",
                radioTitle: "AzerbaiJazz Radio",
                tabPayments: "Ödənişlər",
                paymentsTitle: "Ödənişlər",
                paymentsDescription: "Ödəniş funksiyası növbəti versiyada əlçatan olacaq",
                backToDashboard: "Əsas səhifəyə qayıt",
            }
        };
        let currentLang = localStorage.getItem('appLanguage') || 'ru';

        function getTodayISOString() {
            const today = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Baku' };
            return new Intl.DateTimeFormat('en-CA', options).format(today);
        }
        function formatISODateForDisplay(isoString, options = {}) {
            if (!isoString || typeof isoString !== 'string' || !isoString.includes('-')) return '—';
            const [year, month, day] = isoString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const defaultOptions = { day: 'numeric', month: 'long' };
            if (options.year) defaultOptions.year = 'numeric';
            return date.toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { ...defaultOptions, ...options });
        }
        function formatMonthId(monthId) {
            if (!monthId) return '';
            const [year, month] = monthId.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { month: 'long', year: 'numeric', timeZone: 'Asia/Baku' });
        }

        function setLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            window.currentLang = lang; // Обновляем глобальную переменную
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            updateLanguageButtons();
            updateMonthDisplay();
            renderCalendar();
            attachListeners();
        }

        function updateLanguageButtons() {
            ['ru', 'en', 'az'].forEach(lang => {
                const btn = document.getElementById(`lang-${lang}`);
                if (btn) {
                    btn.classList.toggle('ring-2', lang === currentLang);
                    // Обновляем ARIA состояния
                    btn.setAttribute('aria-pressed', lang === currentLang ? 'true' : 'false');
                }
            });
            ['ru-login', 'en-login', 'az-login'].forEach(lang => {
                const btn = document.getElementById(`lang-${lang}`);
                if (btn) {
                    const isActive = lang.replace('-login', '') === currentLang;
                    if (isActive) {
                        btn.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-blue-600 text-white';
                    } else {
                        btn.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300';
                    }
                    // Обновляем ARIA состояния
                    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                }
            });
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app');
        function showLoginScreen() { loadingOverlay.classList.add('hidden'); authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); }
        function showApp() { authContainer.classList.add('hidden'); appContainer.classList.remove('hidden'); }

        async function setupDefaultData(user) {
            const categoriesRef = collection(db, `users/${user.uid}/categories`);
            const q = query(categoriesRef, limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                const batch = writeBatch(db);
                const defaultCategories = {
                    ru: ["Продукты", "Транспорт", "Жилье", "Здоровье", "Развлечения", "Одежда", "Кафе и рестораны", "Подарки", "Связь и интернет", "Образование"],
                    en: ["Groceries", "Transport", "Housing", "Health", "Entertainment", "Clothing", "Cafes & Restaurants", "Gifts", "Communication & Internet", "Education"],
                    az: ["Ərzaq", "Nəqliyyat", "Mənzil", "Sağlamlıq", "Əyləncə", "Geyim", "Kafe və Restoranlar", "Hədiyyələr", "Rabitə və İnternet", "Təhsil"]
                };
                for (const [lang, names] of Object.entries(defaultCategories)) {
                    names.forEach(name => {
                        const newCatRef = doc(categoriesRef);
                        batch.set(newCatRef, { name, lang });
                    });
                }
                await batch.commit();
            }
        }

        // Инициализация базовых модулей
        const keyboardNav = new KeyboardNavigation();

        // ═══════════════════════════════════════════════════════════════
        // УЛУЧШЕННАЯ ОБРАБОТКА ОШИБОК
        // ═══════════════════════════════════════════════════════════════
        
        class ErrorHandler {
            static handle(error, context = '', options = {}) {
                console.error(`[${context}] Error:`, error);
                
                // Определяем тип ошибки
                let errorMessage = 'Произошла ошибка. Попробуйте еще раз.';
                
                if (error.code) {
                    switch (error.code) {
                        case 'permission-denied':
                            errorMessage = 'Нет доступа. Проверьте права доступа.';
                            break;
                        case 'not-found':
                            errorMessage = 'Данные не найдены.';
                            break;
                        case 'already-exists':
                            errorMessage = 'Данные уже существуют.';
                            break;
                        case 'unauthenticated':
                            errorMessage = 'Требуется авторизация.';
                            break;
                        case 'unavailable':
                            errorMessage = 'Сервис временно недоступен.';
                            break;
                        case 'deadline-exceeded':
                            errorMessage = 'Превышено время ожидания.';
                            break;
                        default:
                            errorMessage = `Ошибка: ${error.code}`;
                    }
                }
                
                if (options.showToast !== false && window.showToast) {
                    window.showToast(errorMessage, 'error');
                }
                
                return { shouldRetry: false, attempt: 1, error };
            }
            
            // Обертка для безопасного выполнения async функций
            static async safeExecute(fn, context = '', options = {}) {
                try {
                    return await fn();
                } catch (error) {
                    this.handle(error, context, options);
                    if (options.throwError) throw error;
                    return null;
                }
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // ОБЕРТКИ ДЛЯ FIREBASE ОПЕРАЦИЙ С ОБРАБОТКОЙ ОШИБОК
        // ═══════════════════════════════════════════════════════════════
        
        const FirebaseWrapper = {
            // Добавление документа
            async addDoc(collection, data, context = 'add-document') {
                return ErrorHandler.safeExecute(
                    async () => {
                        const docRef = await addDoc(collection, data);
                        return docRef;
                    },
                    context,
                    { showToast: true }
                );
            },
            
            // Обновление документа
            async updateDoc(docRef, data, context = 'update-document') {
                return ErrorHandler.safeExecute(
                    async () => {
                        await updateDoc(docRef, data);
                        return true;
                    },
                    context,
                    { showToast: true }
                );
            },
            
            // Удаление документа
            async deleteDoc(docRef, context = 'delete-document') {
                return ErrorHandler.safeExecute(
                    async () => {
                        await deleteDoc(docRef);
                        return true;
                    },
                    context,
                    { showToast: true }
                );
            },
            
            // Получение документа
            async getDoc(docRef, context = 'get-document') {
                return ErrorHandler.safeExecute(
                    async () => {
                        const docSnap = await getDoc(docRef);
                        return docSnap;
                    },
                    context,
                    { showToast: false }
                );
            },
            
            // Получение коллекции
            async getDocs(query, context = 'get-documents') {
                return ErrorHandler.safeExecute(
                    async () => {
                        const snapshot = await getDocs(query);
                        return snapshot;
                    },
                    context,
                    { showToast: false }
                );
            },
            
            // Batch операции
            async batchCommit(batch, context = 'batch-commit') {
                return ErrorHandler.safeExecute(
                    async () => {
                        await batch.commit();
                        return true;
                    },
                    context,
                    { showToast: true }
                );
            }
        };

        // Глобальные переменные для совместимости
        window.currentLang = localStorage.getItem('appLanguage') || 'ru';
        window.translations = translations;
        window.Utils = Utils;
        window.ErrorHandler = ErrorHandler;
        window.keyboardNav = keyboardNav;

        // Инициализация accessibility функций
        keyboardNav.initAccessibility();

        // Функция смены языка


        if (auth) {
            // Языковые кнопки в приложении
            Utils.safeAddEventListener('lang-ru', 'click', () => setLanguage('ru'));
            Utils.safeAddEventListener('lang-en', 'click', () => setLanguage('en'));
            Utils.safeAddEventListener('lang-az', 'click', () => setLanguage('az'));

            // Языковые кнопки на странице входа
            Utils.safeAddEventListener('lang-ru-login', 'click', () => setLanguage('ru'));
            Utils.safeAddEventListener('lang-en-login', 'click', () => setLanguage('en'));
            Utils.safeAddEventListener('lang-az-login', 'click', () => setLanguage('az'));

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const todayISO = getTodayISOString();
                    currentMonthId = todayISO.slice(0, 7);
                    selectedMonthId = currentMonthId;
                    calendarDate = new Date(todayISO + 'T00:00:00');

                    await setupDefaultData(user);
                    showApp();
                    setupCollections(todayISO);
                    await checkAndCarryOverDailyTasks(todayISO);
                    await checkAndCarryOverTasks();
                    await ensureRecurringTasksForMonth(selectedMonthId);
                    attachListeners();
                    setLanguage(currentLang);
                    updateDateTime();
                    if (dateTimeInterval) clearInterval(dateTimeInterval);
                    dateTimeInterval = setInterval(updateDateTime, 60000);
                } else { showLoginScreen(); }
            });
        }

        function setupCollections(todayId = getTodayISOString()) {
            if (!userId) return;
            debtsCol = collection(db, `users/${userId}/debts`);
            recurringExpensesCol = collection(db, `users/${userId}/recurringExpenses`);
            monthlyDataCol = collection(db, `users/${userId}/monthlyData`);
            // Обновляем expensesCol с актуальным selectedMonthId при каждой смене месяца
            expensesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/expenses`);
            recurringExpenseStatusesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/recurringExpenseStatuses`);
            dailyTasksCol = collection(db, `users/${userId}/dailyTasks/${todayId}/tasks`);
            monthlyTasksCol = collection(db, `users/${userId}/monthlyTasks`);
            yearlyTasksCol = collection(db, `users/${userId}/yearlyTasks`);
            calendarEventsCol = collection(db, `users/${userId}/calendarEvents`);
            categoriesCol = collection(db, `users/${userId}/categories`);
        }

        async function checkAndCarryOverDailyTasks(todayId) {
            const lastCheckKey = `lastDailyCheck_${userId}`;
            const lastCheck = localStorage.getItem(lastCheckKey);
            if (lastCheck === todayId) return;
            const yesterday = new Date(todayId + 'T00:00:00');
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayId = yesterday.toISOString().split('T')[0];
            if (lastCheck && lastCheck < todayId) {
                try {
                    const yesterdayTasksCol = collection(db, `users/${userId}/dailyTasks/${yesterdayId}/tasks`);
                    const q = query(yesterdayTasksCol, where("status", "==", translations.ru.statusNotDone));
                    const tasksToCarryOverSnapshot = await getDocs(q);
                    if (!tasksToCarryOverSnapshot.empty) {
                        const batch = writeBatch(db);
                        const todayTasksColRef = collection(db, `users/${userId}/dailyTasks/${todayId}/tasks`);
                        tasksToCarryOverSnapshot.forEach(docSnap => {
                            const taskData = docSnap.data();
                            const newTaskRef = doc(todayTasksColRef);
                            batch.set(newTaskRef, { ...taskData, notes: `(Перенесено с ${formatISODateForDisplay(yesterdayId)}) ${taskData.notes || ''}`.trim(), carriedOver: true });
                        });
                        await batch.commit();
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'recurring-tasks-creation', {
                        showToast: true,
                        retryable: false
                    });
                }
            }
            localStorage.setItem(lastCheckKey, todayId);
        }

        async function checkAndCarryOverTasks() {
            const lastCheckKey = `taskCarryOverMonth_${userId}`;
            const lastCheck = localStorage.getItem(lastCheckKey);
            if (lastCheck !== currentMonthId) {
                const prevMonthDate = new Date(currentMonthId + '-01T00:00:00');
                prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
                const prevMonthId = prevMonthDate.toISOString().slice(0, 7);
                const q = query(monthlyTasksCol, where("month", "==", prevMonthId), where("status", "==", translations.ru.statusNotDone));
                const tasksSnapshot = await getDocs(q);
                const batch = writeBatch(db);
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    if (!task.fromCalendar) batch.update(doc.ref, { month: currentMonthId, carriedOver: true });
                });
                await batch.commit();
                localStorage.setItem(lastCheckKey, currentMonthId);
            }
        }

        async function ensureRecurringTasksForMonth(monthId) {
            if (!userId) return;
            const [year, month] = monthId.split('-');
            const t = translations[currentLang];
            const q = query(calendarEventsCol, where("category", "==", "birthday"));
            const birthdayEventsSnapshot = await getDocs(q);
            const batch = writeBatch(db);
            for (const eventDoc of birthdayEventsSnapshot.docs) {
                const event = eventDoc.data();
                if (event.date.substring(5, 7) === month) {
                    const taskQuery = query(monthlyTasksCol, where("fromCalendar", "==", eventDoc.id), where("month", "==", monthId));
                    const existingTasksSnapshot = await getDocs(taskQuery);
                    if (existingTasksSnapshot.empty) {
                        let taskName = `${t.taskCongratulate} ${event.birthdayName}`;
                        if (event.birthYear) { const age = parseInt(year) - parseInt(event.birthYear); if (age >= 0) taskName += ` (${t.taskTurning} ${age} ${t.taskYearsOld})`; }
                        const deadline = `${monthId}-${event.date.substring(8)}`;
                        batch.set(doc(monthlyTasksCol), { name: taskName, deadline, status: translations.ru.statusNotDone, month: monthId, year: parseInt(year), fromCalendar: eventDoc.id });
                    }
                }
            }
            await batch.commit();
        }

        function updateDateTime() { const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Baku' }; document.getElementById('current-datetime').textContent = new Date().toLocaleString(currentLang === 'ru' ? 'ru-RU' : 'en-US', options); }
        function updateMonthDisplay() { const formattedDate = formatMonthId(selectedMonthId); document.querySelectorAll('.current-month-name').forEach(el => el.textContent = formattedDate); document.getElementById('recurring-month-name').textContent = formattedDate; document.getElementById('today-date').textContent = formatISODateForDisplay(getTodayISOString(), { year: undefined }); }

        const tabs = document.querySelectorAll('.tab-button');
        const taskTabs = document.querySelectorAll('.task-tab-button');
        tabs.forEach(tab => tab.addEventListener('click', () => {
            // Обновляем классы
            tabs.forEach(t => t.classList.remove('tab-active'));
            tab.classList.add('tab-active');
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${tab.dataset.tab}-page`).classList.remove('hidden');

            // Обновляем ARIA состояния
            tabs.forEach(t => {
                t.setAttribute('aria-selected', 'false');
                t.setAttribute('tabindex', '-1');
            });
            tab.setAttribute('aria-selected', 'true');
            tab.setAttribute('tabindex', '0');
        }));
        taskTabs.forEach(tab => tab.addEventListener('click', () => { taskTabs.forEach(t => t.classList.remove('task-tab-active')); tab.classList.add('task-tab-active'); document.querySelectorAll('.task-tab-content').forEach(p => p.classList.add('hidden')); document.getElementById(`task-tab-${tab.dataset.taskTab}`).classList.remove('hidden'); }));

        function attachListeners() {
            if (!userId) return;
            detachListeners();
            setupCollections();
            unsubscribes.push(onSnapshot(query(debtsCol), s => { allDebts = s.docs; renderDebts(allDebts); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(expensesCol), s => { allExpenses = s.docs; renderExpenses(allExpenses); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(recurringExpensesCol), s => { allRecurringTemplates = s.docs.map(d => ({ id: d.id, ...d.data() })); renderRecurringExpenses(); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(recurringExpenseStatusesCol), s => { currentMonthStatuses = {}; s.docs.forEach(d => { currentMonthStatuses[d.id] = d.data().status; }); renderRecurringExpenses(); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(monthlyDataCol), s => { const m = s.docs.map(d => d.id); if (!m.includes(currentMonthId)) m.push(currentMonthId); m.sort().reverse(); renderMonthSelector(m); }));
            unsubscribes.push(onSnapshot(query(categoriesCol), s => { const categories = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCategoryDatalist(s.docs); renderCategories(categories); }));
            unsubscribes.push(onSnapshot(query(dailyTasksCol), s => { dailyTasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderDailyTasks(dailyTasks); }));
            unsubscribes.push(onSnapshot(query(monthlyTasksCol, where("month", "==", selectedMonthId)), s => { monthlyTasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderMonthlyTasks(monthlyTasks); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(yearlyTasksCol, where("year", "==", calendarDate.getFullYear())), s => { yearlyTasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderYearlyTasks(yearlyTasks); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(calendarEventsCol), s => { calendarEvents = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCalendar(); }));
        }

        function detachListeners() { unsubscribes.forEach(unsub => unsub()); unsubscribes = []; }
        function formatCurrency(amount) { if (typeof amount !== 'number') amount = 0; const value = currentCurrency === 'USD' ? amount / exchangeRate : amount; const symbol = currentCurrency === 'USD' ? '$' : 'AZN'; return `${value.toFixed(2)} ${symbol}`; }
        function renderCategoryDatalist(docs) { const datalist = document.getElementById('expense-categories-list'); datalist.innerHTML = docs.filter(doc => doc.data().lang === currentLang).map(doc => `<option value="${doc.data().name}"></option>`).join(''); }
        function renderCategories(categories) { const list = document.getElementById('category-list'); if (!list) return; const langCategories = categories.filter(c => c.lang === currentLang); list.innerHTML = langCategories.map(cat => `<div class="flex justify-between items-center p-2 bg-gray-100 rounded-lg"><span>${cat.name}</span><button data-id="${cat.id}" class="delete-category-btn text-red-500 hover:text-red-700">🗑️</button></div>`).join(''); }

        const createEmptyState = (messageKey) => `<div class="flex flex-col items-center justify-center p-12 bg-gray-50 rounded-lg"><svg class="w-16 h-16 text-gray-300 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg><p class="text-gray-500 font-medium">${translations[currentLang][messageKey]}</p></div>`;

        function renderDebts(docs) {
            const tableWrapper = document.getElementById('debts-table-wrapper');
            const tableBody = document.getElementById('debts-table');
            const emptyState = document.getElementById('debts-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyDebts');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = docs.map(doc => {
                const debt = doc.data(), id = doc.id; const remaining = (debt.totalAmount || 0) - (debt.paidAmount || 0);
                let colorClass = remaining <= 0 ? 'text-green-600' : (debt.paidAmount > 0 ? 'text-yellow-600' : 'text-red-600');
                const lastPaymentDate = debt.lastPaymentDate ? debt.lastPaymentDate.toDate().toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'en-US') : '—';
                return `<tr class="border-b hover:bg-gray-50 md:border-b-0"><td data-label="${translations[currentLang].debtName}" class="font-medium">${debt.name}</td><td data-label="${translations[currentLang].amount}">${formatCurrency(debt.totalAmount)}</td><td data-label="${translations[currentLang].paid}">${formatCurrency(debt.paidAmount)}</td><td data-label="${translations[currentLang].remaining}" class="font-bold ${colorClass}">${formatCurrency(remaining)}</td><td data-label="${translations[currentLang].lastPaymentDate}">${lastPaymentDate}</td><td data-label="${translations[currentLang].comments}"><input type="text" class="editable-debt-comment bg-transparent w-full p-1" data-id="${id}" value="${debt.comment || ''}" placeholder="${translations[currentLang].placeholderComment}"></td><td data-label="${translations[currentLang].actions}" class="flex gap-2"><button data-id="${id}" class="add-debt-payment-btn text-green-600 hover:text-green-800" title="${translations[currentLang].addDebtPayment}">➕</button><button data-id="${id}" class="edit-debt-btn text-blue-600 hover:text-blue-800" title="${translations[currentLang].editDebt}">✏️</button><button data-id="${id}" class="delete-debt-btn text-red-600 hover:text-red-800" title="${translations[currentLang].delete}">🗑️</button></td></tr>`;
            }).join('');
        }

        function renderRecurringExpenses() {
            const tableWrapper = document.getElementById('recurring-expenses-table-wrapper');
            const tableBody = document.getElementById('recurring-expenses-table');
            const emptyState = document.getElementById('recurring-expenses-empty');
            if (allRecurringTemplates.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyRecurring');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const todayDay = new Date(getTodayISOString() + 'T00:00:00').getDate();
            tableBody.innerHTML = allRecurringTemplates.map(template => {
                const status = currentMonthStatuses[template.id] || translations.ru.unpaidStatus;
                const isOverdue = status === translations.ru.unpaidStatus && template.dueDay < todayDay && selectedMonthId === currentMonthId;
                const isPaid = status === translations.ru.paidStatus;
                return `<tr class="border-b hover:bg-gray-50 ${isOverdue ? 'bg-red-50' : ''} md:border-b-0">
                        <td data-label="${translations[currentLang].name}" class="font-medium">${template.name}</td>
                        <td data-label="${translations[currentLang].amount}">${formatCurrency(template.amount)}</td>
                        <td data-label="${translations[currentLang].paymentDay}">${template.dueDay || '—'}</td>
                        <td data-label="${translations[currentLang].status}">
                            <select data-id="${template.id}" class="recurring-status-select p-1 rounded-md border-0 ring-1 ring-inset ring-gray-300 ${isPaid ? 'bg-green-100' : 'bg-red-100'}">
                                <option value="${translations.ru.unpaidStatus}" ${!isPaid ? 'selected' : ''}>${translations[currentLang].unpaidStatus}</option>
                                <option value="${translations.ru.paidStatus}" ${isPaid ? 'selected' : ''}>${translations[currentLang].paidStatus}</option>
                            </select></td>
                        <td data-label="${translations[currentLang].details}">${template.details || '—'}</td>
                        <td data-label="${translations[currentLang].templateActions}" class="flex gap-2">
                            <button data-id="${template.id}" class="edit-recurring-expense-btn text-blue-600 hover:text-blue-800">✏️</button>
                            <button data-id="${template.id}" class="delete-recurring-expense-btn text-red-600 hover:text-red-800">🗑️</button>
                        </td></tr>`;
            }).join('');
        }

        function renderExpenses(docs) {
            const tableWrapper = document.getElementById('expenses-table-wrapper');
            const tableBody = document.getElementById('expenses-table');
            const emptyState = document.getElementById('expenses-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyExpenses');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const sortedDocs = [...docs].sort((a, b) => {
                const dateA = a.data()?.date || '';
                const dateB = b.data()?.date || '';
                return dateB.localeCompare ? dateB.localeCompare(dateA) : dateB > dateA ? -1 : 1;
            });

            tableBody.innerHTML = sortedDocs.map(doc => {
                const expense = doc.data(), id = doc.id;
                let actionsHtml = (!expense.recurringExpenseId && !expense.debtPaymentId) ? `<button data-id="${id}" class="edit-expense-btn text-blue-600 hover:text-blue-800" title="${translations[currentLang].editExpense}">✏️</button><button data-id="${id}" class="delete-expense-btn text-red-600 hover:text-red-800" title="${translations[currentLang].delete}">🗑️</button>` : '';
                return `<tr class="border-b hover:bg-gray-50 md:border-b-0">
                        <td data-label="${translations[currentLang].name}" class="font-medium">${expense.name}</td>
                        <td data-label="${translations[currentLang].category}">${expense.category}</td>
                        <td data-label="${translations[currentLang].amount}">${formatCurrency(expense.amount)}</td>
                        <td data-label="${translations[currentLang].date}">${formatISODateForDisplay(expense.date)}</td>
                        <td data-label="${translations[currentLang].actions}" class="flex gap-2">${actionsHtml}</td></tr>`;
            }).join('');
        }

        function createTaskStatusDropdown(id, status, colName) {
            const t = translations[currentLang]; const ruT = translations.ru;
            const options = { [ruT.statusNotDone]: { text: t.statusNotDone, class: 'bg-yellow-100 text-yellow-800' }, [ruT.statusDone]: { text: t.statusDone, class: 'bg-green-100 text-green-800' }, [ruT.statusSkipped]: { text: t.statusSkipped, class: 'bg-gray-100 text-gray-800' } };
            const currentStatus = status || ruT.statusNotDone;
            let selectHTML = `<select data-id="${id}" data-col="${colName}" class="task-status-select p-1 rounded-md border-0 ring-1 ring-inset ring-gray-300 ${options[currentStatus]?.class}">`;
            for (const [value, { text }] of Object.entries(options)) { selectHTML += `<option value="${value}" ${currentStatus === value ? 'selected' : ''}>${text}</option>`; }
            selectHTML += `</select>`; return selectHTML;
        }

        function renderDailyTasks(docs) {
            const tableWrapper = document.getElementById('daily-tasks-table-wrapper');
            const tableBody = document.getElementById('daily-tasks-table');
            const emptyState = document.getElementById('daily-tasks-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyTasks');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = docs.map(d => { const t = d; const s = t.status; return `<tr class="md:border-b-0 ${t.carriedOver ? 'bg-blue-50' : ''}"><td data-label="${translations[currentLang].name}" class="${s === translations.ru.statusDone ? 'line-through text-gray-500' : ''}">${t.name}</td><td data-label="${translations[currentLang].status}">${createTaskStatusDropdown(t.id, s, 'dailyTasks')}</td><td data-label="${translations[currentLang].notes}"><input type="text" class="editable-task-notes bg-transparent w-full p-1" data-id="${t.id}" data-col="dailyTasks" value="${t.notes || ''}" placeholder="${translations[currentLang].placeholderComment}"></td><td data-label="${translations[currentLang].actions}" class="flex gap-2"><button data-id="${t.id}" class="edit-daily-task-btn text-blue-600">✏️</button><button data-id="${t.id}" class="delete-daily-task-btn text-red-600">🗑️</button></td></tr>`; }).join('');
        }
        function renderMonthlyTasks(docs) {
            const tableWrapper = document.getElementById('monthly-tasks-table-wrapper');
            const tableBody = document.getElementById('monthly-tasks-table');
            const emptyState = document.getElementById('monthly-tasks-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyTasks');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const sortedDocs = [...docs].sort((a, b) => {
                const deadlineA = a.deadline || '';
                const deadlineB = b.deadline || '';
                return deadlineA.localeCompare ? deadlineA.localeCompare(deadlineB) : deadlineA > deadlineB ? 1 : -1;
            });

            tableBody.innerHTML = sortedDocs.map(d => { const t = d, id = d.id; const s = t.status; return `<tr class="md:border-b-0 ${t.carriedOver ? 'bg-yellow-50' : ''}"><td data-label="${translations[currentLang].name}" class="${s === translations.ru.statusDone ? 'line-through text-gray-500' : ''}">${t.name}</td><td data-label="${translations[currentLang].deadline}">${formatISODateForDisplay(t.deadline)}</td><td data-label="${translations[currentLang].status}">${createTaskStatusDropdown(id, s, 'monthlyTasks')}</td><td data-label="${translations[currentLang].actions}" class="flex gap-2">${!t.recurringExpenseId && !t.fromCalendar ? `<button data-id="${id}" class="edit-monthly-task-btn text-blue-600">✏️</button><button data-id="${id}" class="delete-monthly-task-btn text-red-600">🗑️</button>` : ''}</td></tr>`; }).join('');
        }
        function renderYearlyTasks(docs) {
            const tableWrapper = document.getElementById('yearly-tasks-table-wrapper');
            const tableBody = document.getElementById('yearly-tasks-table');
            const emptyState = document.getElementById('yearly-tasks-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyTasks');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = docs.map(d => { const t = d, id = d.id; const s = t.status; return `<tr class="md:border-b-0"><td data-label="${translations[currentLang].name}" class="${s === translations.ru.statusDone ? 'line-through text-gray-500' : ''}">${t.name}</td><td data-label="${translations[currentLang].deadline}">${formatISODateForDisplay(t.deadline, { year: 'numeric' })}</td><td data-label="${translations[currentLang].status}">${createTaskStatusDropdown(id, s, 'yearlyTasks')}</td><td data-label="${translations[currentLang].notes}"><input type="text" class="editable-task-notes bg-transparent w-full p-1" data-id="${id}" data-col="yearlyTasks" value="${t.notes || ''}" placeholder="${translations[currentLang].placeholderComment}"></td><td data-label="${translations[currentLang].actions}" class="flex gap-2"><button data-id="${id}" class="edit-yearly-task-btn text-blue-600">✏️</button><button data-id="${id}" class="delete-yearly-task-btn text-red-600">🗑️</button></td></tr>`; }).join('');
        }

        function renderMonthSelector(months) { const s = document.getElementById('month-selector'); s.innerHTML = months.map(m => `<option value="${m}" ${m === selectedMonthId ? 'selected' : ''}>${formatMonthId(m)}</option>`).join(''); }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); const monthYearEl = document.getElementById('calendar-month-year'); const weekdaysEl = document.getElementById('calendar-weekdays'); const month = calendarDate.getMonth(), year = calendarDate.getFullYear();
            monthYearEl.textContent = calendarDate.toLocaleString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { month: 'long', year: 'numeric', timeZone: 'Asia/Baku' });
            weekdaysEl.innerHTML = translations[currentLang].weekdays.map(day => `<div>${day}</div>`).join('');
            const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const startingDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            grid.innerHTML = ''; for (let i = 0; i < startingDay; i++) { grid.insertAdjacentHTML('beforeend', '<div></div>'); }
            const todayISO = getTodayISOString();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const monthDayStr = dateStr.substring(5); const isToday = dateStr === todayISO;
                const dayEvents = calendarEvents.filter(e => e.category === 'birthday' ? e.date.substring(5) === monthDayStr : e.date === dateStr);
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day border border-gray-200 p-2 flex flex-col cursor-pointer hover:bg-gray-50 ${isToday ? 'calendar-day-today' : ''}`;
                dayEl.dataset.date = dateStr;
                dayEl.innerHTML = `<div class="calendar-day-number self-end text-center rounded-full flex items-center justify-center">${day}</div><div class="events mt-1 space-y-1 overflow-y-auto text-xs">${dayEvents.map(e => `<div data-event-id="${e.id}" class="event-item p-1 bg-blue-100 text-blue-800 rounded truncate">${e.name}</div>`).join('')}</div>`;
                grid.appendChild(dayEl);
            }
        }
        Utils.safeAddEventListener('prev-month-btn', 'click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        Utils.safeAddEventListener('next-month-btn', 'click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

        Utils.safeAddEventListener('month-selector', 'change', async (e) => {
            selectedMonthId = e.target.value;
            // Обновляем calendarDate для корректного отображения годовых задач
            const [year, month] = selectedMonthId.split('-').map(Number);
            calendarDate = new Date(year, month - 1, 1);
            await ensureRecurringTasksForMonth(selectedMonthId);
            updateMonthDisplay();
            attachListeners();
        });
        document.getElementById('app').addEventListener('change', async (e) => {
            try {
                const id = e.target.dataset.id;
                
                // Обновление статуса задачи
                if (e.target.classList.contains('task-status-select')) {
                    const newStatus = e.target.value;
                    const colName = e.target.dataset.col;
                    let colRef;
                    
                    if (colName === 'dailyTasks') colRef = dailyTasksCol;
                    else if (colName === 'monthlyTasks') colRef = monthlyTasksCol;
                    else if (colName === 'yearlyTasks') colRef = yearlyTasksCol;
                    
                    if (colRef && id) {
                        await updateDoc(doc(colRef, id), { status: newStatus });
                        showToast(translations[currentLang].toastSuccess, 'success');
                    }
                }
                
                if (!id) return;
                
                // Обновление комментария к долгу
                if (e.target.classList.contains('editable-debt-comment')) {
                    await updateDoc(doc(debtsCol, id), { comment: e.target.value });
                    showToast(translations[currentLang].toastSuccess, 'success');
                }
                
                // Обновление заметок к задаче
                if (e.target.classList.contains('editable-task-notes')) {
                    const colName = e.target.dataset.col;
                    const colRef = colName === 'dailyTasks' ? dailyTasksCol : yearlyTasksCol;
                    await updateDoc(doc(colRef, id), { notes: e.target.value });
                    showToast(translations[currentLang].toastSuccess, 'success');
                }
                
                // Обновление статуса ежемесячного платежа
                if (e.target.classList.contains('recurring-status-select')) {
                    const newStatus = e.target.value;
                    const targetRecurringStatusesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/recurringExpenseStatuses`);
                    await setDoc(doc(targetRecurringStatusesCol, id), { status: newStatus });

                    const taskQuery = query(monthlyTasksCol, where("recurringExpenseId", "==", id), where("month", "==", selectedMonthId));
                    const targetExpensesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/expenses`);

                    if (newStatus === translations.ru.paidStatus) {
                        const template = allRecurringTemplates.find(t => t.id === id);
                        if (template) {
                            await addDoc(targetExpensesCol, {
                                name: template.name,
                                category: translations[currentLang].recurringPayments,
                                amount: template.amount,
                                date: getTodayISOString(),
                                recurringExpenseId: id
                            });
                        }
                        const tasks = await getDocs(taskQuery);
                        if (!tasks.empty) {
                            await updateDoc(tasks.docs[0].ref, { status: translations.ru.statusDone });
                        }
                        showToast(translations[currentLang].toastSuccess, 'success');
                    } else {
                        const q = query(targetExpensesCol, where("recurringExpenseId", "==", id));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                        const tasks = await getDocs(taskQuery);
                        if (!tasks.empty) {
                            await updateDoc(tasks.docs[0].ref, { status: translations.ru.statusNotDone });
                        }
                        showToast(translations[currentLang].toastSuccess, 'success');
                    }
                }
            } catch (error) {
                ErrorHandler.handle(error, 'change-event', { showToast: true });
            }
        });

        const eventCategorySelector = document.getElementById('event-category');
        eventCategorySelector.addEventListener('change', (e) => {
            document.querySelectorAll('.event-category-fields').forEach(div => div.classList.add('hidden'));
            document.getElementById(`event-fields-${e.target.value}`).classList.remove('hidden');
            document.querySelectorAll('.event-category-fields input').forEach(input => { input.value = ''; input.required = false; });
            document.querySelectorAll(`#event-fields-${e.target.value} input`).forEach(input => { if (input.id !== 'event-birthday-year' && input.id !== 'event-meeting-time' && input.id !== 'event-meeting-place') { input.required = true; } });
        });
        document.getElementById('calendar-grid').addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day'); const eventEl = e.target.closest('.event-item'); const eventModal = document.getElementById('event-modal'); const t = translations[currentLang]; const form = document.getElementById('event-form');
            const openModal = () => { eventCategorySelector.dispatchEvent(new Event('change')); eventModal.showModal(); };
            if (eventEl) {
                const eventId = eventEl.dataset.eventId; const event = calendarEvents.find(ev => ev.id === eventId);
                if (event) {
                    form.reset(); document.getElementById('event-id').value = event.id; const category = event.category || 'event'; document.getElementById('event-category').value = category; document.getElementById('event-date').value = event.date;
                    switch (category) {
                        case 'birthday': document.getElementById('event-birthday-name').value = event.birthdayName || ''; document.getElementById('event-birthday-year').value = event.birthYear || ''; break;
                        case 'meeting': document.getElementById('event-meeting-with').value = event.meetingWith || ''; document.getElementById('event-meeting-time').value = event.meetingTime || ''; document.getElementById('event-meeting-place').value = event.meetingPlace || ''; break;
                        case 'wedding': document.getElementById('event-wedding-names').value = event.weddingNames || ''; break;
                        default: document.getElementById('event-name-generic').value = event.name || ''; break;
                    }
                    document.getElementById('event-modal-title').textContent = t.editEvent; document.getElementById('delete-event-btn').classList.remove('hidden'); openModal();
                }
            } else if (dayEl) {
                form.reset(); document.getElementById('event-id').value = ''; document.getElementById('event-category').value = 'event'; document.getElementById('event-date').value = dayEl.dataset.date; document.getElementById('event-modal-title').textContent = t.addEvent; document.getElementById('delete-event-btn').classList.add('hidden'); openModal();
            }
        });

        async function updateDashboard() {
            if (!userId) return;
            document.getElementById('app').classList.remove('opacity-0'); document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('dashboard-loading').classList.add('hidden'); document.getElementById('dashboard-content').classList.remove('hidden');
            const totalRecurringPaid = allRecurringTemplates.filter(t => currentMonthStatuses[t.id] === translations.ru.paidStatus).reduce((s, t) => s + (t.amount || 0), 0);
            document.getElementById('total-recurring-paid').textContent = formatCurrency(totalRecurringPaid);
            const totalRecurringRemaining = allRecurringTemplates.filter(t => (currentMonthStatuses[t.id] || translations.ru.unpaidStatus) === translations.ru.unpaidStatus).reduce((s, t) => s + (t.amount || 0), 0);
            document.getElementById('total-recurring-remaining').textContent = formatCurrency(totalRecurringRemaining);
            const allMonthlyExpensesTotal = allExpenses.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
            document.getElementById('total-monthly-outflow').textContent = formatCurrency(allMonthlyExpensesTotal);
            const totalDebtRemaining = allDebts.reduce((s, d) => s + ((d.data().totalAmount || 0) - (d.data().paidAmount || 0)), 0);
            document.getElementById('total-debt-remaining').textContent = formatCurrency(totalDebtRemaining);
            document.getElementById('tasks-remaining-month').textContent = monthlyTasks.filter(t => t.status === translations.ru.statusNotDone).length;
            document.getElementById('tasks-remaining-year').textContent = yearlyTasks.filter(t => t.status === translations.ru.statusNotDone).length;
            const expensesByCategory = {}; allExpenses.forEach(doc => { const e = doc.data(); expensesByCategory[e.category] = (expensesByCategory[e.category] || 0) + e.amount; });
            const sortedCategories = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a).slice(0, 7);
            const chartLabels = sortedCategories.map(item => item[0]);
            const chartData = sortedCategories.map(item => item[1]);
            if (expensesChart) expensesChart.destroy();
            expensesChart = new Chart(document.getElementById('expenses-chart').getContext('2d'), { type: 'bar', data: { labels: chartLabels, datasets: [{ label: `${translations[currentLang].chartLabel}`, data: chartData.map(amount => currentCurrency === 'USD' ? amount / exchangeRate : amount), backgroundColor: ['rgba(59,130,246,0.7)', 'rgba(239,68,68,0.7)', 'rgba(245,158,11,0.7)', 'rgba(16,185,129,0.7)', 'rgba(139,92,246,0.7)', 'rgba(236,72,153,0.7)', 'rgba(107,114,128,0.7)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });

            // Загружаем новости, погоду и Spotify
            loadNews();
            loadWeather();
            initSpotify();
        }

        // ═══════════════════════════════════════════════════════════════
        // ВИДЖЕТ ПОГОДЫ
        // ═══════════════════════════════════════════════════════════════
        
        async function loadWeather() {
            const weatherLoading = document.getElementById('weather-loading');
            const weatherError = document.getElementById('weather-error');
            const weatherContent = document.getElementById('weather-content');

            try {
                weatherLoading.classList.remove('hidden');
                weatherError.classList.add('hidden');
                weatherContent.classList.add('hidden');

                // Получаем геолокацию
                if (!navigator.geolocation) {
                    throw new Error('Geolocation not supported');
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        timeout: 10000,
                        enableHighAccuracy: false
                    });
                });

                const { latitude, longitude } = position.coords;

                // Используем БЕСПЛАТНЫЙ API без ключа - Open-Meteo
                // https://open-meteo.com - полностью бесплатный, без регистрации
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,pressure_msl&timezone=auto`;
                
                // Получаем название города через бесплатный Nominatim API
                const cityUrl = `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=${currentLang}`;

                const [weatherResponse, cityResponse] = await Promise.all([
                    fetch(weatherUrl),
                    fetch(cityUrl)
                ]);

                const weatherData = await weatherResponse.json();
                const cityData = await cityResponse.json();

                // Преобразуем данные в нужный формат
                const formattedData = {
                    name: cityData.address?.city || cityData.address?.town || cityData.address?.village || cityData.address?.county || 'Неизвестно',
                    main: {
                        temp: Math.round(weatherData.current.temperature_2m),
                        feels_like: Math.round(weatherData.current.apparent_temperature),
                        humidity: weatherData.current.relative_humidity_2m,
                        pressure: Math.round(weatherData.current.pressure_msl)
                    },
                    weather: [{
                        description: getWeatherDescription(weatherData.current.weather_code, currentLang),
                        icon: getWeatherIcon(weatherData.current.weather_code)
                    }],
                    wind: {
                        speed: Math.round(weatherData.current.wind_speed_10m * 10) / 10
                    }
                };

                displayWeather(formattedData);

                weatherLoading.classList.add('hidden');
                weatherContent.classList.remove('hidden');

            } catch (error) {
                console.error('[Weather] Failed to load weather:', error);
                weatherLoading.classList.add('hidden');
                weatherError.classList.remove('hidden');
            }
        }

        // Преобразование кода погоды в описание
        function getWeatherDescription(code, lang) {
            const descriptions = {
                0: { ru: 'ясно', en: 'clear sky', az: 'açıq hava' },
                1: { ru: 'преимущественно ясно', en: 'mainly clear', az: 'əsasən açıq' },
                2: { ru: 'переменная облачность', en: 'partly cloudy', az: 'qismən buludlu' },
                3: { ru: 'облачно', en: 'overcast', az: 'buludlu' },
                45: { ru: 'туман', en: 'fog', az: 'duman' },
                48: { ru: 'изморозь', en: 'depositing rime fog', az: 'şaxtalı duman' },
                51: { ru: 'легкая морось', en: 'light drizzle', az: 'yüngül çiskin' },
                53: { ru: 'морось', en: 'moderate drizzle', az: 'çiskin' },
                55: { ru: 'сильная морось', en: 'dense drizzle', az: 'güclü çiskin' },
                61: { ru: 'небольшой дождь', en: 'slight rain', az: 'yüngül yağış' },
                63: { ru: 'дождь', en: 'moderate rain', az: 'yağış' },
                65: { ru: 'сильный дождь', en: 'heavy rain', az: 'güclü yağış' },
                71: { ru: 'небольшой снег', en: 'slight snow', az: 'yüngül qar' },
                73: { ru: 'снег', en: 'moderate snow', az: 'qar' },
                75: { ru: 'сильный снег', en: 'heavy snow', az: 'güclü qar' },
                77: { ru: 'снежные зерна', en: 'snow grains', az: 'qar dənələri' },
                80: { ru: 'небольшой ливень', en: 'slight rain showers', az: 'yüngül leysan' },
                81: { ru: 'ливень', en: 'moderate rain showers', az: 'leysan' },
                82: { ru: 'сильный ливень', en: 'violent rain showers', az: 'güclü leysan' },
                85: { ru: 'снегопад', en: 'slight snow showers', az: 'qar yağışı' },
                86: { ru: 'сильный снегопад', en: 'heavy snow showers', az: 'güclü qar yağışı' },
                95: { ru: 'гроза', en: 'thunderstorm', az: 'ildırım' },
                96: { ru: 'гроза с градом', en: 'thunderstorm with hail', az: 'dolu ilə ildırım' },
                99: { ru: 'сильная гроза с градом', en: 'heavy thunderstorm with hail', az: 'güclü dolu ilə ildırım' }
            };
            
            return descriptions[code]?.[lang] || descriptions[0][lang];
        }

        // Получение иконки погоды
        function getWeatherIcon(code) {
            if (code === 0) return '☀️';
            if (code <= 3) return '⛅';
            if (code <= 48) return '🌫️';
            if (code <= 55) return '🌦️';
            if (code <= 65) return '🌧️';
            if (code <= 77) return '🌨️';
            if (code <= 82) return '⛈️';
            if (code <= 86) return '❄️';
            return '⚡';
        }

        function displayWeather(data) {
            document.getElementById('weather-city').textContent = data.name;
            document.getElementById('weather-description').textContent = data.weather[0].description;
            document.getElementById('weather-temp').textContent = `${Math.round(data.main.temp)}°`;
            document.getElementById('weather-feels-like').textContent = `Ощущается: ${Math.round(data.main.feels_like)}°`;
            document.getElementById('weather-humidity').textContent = `${data.main.humidity}%`;
            document.getElementById('weather-wind').textContent = `${data.wind.speed} м/с`;
            document.getElementById('weather-pressure').textContent = `${Math.round(data.main.pressure * 0.75)} мм`;
        }

        // Обновление погоды по кнопке
        Utils.safeAddEventListener('refresh-weather-btn', 'click', () => {
            loadWeather();
        });

        // ═══════════════════════════════════════════════════════════════
        // SPOTIFY ИНТЕГРАЦИЯ
        // ═══════════════════════════════════════════════════════════════
        
        let spotifyPlayer = null;
        let spotifyDeviceId = null;
        let spotifyAccessToken = null;

        function initSpotify() {
            // Проверяем есть ли сохраненный токен
            spotifyAccessToken = localStorage.getItem('spotify_access_token');
            
            if (spotifyAccessToken) {
                // Проверяем валидность токена
                checkSpotifyToken();
            }
        }

        async function checkSpotifyToken() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });

                if (response.ok) {
                    // Токен валиден, инициализируем плеер
                    loadSpotifySDK();
                } else {
                    // Токен невалиден, очищаем
                    localStorage.removeItem('spotify_access_token');
                    spotifyAccessToken = null;
                }
            } catch (error) {
                console.error('[Spotify] Token check failed:', error);
            }
        }

        function loadSpotifySDK() {
            // Загружаем Spotify Web Playback SDK
            if (!window.Spotify) {
                const script = document.createElement('script');
                script.src = 'https://sdk.scdn.co/spotify-player.js';
                script.async = true;
                document.body.appendChild(script);

                window.onSpotifyWebPlaybackSDKReady = () => {
                    initSpotifyPlayer();
                };
            } else {
                initSpotifyPlayer();
            }
        }

        function initSpotifyPlayer() {
            spotifyPlayer = new Spotify.Player({
                name: 'ORDINA Web Player',
                getOAuthToken: cb => { cb(spotifyAccessToken); },
                volume: 0.5
            });

            // Обработчики событий
            spotifyPlayer.addListener('ready', ({ device_id }) => {
                console.log('[Spotify] Ready with Device ID', device_id);
                spotifyDeviceId = device_id;
                showSpotifyConnected();
            });

            spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                console.log('[Spotify] Device ID has gone offline', device_id);
            });

            spotifyPlayer.addListener('player_state_changed', state => {
                if (state) {
                    updateSpotifyUI(state);
                }
            });

            // Подключаем плеер
            spotifyPlayer.connect();
        }

        function showSpotifyConnected() {
            const connectBtn = document.getElementById('spotify-compact-connect-btn');
            const player = document.getElementById('spotify-compact-player');
            
            if (connectBtn) connectBtn.classList.add('hidden');
            if (player) player.classList.remove('hidden');
        }

        function updateSpotifyUI(state) {
            const track = state.track_window.current_track;
            
            // Обновляем компактный плеер
            const trackInfo = `${track.name} - ${track.artists.map(a => a.name).join(', ')}`;
            const compactTrack = document.getElementById('spotify-compact-track');
            if (compactTrack) {
                compactTrack.textContent = trackInfo;
                compactTrack.title = trackInfo;
            }

            // Обновляем кнопку play/pause
            const playIcon = document.getElementById('spotify-compact-play-icon');
            const pauseIcon = document.getElementById('spotify-compact-pause-icon');
            
            if (playIcon && pauseIcon) {
                if (state.paused) {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                } else {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                }
            }
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ═══════════════════════════════════════════════════════════════
        // ПЕРЕКЛЮЧАТЕЛЬ РАДИО / SPOTIFY
        // ═══════════════════════════════════════════════════════════════
        
        let currentMusicSource = 'radio'; // 'radio' или 'spotify'

        Utils.safeAddEventListener('music-radio-btn', 'click', () => {
            currentMusicSource = 'radio';
            document.getElementById('music-radio-btn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('music-radio-btn').classList.remove('text-gray-600');
            document.getElementById('music-spotify-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('music-spotify-btn').classList.add('text-gray-600');
            
            document.getElementById('radio-controls').classList.remove('hidden');
            document.getElementById('spotify-controls').classList.add('hidden');
            
            // Останавливаем Spotify если играет
            if (spotifyPlayer) {
                spotifyPlayer.pause();
            }
        });

        Utils.safeAddEventListener('music-spotify-btn', 'click', () => {
            currentMusicSource = 'spotify';
            document.getElementById('music-spotify-btn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('music-spotify-btn').classList.remove('text-gray-600');
            document.getElementById('music-radio-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('music-radio-btn').classList.add('text-gray-600');
            
            document.getElementById('spotify-controls').classList.remove('hidden');
            document.getElementById('radio-controls').classList.add('hidden');
            
            // Останавливаем радио
            const radioPlayer = document.getElementById('radio-player');
            if (radioPlayer) {
                radioPlayer.pause();
                document.getElementById('radio-play-icon').classList.remove('hidden');
                document.getElementById('radio-pause-icon').classList.add('hidden');
            }
        });

        // Обработчики кнопок Spotify (компактные)
        Utils.safeAddEventListener('spotify-compact-connect-btn', 'click', () => {
            // Редирект на Spotify OAuth
            const clientId = 'YOUR_CLIENT_ID'; // Замените на реальный Client ID
            const redirectUri = window.location.origin + window.location.pathname;
            const scopes = 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state';
            
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
            
            window.location.href = authUrl;
        });

        Utils.safeAddEventListener('spotify-compact-play-pause', 'click', () => {
            if (spotifyPlayer) {
                spotifyPlayer.togglePlay();
            }
        });

        Utils.safeAddEventListener('spotify-compact-prev', 'click', () => {
            if (spotifyPlayer) {
                spotifyPlayer.previousTrack();
            }
        });

        Utils.safeAddEventListener('spotify-compact-next', 'click', () => {
            if (spotifyPlayer) {
                spotifyPlayer.nextTrack();
            }
        });

        // Проверяем URL на наличие токена после редиректа
        if (window.location.hash) {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token) {
                spotifyAccessToken = token;
                localStorage.setItem('spotify_access_token', token);
                window.location.hash = ''; // Очищаем URL
                loadSpotifySDK();
            }
        }

        // Функция загрузки новостей
        async function loadNews() {
            const newsContent = document.getElementById('news-content');
            const newsLoading = document.getElementById('news-loading');
            const newsError = document.getElementById('news-error');

            // Определяем язык для новостей
            const newsLanguages = {
                'ru': 'ru',
                'en': 'en',
                'az': 'az'
            };
            const newsLang = newsLanguages[currentLang] || 'en';

            try {
                newsLoading.classList.remove('hidden');
                newsContent.classList.add('hidden');
                newsError.classList.add('hidden');

                // Используем NewsAPI для получения новостей
                // Для демонстрации используем бесплатный API
                const apiKey = 'demo'; // Замените на реальный ключ
                const country = newsLang === 'ru' ? 'ru' : newsLang === 'az' ? 'tr' : 'us';

                // Альтернативный источник - RSS to JSON
                const rssFeeds = {
                    'ru': 'https://www.rbc.ru/v10/ajax/get-news-feed/project/rbcnews.uploaded/lastDate/',
                    'en': 'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
                    'az': 'https://www.trend.az/rss/'
                };

                // Для демонстрации создадим моковые новости
                const mockNews = generateMockNews(newsLang);

                displayNews(mockNews);

                newsLoading.classList.add('hidden');
                newsContent.classList.remove('hidden');

            } catch (error) {
                console.error('[News] Failed to load news:', error);
                newsLoading.classList.add('hidden');
                newsError.classList.remove('hidden');
            }
        }

        // Генерация моковых новостей для демонстрации
        function generateMockNews(lang) {
            const newsTemplates = {
                'ru': [
                    {
                        title: 'Центральный банк повысил ключевую ставку',
                        description: 'Решение принято в рамках борьбы с инфляцией и стабилизации национальной валюты.',
                        source: 'Финансовые новости',
                        time: '2 часа назад',
                        category: 'Экономика'
                    },
                    {
                        title: 'Новые правила налогообложения для малого бизнеса',
                        description: 'Правительство утвердило льготы для предпринимателей с годовым оборотом до 10 млн.',
                        source: 'Бизнес портал',
                        time: '5 часов назад',
                        category: 'Бизнес'
                    },
                    {
                        title: 'Курс доллара достиг нового максимума',
                        description: 'Эксперты прогнозируют дальнейший рост валюты на фоне геополитической напряженности.',
                        source: 'Валютный рынок',
                        time: '1 день назад',
                        category: 'Валюта'
                    }
                ],
                'en': [
                    {
                        title: 'Federal Reserve Raises Interest Rates',
                        description: 'The decision aims to combat inflation and stabilize the economy amid global uncertainty.',
                        source: 'Financial Times',
                        time: '2 hours ago',
                        category: 'Economy'
                    },
                    {
                        title: 'New Tax Benefits for Small Businesses',
                        description: 'Government announces tax relief program for businesses with annual revenue under $10M.',
                        source: 'Business Insider',
                        time: '5 hours ago',
                        category: 'Business'
                    },
                    {
                        title: 'Stock Market Reaches New Heights',
                        description: 'Major indices hit record highs as investor confidence grows in tech sector.',
                        source: 'Market Watch',
                        time: '1 day ago',
                        category: 'Markets'
                    }
                ],
                'az': [
                    {
                        title: 'Mərkəzi Bank faiz dərəcəsini artırdı',
                        description: 'Qərar inflyasiya ilə mübarizə və milli valyutanın sabitləşdirilməsi çərçivəsində qəbul edilib.',
                        source: 'Maliyyə xəbərləri',
                        time: '2 saat əvvəl',
                        category: 'İqtisadiyyat'
                    },
                    {
                        title: 'Kiçik biznes üçün yeni vergi qaydaları',
                        description: 'Hökumət illik dövriyyəsi 10 milyon manata qədər olan sahibkarlar üçün güzəştlər təsdiq edib.',
                        source: 'Biznes portalı',
                        time: '5 saat əvvəl',
                        category: 'Biznes'
                    },
                    {
                        title: 'Dollar kursu yeni maksimuma çatdı',
                        description: 'Ekspertlər geosiyasi gərginlik fonunda valyutanın daha da artacağını proqnozlaşdırırlar.',
                        source: 'Valyuta bazarı',
                        time: '1 gün əvvəl',
                        category: 'Valyuta'
                    }
                ]
            };

            return newsTemplates[lang] || newsTemplates['en'];
        }

        // Отображение новостей
        function displayNews(newsItems) {
            const newsContent = document.getElementById('news-content');

            newsContent.innerHTML = newsItems.map((news, index) => `
                <div class="news-item p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-300 hover:shadow-md cursor-pointer bg-gray-50 dark:bg-gray-800/50">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                            ${index + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300">
                                    ${news.category}
                                </span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${news.time}</span>
                            </div>
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-2 line-clamp-2">
                                ${news.title}
                            </h4>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2 line-clamp-2">
                                ${news.description}
                            </p>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z" clip-rule="evenodd"></path>
                                    </svg>
                                    ${news.source}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Обработчик кнопки обновления новостей
        document.addEventListener('DOMContentLoaded', () => {
            const refreshBtn = document.getElementById('refresh-news-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadNews();
                    if (window.notificationSystem) {
                        notificationSystem.info('Обновление новостей...', { autoClose: 2000 });
                    }
                });
            }
        });

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            // Добавляем ARIA атрибуты для accessibility
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);

            // Объявляем сообщение для screen readers
            if (window.keyboardNav) {
                window.keyboardNav.announceToScreenReader(message, type === 'error');
            }

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showConfirmModal(text) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-modal-text').textContent = text;
                const yesBtn = document.getElementById('confirm-modal-yes');
                const noBtn = document.getElementById('confirm-modal-no');

                const close = () => modal.close();
                const onYes = () => { resolve(true); close(); cleanup(); };
                const onNo = () => { resolve(false); close(); cleanup(); };

                const cleanup = () => {
                    yesBtn.removeEventListener('click', onYes);
                    noBtn.removeEventListener('click', onNo);
                };

                yesBtn.addEventListener('click', onYes, { once: true });
                noBtn.addEventListener('click', onNo, { once: true });
                modal.addEventListener('close', () => { resolve(false); cleanup(); }, { once: true });
                modal.showModal();
            });
        }

        function setupModal(modalId, openBtnId, resetFn) {
            const modal = document.getElementById(modalId); if (!modal) return;
            const openBtn = document.getElementById(openBtnId);
            if (openBtn) openBtn.addEventListener('click', () => { if (resetFn) resetFn(); modal.showModal(); });
            modal.querySelector('.cancel-btn')?.addEventListener('click', () => modal.close());
            modal.querySelector('form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const handler = { 'debt-form': handleDebtFormSubmit, 'debt-payment-form': handleDebtPaymentFormSubmit, 'recurring-expense-form': handleRecurringExpenseFormSubmit, 'expense-form': handleExpenseFormSubmit, 'daily-task-form': handleDailyTaskFormSubmit, 'monthly-task-form': handleMonthlyTaskFormSubmit, 'yearly-task-form': handleYearlyTaskFormSubmit, 'event-form': handleEventFormSubmit }[e.target.id];
                if (handler) handler(e.target);
                modal.close();
            });
        }

        async function handleDebtFormSubmit(form) {
            try {
                const id = form.querySelector('#debt-id').value; const originalPaid = parseFloat(form.dataset.originalPaid || 0); const newPaidAmount = parseFloat(form.querySelector('#debt-paid').value); const name = form.querySelector('#debt-name').value;
                const debtData = { name, totalAmount: parseFloat(form.querySelector('#debt-total').value), paidAmount: newPaidAmount, comment: form.querySelector('#debt-comment').value };
                if (id && newPaidAmount > originalPaid) { debtData.lastPaymentDate = Timestamp.now(); await addDoc(collection(db, `users/${userId}/monthlyData/${currentMonthId}/expenses`), { name: `${translations[currentLang].addDebtPayment}: ${name}`, category: translations[currentLang].debtRepayments, amount: newPaidAmount - originalPaid, date: getTodayISOString(), debtPaymentId: id }); }
                if (!id) {
                    debtData.createdAt = Timestamp.now(); const newDocRef = await addDoc(debtsCol, debtData);
                    if (debtData.paidAmount > 0) { await updateDoc(newDocRef, { lastPaymentDate: Timestamp.now() }); await addDoc(collection(db, `users/${userId}/monthlyData/${currentMonthId}/expenses`), { name: `${translations[currentLang].addDebtPayment}: ${name}`, category: translations[currentLang].debtRepayments, amount: debtData.paidAmount, date: getTodayISOString(), debtPaymentId: newDocRef.id }); }
                } else { await updateDoc(doc(debtsCol, id), debtData); }
                form.dataset.originalPaid = "0"; showToast(translations[currentLang].toastSuccess);
            } catch (error) {
                ErrorHandler.handle(error, 'debt-save', {
                    showToast: true,
                    retryable: true
                });
            }
        }
        async function handleDebtPaymentFormSubmit(form) {
            try {
                const id = form.querySelector('#debt-payment-id').value;
                const amount = parseFloat(form.querySelector('#debt-payment-amount').value);
                showToast(`ID: ${id}, Amount: ${amount}`); // Отладка
                const debtRef = doc(debtsCol, id);
                const debtDoc = await getDoc(debtRef);
                if (debtDoc.exists()) {
                    const debt = debtDoc.data();
                    showToast(`Найден долг: ${debt.name}`); // Отладка
                    await updateDoc(debtRef, { paidAmount: (debt.paidAmount || 0) + amount, lastPaymentDate: Timestamp.now() });
                    await addDoc(collection(db, `users/${userId}/monthlyData/${currentMonthId}/expenses`), { name: `${translations[currentLang].addDebtPayment}: ${debt.name}`, category: translations[currentLang].debtRepayments, amount: amount, date: getTodayISOString(), debtPaymentId: id });
                    showToast(translations[currentLang].toastSuccess);
                } else {
                    showToast(`Долг с ID ${id} не найден`, 'error'); // Отладка
                }
            } catch (error) {
                ErrorHandler.handle(error, 'debt-payment', {
                    showToast: true,
                    retryable: true,
                    critical: false
                });
            }
        }
        async function handleRecurringExpenseFormSubmit(form) {
            try {
                const id = form.querySelector('#recurring-expense-id').value; const data = { name: form.querySelector('#recurring-expense-name').value, amount: parseFloat(form.querySelector('#recurring-expense-amount').value), dueDay: parseInt(form.querySelector('#recurring-expense-due-day').value), details: form.querySelector('#recurring-expense-details').value, }; let docRef;
                if (!id) { data.createdAt = Timestamp.now(); docRef = await addDoc(recurringExpensesCol, data); } else { docRef = doc(recurringExpensesCol, id); await updateDoc(docRef, data); }
                const taskQuery = query(monthlyTasksCol, where("recurringExpenseId", "==", docRef.id), where("month", "==", selectedMonthId));
                const existingTasks = await getDocs(taskQuery); const [year, month] = selectedMonthId.split('-').map(Number); const deadline = `${selectedMonthId}-${String(data.dueDay).padStart(2, '0')}`;
                const taskData = { name: `${data.name}`, deadline, status: translations.ru.statusNotDone, recurringExpenseId: docRef.id, month: selectedMonthId, year: year, };
                if (existingTasks.empty) await addDoc(monthlyTasksCol, taskData); else await updateDoc(existingTasks.docs[0].ref, taskData);
                showToast(translations[currentLang].toastSuccess);
            } catch (error) {
                ErrorHandler.handle(error, 'recurring-expense-save', {
                    showToast: true,
                    retryable: true
                });
            }
        }
        async function handleExpenseFormSubmit(form) {
            try {
                const id = form.querySelector('#expense-id').value;
                const expenseData = {
                    name: form.querySelector('#expense-name').value,
                    category: form.querySelector('#expense-category').value,
                    amount: parseFloat(form.querySelector('#expense-amount').value),
                    date: form.querySelector('#expense-date').value,
                };
                const newMonthId = expenseData.date.slice(0, 7);

                if (!id) {
                    const targetCol = collection(db, `users/${userId}/monthlyData/${newMonthId}/expenses`);
                    await addDoc(targetCol, expenseData);

                    // Если расход добавлен в другой месяц, переключаемся на него и обновляем подписки
                    if (newMonthId !== selectedMonthId) {
                        selectedMonthId = newMonthId;
                        const [year, month] = selectedMonthId.split('-').map(Number);
                        calendarDate = new Date(year, month - 1, 1);
                        updateMonthDisplay();
                        attachListeners();
                    }
                } else {
                    const originalDocRef = doc(expensesCol, id);
                    const originalDocSnap = await getDoc(originalDocRef);

                    if (originalDocSnap.exists()) {
                        const originalData = originalDocSnap.data();
                        if (originalData.date.slice(0, 7) !== newMonthId) {
                            const newTargetCol = collection(db, `users/${userId}/monthlyData/${newMonthId}/expenses`);
                            const batch = writeBatch(db);
                            batch.delete(originalDocRef);
                            batch.set(doc(newTargetCol), expenseData);
                            await batch.commit();

                            // Переключаемся на месяц расхода
                            selectedMonthId = newMonthId;
                            const [year, month] = selectedMonthId.split('-').map(Number);
                            calendarDate = new Date(year, month - 1, 1);
                            updateMonthDisplay();
                            attachListeners();
                        } else {
                            await updateDoc(originalDocRef, expenseData);
                        }
                    }
                }
                showToast(translations[currentLang].toastSuccess);
            } catch (error) {
                ErrorHandler.handle(error, 'expense-save', {
                    showToast: true,
                    retryable: true
                });
            }
        }
        const handleTaskSubmit = async (col, id, data) => {
            try { if (!id) await addDoc(col, { ...data, createdAt: Timestamp.now(), status: translations.ru.statusNotDone }); else await updateDoc(doc(col, id), data); showToast(translations[currentLang].toastSuccess); }
            catch (error) {
                ErrorHandler.handle(error, 'task-save', {
                    showToast: true,
                    retryable: true
                });
            }
        };
        const handleDailyTaskFormSubmit = (form) => handleTaskSubmit(dailyTasksCol, form.querySelector('#daily-task-id').value, { name: form.querySelector('#daily-task-name').value, notes: form.querySelector('#daily-task-notes').value });
        const handleMonthlyTaskFormSubmit = (form) => handleTaskSubmit(monthlyTasksCol, form.querySelector('#monthly-task-id').value, { name: form.querySelector('#monthly-task-name').value, deadline: form.querySelector('#monthly-task-deadline').value, month: form.querySelector('#monthly-task-deadline').value.slice(0, 7), year: new Date(form.querySelector('#monthly-task-deadline').value).getFullYear() });
        const handleYearlyTaskFormSubmit = (form) => handleTaskSubmit(yearlyTasksCol, form.querySelector('#yearly-task-id').value, { name: form.querySelector('#yearly-task-name').value, deadline: form.querySelector('#yearly-task-deadline').value, notes: form.querySelector('#yearly-task-notes').value, year: new Date(form.querySelector('#yearly-task-deadline').value).getFullYear() });

        async function handleEventFormSubmit(form) {
            try {
                const id = form.querySelector('#event-id').value; const category = form.querySelector('#event-category').value; const t = translations[currentLang]; const data = { category, date: form.querySelector('#event-date').value }; let taskName = '';
                switch (category) {
                    case 'birthday': const birthdayName = form.querySelector('#event-birthday-name').value; const birthYear = form.querySelector('#event-birthday-year').value; data.birthdayName = birthdayName; data.birthYear = birthYear; data.name = `${t.categoryBirthday}: ${birthdayName}`; taskName = `${t.taskCongratulate} ${birthdayName}`; if (birthYear) { const age = new Date(data.date).getFullYear() - parseInt(birthYear); if (age >= 0) taskName += ` (${t.taskTurning} ${age} ${t.taskYearsOld})`; } break;
                    case 'meeting': const meetingWith = form.querySelector('#event-meeting-with').value; const meetingTime = form.querySelector('#event-meeting-time').value; const meetingPlace = form.querySelector('#event-meeting-place').value; data.meetingWith = meetingWith; data.meetingTime = meetingTime; data.meetingPlace = meetingPlace; data.name = `${t.categoryMeeting}: ${meetingWith}`; taskName = `${t.taskMeetWith} ${meetingWith}`; if (meetingTime) taskName += ` в ${meetingTime}`; if (meetingPlace) taskName += ` в ${meetingPlace}`; break;
                    case 'wedding': const weddingNames = form.querySelector('#event-wedding-names').value; data.weddingNames = weddingNames; data.name = `${t.categoryWedding}: ${weddingNames}`; taskName = `${t.taskWeddingOf} ${weddingNames}`; break;
                    default: data.name = form.querySelector('#event-name-generic').value; taskName = data.name; break;
                }
                let eventId = id; if (id) { await updateDoc(doc(calendarEventsCol, id), data); } else { const newDoc = await addDoc(calendarEventsCol, data); eventId = newDoc.id; }
                if (!eventId) return;
                const shouldCreateTask = form.querySelector('#event-create-task').checked;
                const taskQuery = query(monthlyTasksCol, where("fromCalendar", "==", eventId)); const existingTasksSnapshot = await getDocs(taskQuery); const existingTaskDoc = existingTasksSnapshot.docs[0];
                const taskData = { name: taskName, deadline: data.date, status: translations.ru.statusNotDone, month: data.date.slice(0, 7), year: parseInt(data.date.slice(0, 4)), fromCalendar: eventId };
                if (shouldCreateTask) {
                    if (existingTaskDoc) await updateDoc(existingTaskDoc.ref, taskData);
                    else await addDoc(monthlyTasksCol, taskData);
                    const newMonthId = data.date.slice(0, 7);
                    if (newMonthId !== selectedMonthId) {
                        selectedMonthId = newMonthId;
                        const [year, month] = selectedMonthId.split('-').map(Number);
                        calendarDate = new Date(year, month - 1, 1);
                        updateMonthDisplay();
                        attachListeners();
                    }
                    document.querySelector('.tab-button[data-tab="tasks"]').click();
                }
                else { if (existingTaskDoc) await deleteDoc(existingTaskDoc.ref); }
                showToast(translations[currentLang].toastSuccess);
            } catch (error) {
                ErrorHandler.handle(error, 'event-save', {
                    showToast: true,
                    retryable: true
                });
            }
        };
        async function handleCategoryFormSubmit(form) { const nameInput = form.querySelector('#category-name'); const name = nameInput.value.trim(); if (name) { await addDoc(categoriesCol, { name: name, lang: currentLang }); nameInput.value = ''; showToast(translations[currentLang].toastSuccess); } }

        setupModal('debt-modal', 'add-debt-btn', () => { document.getElementById('debt-form').reset(); document.getElementById('debt-id').value = ''; document.getElementById('debt-modal-title').textContent = translations[currentLang].addDebt; });
        setupModal('recurring-expense-modal', 'add-recurring-expense-btn', () => { document.getElementById('recurring-expense-form').reset(); document.getElementById('recurring-expense-id').value = ''; document.getElementById('recurring-expense-modal-title').textContent = translations[currentLang].addTemplate; });
        setupModal('expense-modal', 'add-expense-btn', () => {
            document.getElementById('expense-form').reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-date').value = `${selectedMonthId}-01`;
            document.getElementById('expense-modal-title').textContent = translations[currentLang].addExpense;
        });
        setupModal('daily-task-modal', 'add-daily-task-btn', () => { document.getElementById('daily-task-form').reset(); document.getElementById('daily-task-id').value = ''; document.getElementById('daily-task-modal-title').textContent = translations[currentLang].addTaskForToday; });
        setupModal('monthly-task-modal', 'add-monthly-task-btn', () => { document.getElementById('monthly-task-form').reset(); document.getElementById('monthly-task-id').value = ''; document.getElementById('monthly-task-modal-title').textContent = translations[currentLang].addTaskForMonth; });
        setupModal('yearly-task-modal', 'add-yearly-task-btn', () => { document.getElementById('yearly-task-form').reset(); document.getElementById('yearly-task-id').value = ''; document.getElementById('yearly-task-modal-title').textContent = translations[currentLang].addTaskForYear; });
        setupModal('category-modal', 'manage-categories-btn');
        setupModal('event-modal');
        Utils.safeAddEventListener('category-form', 'submit', (e) => { e.preventDefault(); handleCategoryFormSubmit(e.target); });

        function setCurrency(currency) {
            currentCurrency = currency; localStorage.setItem('currency', currency);
            document.getElementById('currency-azn').classList.toggle('currency-btn-active', currency === 'AZN');
            document.getElementById('currency-usd').classList.toggle('currency-btn-active', currency === 'USD');
            document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = currentCurrency);
            if (userId) { renderDebts(allDebts); renderRecurringExpenses(); renderExpenses(allExpenses); updateDashboard(); }
        }
        Utils.safeAddEventListener('currency-azn', 'click', () => setCurrency('AZN'));
        Utils.safeAddEventListener('currency-usd', 'click', () => setCurrency('USD'));
        setCurrency(currentCurrency);

        const authForm = document.getElementById('auth-form'); const authError = document.getElementById('auth-error');
        document.getElementById('login-btn')?.addEventListener('click', async (e) => {
            e.preventDefault(); const email = authForm.email.value; const password = authForm.password.value; authError.textContent = '';
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) {
                const errorInfo = ErrorHandler.handle(error, 'auth-login', {
                    showToast: false,
                    logToConsole: true
                });
                const t = translations[currentLang];
                authError.textContent = {
                    'auth/invalid-email': t.authInvalidEmail,
                    'auth/user-not-found': t.authInvalidCredentials,
                    'auth/wrong-password': t.authInvalidCredentials,
                    'auth/invalid-credential': t.authInvalidCredentials
                }[error.code] || t.authGenericError;
            }
        });
        document.getElementById('register-btn')?.addEventListener('click', async () => {
            const email = authForm.email.value; const password = authForm.password.value; authError.textContent = '';
            try { await createUserWithEmailAndPassword(auth, email, password); }
            catch (error) {
                ErrorHandler.handle(error, 'auth-register', {
                    showToast: false,
                    logToConsole: true
                });
                const t = translations[currentLang];
                authError.textContent = {
                    'auth/invalid-email': t.authInvalidEmail,
                    'auth/email-already-in-use': t.authEmailInUse,
                    'auth/weak-password': t.authWeakPassword
                }[error.code] || t.authGenericError;
            }
        });
        document.getElementById('google-signin-btn')?.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, new GoogleAuthProvider());
            } catch (error) {
                ErrorHandler.handle(error, 'auth-google', {
                    showToast: false,
                    logToConsole: true
                });
                authError.textContent = translations[currentLang].authGenericError;
            }
        });
        document.getElementById('logout-btn')?.addEventListener('click', async () => await signOut(auth));

        document.getElementById('app').addEventListener('click', async (e) => {
            const target = e.target; const id = target.dataset.id || target.closest('[data-id]')?.dataset.id; if (!id) return;
            const t = translations[currentLang];
            const confirm = () => showConfirmModal(t.deleteConfirm);

            if (target.closest('.delete-category-btn')) { if (await confirm()) { await deleteDoc(doc(categoriesCol, id)); showToast(t.toastDeleted); } }
            else if (target.classList.contains('edit-debt-btn')) { const debt = (await getDoc(doc(debtsCol, id))).data(); const form = document.getElementById('debt-form'); form.dataset.originalPaid = debt.paidAmount || 0; form.querySelector('#debt-id').value = id; form.querySelector('#debt-name').value = debt.name; form.querySelector('#debt-total').value = debt.totalAmount; form.querySelector('#debt-paid').value = debt.paidAmount; form.querySelector('#debt-comment').value = debt.comment; document.getElementById('debt-modal-title').textContent = t.editDebt; document.getElementById('debt-modal').showModal(); }
            else if (target.classList.contains('delete-debt-btn') && await confirm()) { await deleteDoc(doc(debtsCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('add-debt-payment-btn')) { document.getElementById('debt-payment-id').value = id; document.getElementById('debt-payment-form').reset(); document.getElementById('debt-payment-modal').showModal(); }
            else if (target.classList.contains('edit-recurring-expense-btn')) { const expense = (await getDoc(doc(recurringExpensesCol, id))).data(); const form = document.getElementById('recurring-expense-form'); form.querySelector('#recurring-expense-id').value = id; form.querySelector('#recurring-expense-name').value = expense.name; form.querySelector('#recurring-expense-amount').value = expense.amount; form.querySelector('#recurring-expense-due-day').value = expense.dueDay; form.querySelector('#recurring-expense-details').value = expense.details; document.getElementById('recurring-expense-modal-title').textContent = t.editTemplate; document.getElementById('recurring-expense-modal').showModal(); }
            else if (target.classList.contains('delete-recurring-expense-btn') && await confirm()) { await deleteDoc(doc(recurringExpensesCol, id)); const q = query(monthlyTasksCol, where("recurringExpenseId", "==", id)); const tasksToDelete = await getDocs(q); const batch = writeBatch(db); tasksToDelete.forEach(d => batch.delete(d.ref)); await batch.commit(); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-expense-btn')) { const expenseDoc = await getDoc(doc(expensesCol, id)); if (!expenseDoc.exists()) return; const expense = expenseDoc.data(); const form = document.getElementById('expense-form'); form.querySelector('#expense-id').value = id; form.querySelector('#expense-name').value = expense.name; form.querySelector('#expense-category').value = expense.category; form.querySelector('#expense-amount').value = expense.amount; form.querySelector('#expense-date').value = expense.date; document.getElementById('expense-modal-title').textContent = t.editExpense; document.getElementById('expense-modal').showModal(); }
            else if (target.classList.contains('delete-expense-btn') && await confirm()) { await deleteDoc(doc(expensesCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-daily-task-btn')) { const task = (await getDoc(doc(dailyTasksCol, id))).data(); const form = document.getElementById('daily-task-form'); form.querySelector('#daily-task-id').value = id; form.querySelector('#daily-task-name').value = task.name; form.querySelector('#daily-task-notes').value = task.notes; document.getElementById('daily-task-modal-title').textContent = t.editTask; document.getElementById('daily-task-modal').showModal(); }
            else if (target.classList.contains('delete-daily-task-btn') && await confirm()) { await deleteDoc(doc(dailyTasksCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-monthly-task-btn')) { const task = (await getDoc(doc(monthlyTasksCol, id))).data(); const form = document.getElementById('monthly-task-form'); form.querySelector('#monthly-task-id').value = id; form.querySelector('#monthly-task-name').value = task.name; form.querySelector('#monthly-task-deadline').value = task.deadline; document.getElementById('monthly-task-modal-title').textContent = t.editTask; document.getElementById('monthly-task-modal').showModal(); }
            else if (target.classList.contains('delete-monthly-task-btn') && await confirm()) { await deleteDoc(doc(monthlyTasksCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-yearly-task-btn')) { const task = (await getDoc(doc(yearlyTasksCol, id))).data(); const form = document.getElementById('yearly-task-form'); form.querySelector('#yearly-task-id').value = id; form.querySelector('#yearly-task-name').value = task.name; form.querySelector('#yearly-task-deadline').value = task.deadline; form.querySelector('#yearly-task-notes').value = task.notes; document.getElementById('yearly-task-modal-title').textContent = t.editTask; document.getElementById('yearly-task-modal').showModal(); }
            else if (target.classList.contains('delete-yearly-task-btn') && await confirm()) { await deleteDoc(doc(yearlyTasksCol, id)); showToast(t.toastDeleted); }
            else if (target.id === 'delete-event-btn') { const eventId = document.getElementById('event-id').value; if (eventId && await confirm()) { await deleteDoc(doc(calendarEventsCol, eventId)); const taskQuery = query(monthlyTasksCol, where("fromCalendar", "==", eventId)); const tasksSnapshot = await getDocs(taskQuery); const batch = writeBatch(db); tasksSnapshot.forEach(d => batch.delete(d.ref)); await batch.commit(); document.getElementById('event-modal').close(); showToast(t.toastDeleted); } }
        });

        // Radio Player Logic
        const radioPlayer = document.getElementById('radio-player');
        const playPauseBtn = document.getElementById('radio-play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const volumeSlider = document.getElementById('radio-volume-slider');

        playPauseBtn.addEventListener('click', () => {
            if (radioPlayer.paused) {
                radioPlayer.play().catch(e => console.error("Radio play error:", e));
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');

                // Обновляем ARIA состояния
                playPauseBtn.setAttribute('aria-pressed', 'true');
                playPauseBtn.setAttribute('aria-label', 'Остановить радио AzerbaiJazz');

                // Объявляем изменение для screen readers
                if (window.keyboardNav) {
                    window.keyboardNav.announceToScreenReader('Радио воспроизводится');
                }
            } else {
                radioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');

                // Обновляем ARIA состояния
                playPauseBtn.setAttribute('aria-pressed', 'false');
                playPauseBtn.setAttribute('aria-label', 'Воспроизвести радио AzerbaiJazz');

                // Объявляем изменение для screen readers
                if (window.keyboardNav) {
                    window.keyboardNav.announceToScreenReader('Радио остановлено');
                }
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            radioPlayer.volume = volume;

            // Обновляем ARIA атрибуты
            const percentage = Math.round(volume * 100);
            e.target.setAttribute('aria-valuenow', volume);
            e.target.setAttribute('aria-valuetext', `${percentage}%`);
        });

        // Встроенные дополнительные системы для работы без CORS

        // Performance Monitor - встроенная версия
        class PerformanceMonitor {
            constructor() {
                this.metrics = {
                    pageLoad: null,
                    firstContentfulPaint: null,
                    largestContentfulPaint: null,
                    memoryUsage: null
                };
                this.init();
            }

            init() {
                this.measurePageLoad();
                this.measureWebVitals();
                this.monitorMemoryUsage();
            }

            measurePageLoad() {
                window.addEventListener('load', () => {
                    const navigation = performance.getEntriesByType('navigation')[0];
                    if (navigation) {
                        this.metrics.pageLoad = {
                            totalTime: navigation.loadEventEnd - navigation.fetchStart,
                            domProcessing: navigation.domComplete - navigation.domLoading
                        };
                    }
                });
            }

            measureWebVitals() {
                try {
                    new PerformanceObserver((list) => {
                        const entries = list.getEntries();
                        const fcp = entries.find(entry => entry.name === 'first-contentful-paint');
                        if (fcp) this.metrics.firstContentfulPaint = fcp.startTime;
                    }).observe({ type: 'paint', buffered: true });
                } catch (e) {
                    console.warn('[Performance] Web Vitals not supported');
                }
            }

            monitorMemoryUsage() {
                if ('memory' in performance) {
                    setInterval(() => {
                        this.metrics.memoryUsage = {
                            used: performance.memory.usedJSHeapSize,
                            total: performance.memory.totalJSHeapSize,
                            percentage: (performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit) * 100
                        };
                    }, 30000);
                }
            }

            startMeasure(name) {
                performance.mark(`${name}-start`);
            }

            endMeasure(name) {
                try {
                    performance.mark(`${name}-end`);
                    performance.measure(name, `${name}-start`, `${name}-end`);
                    const measure = performance.getEntriesByName(name, 'measure')[0];
                    return measure ? measure.duration : null;
                } catch (error) {
                    return null;
                }
            }

            getCurrentMetrics() {
                return { ...this.metrics, timestamp: Date.now() };
            }

            getPerformanceReport() {
                return {
                    timestamp: Date.now(),
                    metrics: { ...this.metrics },
                    recommendations: this.generateRecommendations()
                };
            }

            generateRecommendations() {
                const recommendations = [];
                if (this.metrics.firstContentfulPaint > 2500) {
                    recommendations.push({
                        type: 'warning',
                        metric: 'FCP',
                        message: 'First Contentful Paint медленный'
                    });
                }
                return recommendations;
            }

            trackPerformance(metric, value) {
                console.log(`[Performance] ${metric}: ${value}`);
            }
        }

        // Notification System - встроенная версия
        class NotificationSystem {
            constructor() {
                this.notifications = [];
                this.settings = {
                    enabled: true,
                    position: 'top-right',
                    autoClose: 5000,
                    maxNotifications: 5
                };
                this.init();
            }

            init() {
                this.createContainer();
            }

            createContainer() {
                if (document.getElementById('notification-container')) return;
                const container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none';
                document.body.appendChild(container);
            }

            show(message, type = 'info', options = {}) {
                if (!this.settings.enabled) return null;

                const notification = this.createNotification(message, type, options);
                this.addNotification(notification);
                return notification;
            }

            createNotification(message, type, options) {
                const id = `notification-${Date.now()}`;
                const autoClose = options.autoClose !== undefined ? options.autoClose : this.settings.autoClose;

                const element = document.createElement('div');
                element.id = id;
                element.className = `pointer-events-auto w-full max-w-sm bg-white rounded-lg shadow-lg border p-4 transform transition-all duration-300 ease-in-out opacity-0 translate-x-full ${this.getTypeClasses(type)}`;

                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? 'text-white' : 'text-gray-900';
                const closeColor = isDark ? 'text-gray-400 hover:text-gray-200' : 'text-gray-400 hover:text-gray-600';

                element.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">${this.getIcon(type)}</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium ${textColor}">${message}</p>
                        </div>
                        <button onclick="window.notificationSystem?.close('${id}')" class="flex-shrink-0 ${closeColor}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;

                const notification = { id, element, timeout: null };

                if (autoClose > 0) {
                    notification.timeout = setTimeout(() => this.close(id), autoClose);
                }

                return notification;
            }

            getTypeClasses(type) {
                const isDark = document.documentElement.classList.contains('dark');

                if (isDark) {
                    const darkClasses = {
                        success: 'border-green-500 bg-green-900/30',
                        error: 'border-red-500 bg-red-900/30',
                        warning: 'border-yellow-500 bg-yellow-900/30',
                        info: 'border-blue-500 bg-blue-900/30'
                    };
                    return darkClasses[type] || darkClasses.info;
                }

                const classes = {
                    success: 'border-green-200 bg-white',
                    error: 'border-red-200 bg-white',
                    warning: 'border-yellow-200 bg-white',
                    info: 'border-blue-200 bg-white'
                };
                return classes[type] || classes.info;
            }

            getIcon(type) {
                const isDark = document.documentElement.classList.contains('dark');

                if (isDark) {
                    const darkIcons = {
                        success: '<div class="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>',
                        error: '<div class="w-6 h-6 bg-red-500/20 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>',
                        warning: '<div class="w-6 h-6 bg-yellow-500/20 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></div>',
                        info: '<div class="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></div>'
                    };
                    return darkIcons[type] || darkIcons.info;
                }

                const icons = {
                    success: '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>',
                    error: '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>',
                    warning: '<div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></div>',
                    info: '<div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></div>'
                };
                return icons[type] || icons.info;
            }

            addNotification(notification) {
                const container = document.getElementById('notification-container');
                if (!container) return;

                while (this.notifications.length >= this.settings.maxNotifications) {
                    const oldest = this.notifications.shift();
                    this.removeNotificationElement(oldest);
                }

                this.notifications.push(notification);
                container.appendChild(notification.element);

                requestAnimationFrame(() => {
                    notification.element.classList.remove('opacity-0', 'translate-x-full');
                    notification.element.classList.add('opacity-100', 'translate-x-0');
                });
            }

            close(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (!notification) return;

                if (notification.timeout) clearTimeout(notification.timeout);

                notification.element.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => this.removeNotificationElement(notification), 300);
            }

            removeNotificationElement(notification) {
                if (notification.element && notification.element.parentNode) {
                    notification.element.parentNode.removeChild(notification.element);
                }
                const index = this.notifications.indexOf(notification);
                if (index > -1) this.notifications.splice(index, 1);
            }

            success(message, options = {}) { return this.show(message, 'success', options); }
            error(message, options = {}) { return this.show(message, 'error', options); }
            warning(message, options = {}) { return this.show(message, 'warning', options); }
            info(message, options = {}) { return this.show(message, 'info', options); }

            getStats() {
                return {
                    active: this.notifications.length,
                    settings: { ...this.settings }
                };
            }

            updateSettings(newSettings) {
                this.settings = { ...this.settings, ...newSettings };
            }
        }

        // Cache Manager - встроенная версия
        class CacheManager {
            constructor() {
                this.memoryCache = new Map();
                this.config = { defaultTTL: 5 * 60 * 1000, maxMemorySize: 50 };
                this.stats = { hits: 0, misses: 0, sets: 0 };
            }

            set(key, value, options = {}) {
                const ttl = options.ttl || this.config.defaultTTL;
                const entry = {
                    value,
                    timestamp: Date.now(),
                    ttl
                };

                if (this.memoryCache.size >= this.config.maxMemorySize) {
                    const firstKey = this.memoryCache.keys().next().value;
                    this.memoryCache.delete(firstKey);
                }

                this.memoryCache.set(key, entry);
                this.stats.sets++;
                return true;
            }

            get(key) {
                const entry = this.memoryCache.get(key);
                if (!entry) {
                    this.stats.misses++;
                    return null;
                }

                if (this.isExpired(entry)) {
                    this.memoryCache.delete(key);
                    this.stats.misses++;
                    return null;
                }

                this.stats.hits++;
                return entry.value;
            }

            isExpired(entry) {
                return entry.ttl && (Date.now() - entry.timestamp > entry.ttl);
            }

            delete(key) {
                return this.memoryCache.delete(key);
            }

            clear() {
                this.memoryCache.clear();
            }

            memoize(fn, options = {}) {
                const cache = this;
                return function (...args) {
                    const key = `${fn.name}_${JSON.stringify(args)}`;
                    let result = cache.get(key);
                    if (result !== null) return result;

                    result = fn.apply(this, args);
                    cache.set(key, result, options);
                    return result;
                };
            }

            getStats() {
                return {
                    ...this.stats,
                    memorySize: this.memoryCache.size,
                    hitRate: this.stats.hits / (this.stats.hits + this.stats.misses) || 0
                };
            }
        }

        // Analytics Manager - встроенная версия
        class AnalyticsManager {
            constructor() {
                this.events = [];
                this.config = { enabled: true, maxEvents: 1000 };
                this.sessionId = `session_${Date.now()}`;
                this.init();
            }

            init() {
                if (navigator.doNotTrack === '1') {
                    this.config.enabled = false;
                    return;
                }
                this.setupEventTracking();
            }

            track(eventName, properties = {}) {
                if (!this.config.enabled) return;

                const event = {
                    name: eventName,
                    properties: {
                        ...properties,
                        sessionId: this.sessionId,
                        timestamp: Date.now(),
                        url: window.location.href
                    }
                };

                this.events.push(event);
                if (this.events.length > this.config.maxEvents) {
                    this.events.shift();
                }
            }

            trackError(error, context = {}) {
                this.track('error', {
                    message: error.message,
                    stack: error.stack,
                    context
                });
            }

            trackPerformance(metric, value) {
                this.track('performance', { metric, value });
            }

            trackCustom(eventName, properties = {}) {
                this.track(`custom_${eventName}`, properties);
            }

            setupEventTracking() {
                document.addEventListener('click', (event) => {
                    this.track('click', {
                        tagName: event.target.tagName,
                        id: event.target.id,
                        className: event.target.className
                    });
                });

                window.addEventListener('error', (event) => {
                    this.trackError(event.error);
                });
            }

            getStats() {
                return {
                    eventsCount: this.events.length,
                    sessionId: this.sessionId,
                    config: { ...this.config }
                };
            }

            getUsageReport() {
                return {
                    totalEvents: this.events.length,
                    clicks: this.events.filter(e => e.name === 'click').length,
                    errors: this.events.filter(e => e.name === 'error').length
                };
            }

            exportData() {
                return {
                    events: this.events,
                    sessionId: this.sessionId,
                    exportDate: new Date().toISOString()
                };
            }

            setEnabled(enabled) {
                this.config.enabled = enabled;
            }
        }

        // Theme Manager - встроенная версия
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('app-theme') || 'light';
                this.init();
            }

            init() {
                this.applyTheme(this.currentTheme);
                this.setupThemeToggle();
                this.setupSystemThemeListener();
            }

            applyTheme(theme) {
                const root = document.documentElement;

                if (theme === 'dark') {
                    root.classList.add('dark');
                    root.classList.remove('light');
                } else {
                    root.classList.add('light');
                    root.classList.remove('dark');
                }

                this.currentTheme = theme;
                localStorage.setItem('app-theme', theme);
                this.updateThemeToggleIcon();
            }

            toggleTheme() {
                const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme(newTheme);
            }

            getCurrentTheme() {
                return this.currentTheme;
            }

            isDarkTheme() {
                return this.currentTheme === 'dark';
            }

            setupThemeToggle() {
                const themeToggle = document.createElement('button');
                themeToggle.id = 'theme-toggle';
                themeToggle.className = 'w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200';
                themeToggle.setAttribute('aria-label', 'Переключить тему');

                themeToggle.innerHTML = `
                    <svg class="sun-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                `;

                themeToggle.addEventListener('click', () => this.toggleTheme());

                const controlPanel = document.querySelector('.fixed.top-4.right-4 .flex');
                if (controlPanel) {
                    controlPanel.insertBefore(themeToggle, controlPanel.firstChild);
                }
            }

            updateThemeToggleIcon() {
                const sunIcon = document.querySelector('.sun-icon');
                const moonIcon = document.querySelector('.moon-icon');

                if (sunIcon && moonIcon) {
                    if (this.currentTheme === 'dark') {
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                    } else {
                        sunIcon.classList.add('hidden');
                        moonIcon.classList.remove('hidden');
                    }
                }
            }

            setupSystemThemeListener() {
                if (!localStorage.getItem('app-theme')) {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    this.applyTheme(prefersDark ? 'dark' : 'light');
                }

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('app-theme-manual')) {
                        this.applyTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        }

        // PWA Manager - встроенная версия
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.isInstalled = false;
                this.init();
            }

            init() {
                this.checkInstallation();
                this.setupInstallPrompt();
                this.registerServiceWorker();
            }

            checkInstallation() {
                this.isInstalled =
                    window.matchMedia('(display-mode: standalone)').matches ||
                    window.navigator.standalone === true;
            }

            setupInstallPrompt() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });

                window.addEventListener('appinstalled', () => {
                    this.isInstalled = true;
                    this.hideInstallButton();
                });
            }

            showInstallButton() {
                const installButton = document.createElement('button');
                installButton.id = 'pwa-install-btn';
                installButton.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 z-50';
                installButton.textContent = 'Установить ORDINA';

                installButton.addEventListener('click', () => this.installApp());
                document.body.appendChild(installButton);
            }

            hideInstallButton() {
                const installButton = document.getElementById('pwa-install-btn');
                if (installButton) installButton.remove();
            }

            async installApp() {
                if (!this.deferredPrompt) return;

                try {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;

                    if (outcome === 'accepted') {
                        console.log('[PWA] User accepted install');
                    }

                    this.deferredPrompt = null;
                    this.hideInstallButton();
                } catch (error) {
                    console.error('[PWA] Install failed:', error);
                }
            }

            async registerServiceWorker() {
                // Service Worker не работает с file:// протоколом
                if (window.location.protocol === 'file:') {
                    console.log('[PWA] Service Worker not available for file:// protocol');
                    return;
                }

                if ('serviceWorker' in navigator) {
                    try {
                        // Принудительное обновление Service Worker
                        const registration = await navigator.serviceWorker.register('./sw.js', {
                            updateViaCache: 'none'
                        });
                        console.log('[PWA] Service Worker registered:', registration);
                        this.swRegistration = registration;
                        
                        // Проверяем обновления каждые 60 секунд
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                        
                        // Обработка обновлений
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New Service Worker available! Reload to update.');
                                    // Можно показать уведомление пользователю
                                    if (window.notificationSystem) {
                                        window.notificationSystem.show('Доступно обновление! Обновите страницу.', 'info');
                                    }
                                }
                            });
                        });
                    } catch (error) {
                        console.warn('[PWA] Service Worker registration failed:', error.message);
                    }
                } else {
                    console.log('[PWA] Service Worker not supported in this browser');
                }
            }

            getPWAInfo() {
                return {
                    isInstalled: this.isInstalled,
                    canInstall: !!this.deferredPrompt,
                    hasServiceWorker: !!this.swRegistration,
                    isOnline: navigator.onLine,
                    protocol: window.location.protocol,
                    serviceWorkerSupported: 'serviceWorker' in navigator && window.location.protocol !== 'file:'
                };
            }
        }

        // Инициализация дополнительных систем
        let performanceMonitor, notificationSystem, cacheManager, analyticsManager, themeManager, pwaManager;

        // Инициализация после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Инициализация систем
                performanceMonitor = new PerformanceMonitor();
                notificationSystem = new NotificationSystem();
                cacheManager = new CacheManager();
                analyticsManager = new AnalyticsManager();
                themeManager = new ThemeManager();
                pwaManager = new PWAManager();

                // Глобальная доступность
                window.performanceMonitor = performanceMonitor;
                window.notificationSystem = notificationSystem;
                window.cacheManager = cacheManager;
                window.analyticsManager = analyticsManager;
                window.themeManager = themeManager;
                window.pwaManager = pwaManager;

                // Отслеживание загрузки приложения
                analyticsManager.track('app_loaded', {
                    loadTime: performance.now(),
                    feature: 'app_initialization'
                });

                // Показываем уведомление о готовности
                setTimeout(() => {
                    const isFileProtocol = window.location.protocol === 'file:';
                    const message = isFileProtocol
                        ? 'ORDINA готов к работе! (локальный режим)'
                        : 'ORDINA готов к работе!';

                    notificationSystem.success(message, {
                        autoClose: 3000
                    });
                }, 1000);

                console.log('[ORDINA] All systems initialized successfully');

            } catch (error) {
                console.error('[ORDINA] Failed to initialize systems:', error);

                // Показываем ошибку пользователю
                if (window.showToast) {
                    showToast('Ошибка инициализации системы', 'error');
                }
            }
        });

        // Интеграция с существующими функциями
        const originalShowToast = window.showToast;
        window.showToast = function (message, type = 'success') {
            // Используем новую систему уведомлений если доступна
            if (window.notificationSystem) {
                window.notificationSystem.show(message, type);
            } else {
                // Fallback к старой системе
                if (originalShowToast) {
                    originalShowToast(message, type);
                }
            }
        };

        // Кэширование данных Firebase
        const originalGetDocs = window.getDocs;
        if (originalGetDocs && window.cacheManager) {
            window.getDocs = cacheManager.memoizeAsync(originalGetDocs, {
                key: 'firebase_query',
                ttl: 2 * 60 * 1000, // 2 минуты
                storage: 'memory'
            });
        }

        // Отслеживание производительности Firebase операций
        const trackFirebaseOperation = (operation, startTime) => {
            const duration = performance.now() - startTime;
            if (window.performanceMonitor) {
                performanceMonitor.trackPerformance(`firebase_${operation}`, duration);
            }
            if (window.analyticsManager) {
                analyticsManager.track('firebase_operation', {
                    operation,
                    duration,
                    feature: 'database'
                });
            }
        };

        // Обработка ошибок с аналитикой
        const originalErrorHandler = window.ErrorHandler?.handle;
        if (originalErrorHandler) {
            window.ErrorHandler.handle = function (error, context, options) {
                // Отслеживаем ошибку в аналитике
                if (window.analyticsManager) {
                    analyticsManager.trackError(error, { context, ...options });
                }

                // Вызываем оригинальный обработчик
                return originalErrorHandler.call(this, error, context, options);
            };
        }

    </script>
</body>

</html>