<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORDINA ✨ Ultra-Modern Command Center</title>

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="ORDINA - Premium personal finance and life management suite. Track expenses, manage debts, organize tasks, and stay informed with integrated weather and news.">
    <meta name="keywords"
        content="finance, budget, expense tracker, debt management, task manager, calendar, personal assistant">
    <meta name="author" content="ORDINA">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="ORDINA • Personal Command Center">
    <meta property="og:description"
        content="Manage your life with ease - Premium financial suite with expense tracking, debt management, and productivity tools">
    <meta property="og:site_name" content="ORDINA">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png">
    <link rel="icon" type="image/png" sizes="64x64" href="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png">
    <link rel="icon" type="image/png" sizes="128x128" href="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"
        integrity="sha512-a6XN0PbgXCEgKLF0hoF3eWD1QZ3XkMtIOZB8H+aVRC6LOhIPltoMrR0pbw/I8G5pWqvtgiIUbBs7P1d3e2xF3g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script>
        // Отключаем предупреждение о production для Tailwind Play CDN
        tailwind.config = {
            important: true,
            corePlugins: {
                preflight: true,
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Ultra-Modern Palette - Vibrant Gradients */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #a855f7;
            --cyan: #06b6d4;
            
            /* Legacy colors for compatibility */
            --gold-primary: #f59e0b;
            --gold-light: #fbbf24;
            --gold-dark: #d97706;
            --gold-accent: #fbbf24;
            --graphite-deep: #0f172a;
            --graphite-medium: #1e293b;
            --graphite-light: #334155;
            --white-pure: #FFFFFF;
            --white-soft: #F8F9FA;
            --emerald: #10b981;
            --ruby: #ef4444;
            --silver: #94a3b8;

            --primary-color: var(--primary);
            --secondary-color: var(--secondary);
            --accent-color: var(--accent);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border-color: rgba(15, 23, 42, 0.12);
            --border-hover: rgba(15, 23, 42, 0.2);
            --shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            --shadow-hover: 0 8px 24px rgba(15, 23, 42, 0.12);
            --shadow-gold: 0 8px 32px rgba(99, 102, 241, 0.2);
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warm: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-cool: linear-gradient(135deg, #30cfd0 0%, #330867 100%);

            /* Unified Border Radius */
            --card-radius-xl: 20px;
            --card-radius-md: 14px;
            --card-radius-sm: 10px;
        }

        .dark {
            --primary-color: var(--gold-light);
            --secondary-color: var(--gold-primary);
            --accent-color: var(--gold-primary);
            --text-primary: var(--white-soft);
            --text-secondary: #94a3b8;
            --bg-primary: var(--graphite-deep);
            --bg-secondary: var(--graphite-medium);
            --border-color: rgba(212, 175, 55, 0.35);
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            --shadow-gold: 0 8px 32px rgba(212, 175, 55, 0.3);
        }

        /* Premium Theme Toggle - Compact */
        .theme-toggle-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            border: 2px solid rgba(212, 175, 55, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            position: relative;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(212, 175, 55, 0.4);
            border-color: var(--gold-light);
        }

        .theme-icon {
            width: 18px;
            height: 18px;
            color: var(--navy-deep);
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .dark .theme-icon {
            color: var(--white-pure);
        }

        /* Premium White 3D Stat Cards */
        .stat-card {
            padding: 1.75rem;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.15);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.04);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #D4AF37, #F4E4C1, #D4AF37);
            background-size: 200% 100%;
            animation: gradientSlide 3s ease infinite;
        }

        @keyframes gradientSlide {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .stat-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 12px 40px rgba(212, 175, 55, 0.15);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        .dark .stat-card {
            background: rgba(15, 23, 42, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        .dark .stat-card:hover {
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.6);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.15) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .stat-card:hover {
            transform: translateY(-6px);
            border-color: var(--gold-primary);
            box-shadow: 0 20px 50px rgba(212, 175, 55, 0.25);
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        /* ============================================
           RESPONSIVE DESIGN - ALL SCREEN SIZES
           ============================================ */

        /* Extra Small Devices (Phones, 320px - 480px) - МАКСИМАЛЬНАЯ АДАПТАЦИЯ */
        @media (max-width: 480px) {
            body {
                font-size: 14px; /* Увеличено с 13px для лучшей читаемости */
            }

            h1 {
                font-size: 1.75rem; /* Увеличено */
            }

            h2 {
                font-size: 1.5rem; /* Увеличено */
            }

            h3 {
                font-size: 1.25rem; /* Увеличено */
            }

            .premium-card {
                padding: 1rem; /* Увеличено */
                border-radius: 16px;
                border-width: 2px;
            }

            .stat-card {
                padding: 1.125rem; /* Увеличено */
                border-radius: 14px;
                min-width: 100%;
                font-size: 0.875rem;
            }

            .premium-btn {
                padding: 12px 24px; /* Увеличено */
                font-size: 0.875rem;
                border-radius: 12px;
                min-height: 44px; /* Минимальная высота для удобства */
            }

            .premium-input {
                padding: 12px 16px; /* Увеличено */
                font-size: 0.9rem;
                border-radius: 12px;
                min-height: 44px;
            }

            .theme-toggle-btn {
                width: 44px; /* Увеличено */
                height: 44px;
            }

            .theme-icon {
                width: 22px; /* Увеличено */
                height: 22px;
            }

            img[alt="ORDINA Logo"] {
                height: 90px !important; /* Увеличено */
                max-height: 90px !important;
                min-height: 90px !important;
            }

            /* Оптимизированные навигационные вкладки */
            .tab-button {
                padding: 0.625rem 1rem; /* Увеличено */
                font-size: 0.8125rem;
                min-height: 40px;
            }

            /* Улучшенные отступы для контейнеров */
            #app {
                padding: 0.5rem !important;
            }

            /* Больше пространства для таблиц */
            .responsive-table th,
            .responsive-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8125rem;
            }


            /* Виджет погоды - скрыт на мобильных */
            #ordina-weather-widget {
                display: none !important;
            }

            /* Улучшенные модальные окна */
            dialog {
                max-width: 95vw !important;
                padding: 1.5rem !important;
                margin: 1rem auto;
            }
        }

        /* Small Devices (Phones, 481px - 640px) - ОПТИМИЗИРОВАНО */
        @media (min-width: 481px) and (max-width: 640px) {
            body {
                font-size: 15px; /* Увеличено */
            }

            h1 {
                font-size: 2rem; /* Увеличено */
            }

            h2 {
                font-size: 1.625rem; /* Увеличено */
            }

            h3 {
                font-size: 1.375rem; /* Увеличено */
            }

            .premium-card {
                padding: 1.25rem; /* Увеличено */
                border-radius: 18px;
            }

            .stat-card {
                padding: 1.375rem; /* Увеличено */
                border-radius: 16px;
                font-size: 0.9rem;
            }

            .premium-btn {
                padding: 13px 28px; /* Увеличено */
                font-size: 0.9rem;
                border-radius: 14px;
                min-height: 46px;
            }

            .premium-input {
                padding: 13px 18px;
                font-size: 0.95rem;
                border-radius: 14px;
                min-height: 46px;
            }

            .theme-toggle-btn {
                width: 46px; /* Увеличено */
                height: 46px;
            }

            .theme-icon {
                width: 23px; /* Увеличено */
                height: 23px;
            }

            img[alt="ORDINA Logo"] {
                height: 90px !important;
                max-height: 90px !important;
                min-height: 90px !important;
            }

            .tab-button {
                padding: 0.7rem 1.25rem; /* Увеличено */
                font-size: 0.875rem;
                min-height: 42px;
            }

            #app {
                padding: 0.75rem !important;
        }

        }

        /* Medium Devices (Tablets, 641px - 768px) - ОПТИМИЗИРОВАНО */
        @media (min-width: 641px) and (max-width: 768px) {
            body {
                font-size: 16px; /* Увеличено */
            }

            h1 {
                font-size: 2.25rem;
            }

            h2 {
                font-size: 1.875rem;
            }

            h3 {
                font-size: 1.5rem;
            }

            .premium-card {
                padding: 1.5rem; /* Увеличено */
                border-radius: 20px;
            }

            .stat-card {
                padding: 1.625rem; /* Увеличено */
                border-radius: 18px;
                font-size: 0.95rem;
            }

            .premium-btn {
                padding: 14px 32px;
                font-size: 0.95rem;
                min-height: 48px;
            }

            img[alt="ORDINA Logo"] {
                height: 70px !important;
                max-height: 70px !important;
                min-height: 70px !important;
            }

            .tab-button {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
            }
        }

        /* Large Tablets & Small Laptops (769px - 1024px) - ОПТИМИЗИРОВАНО */
        @media (min-width: 769px) and (max-width: 1024px) {
            body {
                font-size: 16px;
            }

            h1 {
                font-size: 2.5rem;
            }

            h2 {
                font-size: 2rem;
            }

            h3 {
                font-size: 1.625rem;
            }

            .premium-card {
                padding: 1.75rem; /* Увеличено */
                border-radius: 22px;
            }

            .stat-card {
                padding: 1.875rem; /* Увеличено */
                border-radius: 20px;
                font-size: 1rem;
            }

            .premium-btn {
                padding: 15px 36px;
                font-size: 1rem;
                min-height: 50px;
            }

            img[alt="ORDINA Logo"] {
                height: 100px !important;
                max-height: 100px !important;
                min-height: 100px !important;
            }
        }

        /* Desktop (1025px - 1440px) - ОПТИМИЗИРОВАНО */
        @media (min-width: 1025px) and (max-width: 1440px) {
            body {
                font-size: 17px; /* Увеличено */
            }

            h1 {
                font-size: 2.75rem;
            }

            h2 {
                font-size: 2.25rem;
            }

            h3 {
                font-size: 1.75rem;
            }

            .premium-card {
                padding: 2rem; /* Увеличено */
                border-radius: 24px;
            }

            .stat-card {
                padding: 2rem; /* Увеличено */
                border-radius: 22px;
                font-size: 1.05rem;
            }

            .premium-btn {
                padding: 16px 40px;
                font-size: 1.05rem;
                min-height: 52px;
            }
        }

        /* Large Desktop (1441px+) - МАКСИМАЛЬНЫЕ РАЗМЕРЫ */
        @media (min-width: 1441px) {
            body {
                font-size: 18px; /* Увеличено */
            }

            h1 {
                font-size: 3rem;
            }

            h2 {
                font-size: 2.5rem;
            }

            h3 {
                font-size: 2rem;
            }

            .premium-card {
                padding: 2.5rem; /* Увеличено */
                border-radius: 28px;
            }

            .stat-card {
                padding: 2.25rem; /* Увеличено */
                border-radius: 24px;
                font-size: 1.1rem;
            }

            .premium-btn {
                padding: 18px 44px;
                font-size: 1.1rem;
                min-height: 56px;
            }

            .premium-input {
                padding: 16px 24px;
                font-size: 1.1rem;
                min-height: 56px;
            }

            .theme-toggle-btn {
                width: 60px; /* Увеличено */
                height: 60px;
            }

            .theme-icon {
                width: 30px; /* Увеличено */
                height: 30px;
            }

            .tab-button {
                padding: 1rem 2rem;
                font-size: 1.05rem;
            }
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #faf8f5 20%, #f5f1ea 40%, #f0ebe0 60%, #faf8f5 80%, #ffffff 100%);
            background-size: 400% 400%;
            animation: gradientShift 30s ease infinite;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 50%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 25%, #312e81 50%, #1e1b4b 75%, #0f172a 100%);
            background-size: 400% 400%;
            animation: gradientShift 30s ease infinite;
        }
        
        /* Particles Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Animated gradient overlay for light theme */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%);
            animation: floatingGradient 20s ease infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .dark body::before {
            display: none;
        }
        
        @keyframes floatingGradient {
            0%, 100% { 
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            33% { 
                transform: translate(30px, -30px) scale(1.1);
                opacity: 0.8;
            }
            66% { 
                transform: translate(-30px, 30px) scale(0.9);
                opacity: 0.9;
            }
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }
        
        /* Gradient Text Effect */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            background-size: 200% 200%;
        }
        
        /* Floating Animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        
        /* Pulse Glow */
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        /* Premium White Glassmorphism Cards */
        .premium-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 24px;
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.04), 
                        0 0 0 1px rgba(212, 175, 55, 0.1) inset;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* МИНИМАЛЬНЫЙ header - максимально компактный */
        #fixed-header.premium-card {
            padding: 0.25rem 0.375rem !important;
            border-radius: 12px;
        }

        @media (min-width: 641px) {
            #fixed-header.premium-card {
                padding: 0.25rem 0.5rem !important;
            }
        }

        @media (min-width: 1025px) {
            #fixed-header.premium-card {
                padding: 0.375rem 0.75rem !important;
            }
        }

        .dark .premium-card {
            background: rgba(15, 23, 42, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6), 
                        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        .premium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .premium-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 12px 40px 0 rgba(212, 175, 55, 0.15), 
                        0 0 0 1px rgba(212, 175, 55, 0.2) inset,
                        0 0 30px rgba(212, 175, 55, 0.1);
        }

        .premium-card:hover::before {
            opacity: 1;
        }

        .premium-btn {
            background: linear-gradient(135deg, #D4AF37 0%, #B8941F 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 14px 32px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            letter-spacing: 0.3px;
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
            position: relative;
            overflow: hidden;
        }

        .dark .premium-btn {
            color: white;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.6);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .premium-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }

        .premium-btn:hover::before {
            left: 100%;
        }

        .premium-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 32px rgba(212, 175, 55, 0.4);
        }
        
        .dark .premium-btn:hover {
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.6);
        }

        .premium-btn:active {
            transform: translateY(-1px);
        }

        .premium-input {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 16px;
            padding: 14px 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .dark .premium-input {
            background: rgba(15, 23, 42, 0.4);
            color: var(--white-soft);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .premium-input:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1), 0 4px 16px rgba(212, 175, 55, 0.15);
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .dark .premium-input:focus {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(99, 102, 241, 0.6);
        }

        .tab-active {
            border-bottom: 4px solid var(--gold-primary) !important;
            color: var(--gold-primary) !important;
            font-weight: 800;
            background: linear-gradient(180deg, transparent 0%, rgba(212, 175, 55, 0.12) 100%);
            position: relative;
        }

        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
        }

        dialog::backdrop {
            background: rgba(10, 22, 40, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Luxury Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(212, 175, 55, 0.08);
            border-radius: 10px;
            margin: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            border-radius: 10px;
            border: 3px solid transparent;
            background-clip: padding-box;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold-primary) 100%);
            background-clip: padding-box;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3), 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .task-tab-active {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%) !important;
            color: var(--navy-deep) !important;
            border-color: var(--gold-primary) !important;
            box-shadow: 0 -6px 20px rgba(212, 175, 55, 0.4);
            font-weight: 800;
        }

        .dark .task-tab-active {
            color: var(--white-pure) !important;
        }

        .calendar-day {
            min-height: 120px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 2px;
        }

        .calendar-day:hover {
            background: rgba(212, 175, 55, 0.08);
            border-color: var(--gold-primary);
            transform: scale(1.02);
        }

        .calendar-day-today {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.08) 100%);
            border: 3px solid var(--gold-primary);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }

        .calendar-day-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .calendar-day-today .calendar-day-number {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            color: var(--navy-deep);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
            font-weight: 900;
        }

        .dark .calendar-day-today .calendar-day-number {
            color: var(--white-pure);
        }

        .currency-btn-active {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            color: var(--navy-deep);
            font-weight: 800;
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            transform: scale(1.05);
        }

        .dark .currency-btn-active {
            color: var(--white-pure);
        }

        /* ============================================
           НОВАЯ КРУТАЯ ВЕРХНЯЯ ПАНЕЛЬ
           ============================================ */
        
        .modern-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        
        .dark .modern-header {
            background: rgba(15, 23, 42, 0.8);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        .modern-header:hover {
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.1);
        }
        
        /* Search Bar */
        .modern-search {
            position: relative;
            flex: 1;
            max-width: 600px;
        }
        
        .modern-search input {
            width: 100%;
            padding: 12px 48px 12px 48px;
            border-radius: 16px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .dark .modern-search input {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .modern-search input:focus {
            outline: none;
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
            background: white;
        }
        
        .dark .modern-search input:focus {
            background: rgba(15, 23, 42, 0.8);
        }
        
        .modern-search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #D4AF37;
        }
        
        .modern-search-shortcut {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: rgba(0, 0, 0, 0.4);
            background: rgba(0, 0, 0, 0.05);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .dark .modern-search-shortcut {
            color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Icon Buttons */
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .dark .icon-btn {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .icon-btn:hover {
            background: white;
            border-color: rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15);
        }
        
        .dark .icon-btn:hover {
            background: rgba(15, 23, 42, 0.8);
        }
        
        .icon-btn .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }
        
        /* Profile Dropdown */
        .profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px 6px 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dark .profile-btn {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .profile-btn:hover {
            background: white;
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15);
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        /* Premium Logo Styling - БОЛЬШОЙ И ЗАМЕТНЫЙ */
        img[alt="ORDINA Logo"] {
            background: transparent !important;
            filter: drop-shadow(0 20px 50px rgba(212, 175, 55, 0.6));
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: auto !important;
            height: auto !important;
        }

        img[alt="ORDINA Logo"]:hover {
            filter: drop-shadow(0 25px 60px rgba(212, 175, 55, 0.7));
            transform: scale(1.05);
        }

        .dark img[alt="ORDINA Logo"] {
            filter: brightness(0) invert(1) drop-shadow(0 20px 50px rgba(212, 175, 55, 0.7));
        }

        .dark img[alt="ORDINA Logo"]:hover {
            filter: brightness(0) invert(1) drop-shadow(0 25px 60px rgba(212, 175, 55, 0.9));
            transform: scale(1.05);
        }

        /* Responsive logo sizes - ОЧЕНЬ БОЛЬШОЙ ЛОГОТИП (как на нормальных сайтах) */
        @media (max-width: 400px) {
            img[alt="ORDINA Logo"] {
                height: 100px !important;
                max-height: 100px !important;
                min-height: 100px !important;
            }
        }

        @media (min-width: 401px) and (max-width: 640px) {
            img[alt="ORDINA Logo"] {
                height: 120px !important;
                max-height: 120px !important;
                min-height: 120px !important;
            }
        }

        @media (min-width: 641px) and (max-width: 768px) {
            img[alt="ORDINA Logo"] {
                height: 140px !important;
                max-height: 140px !important;
                min-height: 140px !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            img[alt="ORDINA Logo"] {
                height: 160px !important;
                max-height: 160px !important;
                min-height: 160px !important;
            }
        }

        @media (min-width: 1025px) and (max-width: 1440px) {
            img[alt="ORDINA Logo"] {
                height: 180px !important;
                max-height: 180px !important;
                min-height: 180px !important;
            }
        }

        @media (min-width: 1441px) {
            img[alt="ORDINA Logo"] {
                height: 200px !important;
                max-height: 200px !important;
                min-height: 200px !important;
            }
        }

        /* Premium Toast Notifications */
        #toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            display: flex;
            align-items: center;
            padding: 1.5rem 2rem;
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            opacity: 0;
            transform: translateX(120%);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(212, 175, 55, 0.3);
            font-weight: 600;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success {
            background: linear-gradient(135deg, rgba(80, 200, 120, 0.95) 0%, rgba(50, 170, 90, 0.95) 100%);
            color: white;
            border-color: rgba(80, 200, 120, 0.5);
        }

        .toast-error {
            background: linear-gradient(135deg, rgba(224, 17, 95, 0.95) 0%, rgba(194, 17, 85, 0.95) 100%);
            color: white;
            border-color: rgba(224, 17, 95, 0.5);
        }

        /* Premium Animations */
        dialog[open] {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(30px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2.5s infinite;
        }

        /* Premium Loading Overlay */
        #loading-overlay {
            background: linear-gradient(135deg, var(--navy-deep) 0%, var(--navy-medium) 50%, #0d1b2a 100%);
        }

        /* Premium Responsive Tables - Mobile First */
        @media screen and (max-width: 480px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: block;
                border: 1.5px solid rgba(212, 175, 55, 0.25);
                border-radius: 14px;
                margin-bottom: 1rem;
                padding: 1rem;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 24px rgba(10, 22, 40, 0.08);
                transition: all 0.3s ease;
            }

            .responsive-table tr:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 32px rgba(212, 175, 55, 0.18);
                border-color: var(--gold-primary);
            }

            .dark .responsive-table tr {
                background: linear-gradient(135deg, rgba(26, 41, 66, 0.95) 0%, rgba(10, 22, 40, 0.9) 100%);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .responsive-table tr:last-child {
                margin-bottom: 0;
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.65rem 0;
                border-bottom: 1px solid rgba(212, 175, 55, 0.12);
                font-size: 0.85rem;
            }

            .responsive-table td:last-child {
                border-bottom: none;
                padding-top: 1rem;
                justify-content: flex-end;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 800;
                color: var(--gold-primary);
                margin-right: 0.75rem;
                font-size: 0.75rem;
                letter-spacing: 0.5px;
            }
        }

        @media screen and (min-width: 481px) and (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }

            .responsive-table tr {
                display: block;
                border: 2px solid rgba(212, 175, 55, 0.25);
                border-radius: 16px;
                margin-bottom: 1.25rem;
                padding: 1.25rem;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
                backdrop-filter: blur(10px);
                box-shadow: 0 10px 30px rgba(10, 22, 40, 0.1);
                transition: all 0.3s ease;
            }

            .responsive-table tr:hover {
                transform: translateY(-2px);
                box-shadow: 0 15px 40px rgba(212, 175, 55, 0.2);
                border-color: var(--gold-primary);
            }

            .dark .responsive-table tr {
                background: linear-gradient(135deg, rgba(26, 41, 66, 0.95) 0%, rgba(10, 22, 40, 0.9) 100%);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }

            .responsive-table tr:last-child {
                margin-bottom: 0;
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.875rem 0;
                border-bottom: 1px solid rgba(212, 175, 55, 0.15);
            }

            .responsive-table td:last-child {
                border-bottom: none;
                padding-top: 1.25rem;
                justify-content: flex-end;
            }

            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 800;
                color: var(--gold-primary);
                margin-right: 1rem;
                font-size: 0.85rem;
                letter-spacing: 0.5px;
            }
        }

        /* Tablet Landscape - Show simplified table */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .responsive-table {
                font-size: 0.9rem;
            }

            .responsive-table th,
            .responsive-table td {
                padding: 0.875rem 1rem;
            }
        }

        /* Premium Dark Mode - Luxury Edition */
        .dark body {
            background: linear-gradient(135deg, #0A1628 0%, #1A2942 50%, #0d1b2a 100%) !important;
            color: var(--white-soft);
        }

        /* Premium Dark Surfaces */
        .dark .bg-white,
        .dark .bg-gray-50,
        .dark .bg-gray-100,
        .dark .bg-gray-200 {
            background: linear-gradient(135deg, rgba(26, 41, 66, 0.95) 0%, rgba(10, 22, 40, 0.9) 100%) !important;
        }

        .dark .bg-gray-300 {
            background: linear-gradient(135deg, rgba(26, 41, 66, 0.98) 0%, rgba(10, 22, 40, 0.95) 100%) !important;
        }

        /* Premium Dark Text */
        .dark .text-gray-900,
        .dark .text-gray-800,
        .dark .text-gray-700,
        .dark .text-gray-600,
        .dark .text-gray-500 {
            color: var(--gold-light) !important;
        }

        .dark .text-gray-400 {
            color: #cbd5e1 !important;
        }

        .dark .text-gray-300 {
            color: #94a3b8 !important;
        }

        /* Premium Dark Borders */
        .dark .border-gray-100,
        .dark .border-gray-200,
        .dark .border-gray-300,
        .dark .border-gray-400 {
            border-color: rgba(212, 175, 55, 0.3) !important;
        }

        /* Premium Dark Shadows */
        .dark .shadow-lg,
        .dark .shadow-md,
        .dark .shadow-sm {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(212, 175, 55, 0.4) !important;
        }

        /* Premium Status Colors - Dark Mode */
        .dark .bg-green-100 {
            background: linear-gradient(135deg, rgba(80, 200, 120, 0.25) 0%, rgba(50, 170, 90, 0.2) 100%) !important;
        }

        .dark .bg-yellow-100 {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.25) 0%, rgba(184, 148, 31, 0.2) 100%) !important;
        }

        .dark .bg-red-100 {
            background: linear-gradient(135deg, rgba(224, 17, 95, 0.25) 0%, rgba(194, 17, 85, 0.2) 100%) !important;
        }

        .dark .bg-purple-100 {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.25) 0%, rgba(126, 34, 206, 0.2) 100%) !important;
        }

        .dark .text-green-700,
        .dark .text-green-600,
        .dark .text-green-800 {
            color: var(--emerald) !important;
            text-shadow: 0 0 10px rgba(80, 200, 120, 0.3);
        }

        .dark .text-yellow-700,
        .dark .text-yellow-600,
        .dark .text-yellow-800 {
            color: var(--gold-primary) !important;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .dark .text-red-700,
        .dark .text-red-600,
        .dark .text-red-800 {
            color: var(--ruby) !important;
            text-shadow: 0 0 10px rgba(224, 17, 95, 0.3);
        }

        .dark .text-purple-700,
        .dark .text-purple-600 {
            color: #b4a1e0 !important;
            text-shadow: 0 0 10px rgba(147, 51, 234, 0.3);
        }

        .dark .text-orange-600 {
            color: #e9aa75 !important;
            text-shadow: 0 0 10px rgba(233, 170, 117, 0.3);
        }

        /* Premium Light Background Overrides - Dark Mode */
        .dark .bg-red-50 {
            background: linear-gradient(135deg, rgba(224, 17, 95, 0.15) 0%, rgba(194, 17, 85, 0.1) 100%) !important;
        }

        .dark .bg-yellow-50 {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(184, 148, 31, 0.1) 100%) !important;
        }

        .dark .bg-purple-50 {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15) 0%, rgba(126, 34, 206, 0.1) 100%) !important;
        }

        .dark .bg-green-50 {
            background: linear-gradient(135deg, rgba(80, 200, 120, 0.15) 0%, rgba(50, 170, 90, 0.1) 100%) !important;
        }

        .dark .bg-blue-50 {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.1) 100%) !important;
        }

        /* Modern Radio equalizer animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 16px;
            width: auto;
        }

        .equalizer span {
            display: block;
            width: 4px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 2px;
            animation: equalize 1.2s infinite ease-in-out alternate;
        }

        .equalizer span:nth-child(1) {
            animation-delay: 0s;
        }

        .equalizer span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .equalizer span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .equalizer span:nth-child(4) {
            animation-delay: 0.6s;
        }

        .equalizer span:nth-child(5) {
            animation-delay: 0.8s;
        }

        .equalizer.paused span {
            animation: none;
            height: 4px;
        }

        @keyframes equalize {
            from {
                height: 4px;
            }

            to {
                height: 16px;
            }
        }

        /* Premium Task Tab Styling */
        .task-tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            margin-right: 0.5rem;
            border: 2px solid rgba(212, 175, 55, 0.25);
            border-bottom: none;
            border-radius: 18px 18px 0 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -4px 12px rgba(10, 22, 40, 0.05);
        }

        .task-tab-button:last-child {
            margin-right: 0;
        }

        .task-tab-button:hover {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.08) 100%);
            border-color: var(--gold-primary);
            transform: translateY(-2px);
            box-shadow: 0 -6px 16px rgba(212, 175, 55, 0.2);
        }

        .dark .task-tab-button {
            background: linear-gradient(180deg, rgba(26, 41, 66, 0.95) 0%, rgba(10, 22, 40, 0.9) 100%);
            color: var(--text-primary);
        }

        .dark .task-tab-button:hover {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 100%);
        }

        /* Premium Glow Effects */
        .glow-gold {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5),
                0 0 40px rgba(212, 175, 55, 0.3),
                0 0 60px rgba(212, 175, 55, 0.1);
        }

        .text-glow {
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5),
                0 0 20px rgba(212, 175, 55, 0.3);
        }

        /* Premium Button Hover Effects */
        button:not(.premium-btn):not(.theme-toggle-btn) {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button:not(.premium-btn):not(.theme-toggle-btn):hover {
            transform: translateY(-2px);
        }

        /* Luxury Input Focus Ring */
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.15);
        }

        /* ============================================
           ADDITIONAL RESPONSIVE OPTIMIZATIONS
           ============================================ */

        /* Container & Layout Adjustments */
        @media (max-width: 768px) {
            /* Weather widget responsive */
            .weather-widget-new {
                width: 100% !important;
                max-width: 100% !important;
                min-width: auto !important;
            }

            /* Header responsive layout */
            #fixed-header {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            #fixed-header > div:first-child {
                flex: 1 1 100%;
                order: 1;
            }

            #fixed-header > div:last-child {
                flex: 1 1 100%;
                order: 3;
                justify-content: flex-end;
            }

            #ordina-weather-widget {
                order: 2;
                width: 100%;
                margin: 0.5rem 0;
            }

            /* Logo responsive */
            img[alt="ORDINA Logo"] {
                height: 80px !important;
                max-height: 80px !important;
            }

            /* Make motto visible on mobile */
            .hidden.md\\:block {
                display: block !important;
            }
        }

        @media (max-width: 480px) {
            #app {
                padding: 0.5rem !important;
            }

            #fixed-header {
                padding: 0.375rem 0.5rem !important;
            }

            /* Compact header controls */
            #fixed-header .flex {
                gap: 0.375rem;
            }

            /* Stack stat cards vertically */
            .stat-card {
                flex: 1 1 100%;
                max-width: 100%;
            }

            /* Smaller buttons in header */
            #calculator-btn,
            #shopping-list-btn {
                width: 38px !important;
                height: 38px !important;
            }

            #calculator-btn svg,
            #shopping-list-btn svg {
                width: 18px !important;
                height: 18px !important;
            }

            /* Compact currency toggle */
            #currency-azn,
            #currency-usd {
                padding: 0.35rem 0.5rem;
                font-size: 0.65rem;
            }

            /* Weather widget on mobile */
            .weather-widget-new {
                padding: 0.625rem;
            }

            .weather-widget-header {
                margin-bottom: 0.5rem;
                padding-bottom: 0.5rem;
            }

            .weather-widget-controls {
                gap: 0.25rem;
            }

            .weather-control-btn {
                width: 26px;
                height: 26px;
            }

            .weather-control-btn svg {
                width: 14px !important;
                height: 14px !important;
            }

            /* Radio player на мобильных - компактный */
            [role="region"][aria-label="Radio player"] {
                padding: 0.375rem 0.5rem !important;
                min-width: auto;
            }

            /* Ensure all navigation items are visible */
            nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            nav button {
                white-space: nowrap;
                min-width: fit-content;
            }
        }

        /* Radio Equalizer Animation */
        .equalizer-bar {
            height: 4px;
            transition: height 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            animation: equalizerPulse 0.6s ease-in-out infinite alternate;
        }

        .equalizer-bar:nth-child(1) {
            animation-delay: 0s;
        }

        .equalizer-bar:nth-child(2) {
            animation-delay: 0.12s;
        }

        .equalizer-bar:nth-child(3) {
            animation-delay: 0.24s;
        }

        .equalizer-bar:nth-child(4) {
            animation-delay: 0.36s;
        }

        .equalizer-bar:nth-child(5) {
            animation-delay: 0.48s;
        }

        @keyframes equalizerPulse {
            0% {
                height: 4px;
            }

            100% {
                height: 18px;
            }
        }

        .equalizer-bar.paused {
            animation-play-state: paused;
            height: 4px !important;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 480px) {
            .news-box {
                padding: 1rem;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .equalizer-bar {
                width: 0.75px;
            }

            #fixed-header {
                padding: 0.25rem 0.375rem !important;
            }

            .tab-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .news-box {
                padding: 1.25rem;
            }

            .stat-card {
                padding: 1.5rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .news-box {
                padding: 1.5rem;
            }

            .stat-card {
                padding: 1.75rem;
            }
        }

        @media (min-width: 1025px) {
            .news-box {
                padding: 1.75rem;
            }

            .stat-card {
                padding: 2rem;
            }
        }

        @media (min-width: 481px) and (max-width: 640px) {
            #app {
                padding: 0.75rem !important;
            }

            .stat-card {
                flex: 1 1 calc(50% - 0.5rem);
                min-width: calc(50% - 0.5rem);
            }
        }

        @media (min-width: 641px) and (max-width: 768px) {
            .stat-card {
                flex: 1 1 calc(33.333% - 0.75rem);
                min-width: calc(33.333% - 0.75rem);
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .stat-card {
                flex: 1 1 calc(33.333% - 0.75rem);
                min-width: 180px;
            }
        }

        @media (min-width: 1025px) {
            .stat-card {
                flex: 1 1 calc(16.666% - 0.75rem);
                min-width: 160px;
            }
        }

        /* Navigation Tabs Responsive */
        @media (max-width: 480px) {
            nav .flex {
                gap: 0;
            }

            .tab-button {
                padding: 0.5rem 0.5rem;
                font-size: 0.7rem;
                white-space: nowrap;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .tab-button {
                padding: 0.6rem 0.875rem;
                font-size: 0.8rem;
            }
        }

        /* Modal & Dialog Responsive */
        @media (max-width: 640px) {
            dialog {
                max-width: 95vw !important;
                margin: 1rem;
                padding: 1.25rem !important;
            }

            dialog h2 {
                font-size: 1.25rem;
            }
        }

        /* Chart Responsive */
        @media (max-width: 768px) {
            canvas {
                max-height: 250px !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            canvas {
                max-height: 300px !important;
            }
        }

        /* Calendar Responsive */
        @media (max-width: 480px) {
            .calendar-day {
                min-height: 80px;
                font-size: 0.75rem;
            }

            .calendar-day-number {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .calendar-day {
                min-height: 100px;
                font-size: 0.85rem;
            }

            .calendar-day-number {
                width: 34px;
                height: 34px;
            }
        }

        /* Task Tabs Responsive */
        @media (max-width: 640px) {
            .task-tab-button {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
                border-radius: 12px 12px 0 0;
            }
        }

        /* ============================================
           TOUCH & MOBILE INTERACTION OPTIMIZATIONS
           ============================================ */
        @media (hover: none) and (pointer: coarse) {

            /* Larger touch targets for mobile */
            button,
            a,
            input[type="checkbox"],
            input[type="radio"],
            select {
                min-height: 44px;
                min-width: 44px;
            }

            /* Remove hover effects on touch devices */
            .premium-card:hover,
            .stat-card:hover,
            .premium-btn:hover {
                transform: none;
            }

            /* Active states for touch feedback */
            .premium-btn:active {
                transform: scale(0.97);
                opacity: 0.9;
            }

            button:active {
                transform: scale(0.95);
            }

            /* Prevent text selection on buttons */
            button,
            .tab-button,
            .task-tab-button {
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* Smooth scrolling for mobile */
            * {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ============================================
           HIGH DPI / RETINA DISPLAYS
           ============================================ */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {

            /* Sharper borders on retina */
            .premium-card,
            .stat-card {
                border-width: 0.5px;
            }

            /* Crisper text rendering */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                text-rendering: optimizeLegibility;
            }
        }

        /* Ultra Premium Gradient Backgrounds */
        .bg-premium-gradient {
            background: linear-gradient(135deg,
                    var(--gold-light) 0%,
                    var(--white-pure) 25%,
                    var(--white-soft) 50%,
                    var(--white-pure) 75%,
                    var(--gold-light) 100%);
        }

        .dark .bg-premium-gradient {
            background: linear-gradient(135deg,
                    var(--navy-deep) 0%,
                    var(--navy-medium) 25%,
                    #0d1b2a 50%,
                    var(--navy-medium) 75%,
                    var(--navy-deep) 100%);
        }

        /* 🌤️ НОВЫЙ КРАСИВЫЙ КОМПАКТНЫЙ ВИДЖЕТ ПОГОДЫ */
        .weather-widget-new {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.9) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 14px;
            padding: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 240px;
            max-width: 240px;
            min-width: 240px;
            overflow: hidden;
        }

        .weather-widget-new:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            border-color: var(--border-hover);
        }

        .dark .weather-widget-new {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .dark .weather-widget-new:hover {
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
        }

        .dark .weather-search-field {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
        }

        .dark .weather-search-field:focus {
            background: rgba(15, 23, 42, 0.9);
            border-color: var(--primary-light);
        }

        .dark .weather-control-btn {
            background: rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
        }

        .dark .weather-control-btn:hover {
            background: rgba(99, 102, 241, 0.35);
        }

        /* Radio player theme switching */
        .dark [role="region"][aria-label="Radio player"] {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%) !important;
            border-color: rgba(102, 126, 234, 0.4) !important;
        }

        .weather-widget-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.625rem;
            padding-bottom: 0.625rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        .weather-icon-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .weather-icon-circle {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            color: white;
            animation: weatherPulse 3s ease-in-out infinite;
            box-shadow: 0 2px 12px rgba(102, 126, 234, 0.4);
        }

        .dark .weather-icon-circle {
            background: linear-gradient(135deg, #818cf8 0%, #a855f7 100%);
            box-shadow: 0 2px 12px rgba(129, 140, 248, 0.6);
        }

        @keyframes weatherPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .weather-temp-wrapper {
            display: flex;
            align-items: baseline;
            gap: 0.125rem;
        }

        .weather-temp-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }

        .dark .weather-temp-value {
            color: var(--primary-light);
        }

        .weather-temp-unit {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            opacity: 0.8;
        }

        .dark .weather-temp-unit {
            color: var(--primary-light);
        }

        .weather-info-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            min-width: 0;
        }

        .weather-city-text {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .weather-desc-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .weather-datetime-text {
            font-size: 0.625rem;
            color: var(--text-secondary);
            font-weight: 400;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0.125rem;
        }

        /* Каллиграфический стиль для мото */
        .calligraphy-motto {
            font-family: 'Space Grotesk', 'Georgia', serif;
            font-style: italic;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--text-secondary) 0%, var(--text-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .dark .calligraphy-motto {
            background: linear-gradient(135deg, var(--text-secondary) 0%, var(--gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .weather-widget-controls {
            display: flex;
            gap: 0.375rem;
            align-items: center;
        }

        .weather-search-field {
            flex: 1;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.75rem;
            transition: all 0.2s ease;
            min-width: 0;
        }

        .weather-search-field:focus {
            outline: none;
            border-color: var(--border-hover);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
            background: var(--bg-primary);
        }

        .dark .weather-search-field {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .dark .weather-search-field:focus {
            background: rgba(15, 23, 42, 0.9);
            border-color: var(--primary-light);
        }

        .weather-control-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .weather-control-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .dark .weather-control-btn {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--primary-light);
        }

        .dark .weather-control-btn:hover {
            background: var(--primary-light);
            color: var(--graphite-deep);
        }

        /* Responsive Weather Widget - показываем с lg (1024px+) */
        @media (max-width: 1023px) {
            #ordina-weather-widget {
                display: none !important;
            }
        }

        /* 📰 КРАСИВЫЙ КОМПАКТНЫЙ ВИДЖЕТ НОВОСТЕЙ */
        .news-toolbar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.08);
        }

        .dark .news-toolbar {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .news-toolbar-left {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .news-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .news-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .dark .news-select {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
        }

        .news-search-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            font-size: 0.8125rem;
            transition: all 0.2s ease;
            min-width: 0;
        }

        .news-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .dark .news-search-input {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .news-refresh-btn {
            padding: 0.5rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .news-refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .dark .news-refresh-btn {
            background: linear-gradient(135deg, #818cf8 0%, #a855f7 100%);
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .news-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.06);
        }

        .news-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .dark .news-item {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .dark .news-item:hover {
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.25);
        }

        .news-item-image {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .news-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .news-item-image-placeholder {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: rgba(99, 102, 241, 0.5);
        }

        .news-item-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .news-item-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .news-item-source {
            padding: 0.125rem 0.5rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.6875rem;
        }

        .dark .news-item-source {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
        }

        .news-item-date {
            color: var(--text-secondary);
            font-size: 0.6875rem;
        }

        .news-item-title {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-item-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-item-arrow {
            flex-shrink: 0;
            color: var(--text-secondary);
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .news-item:hover .news-item-arrow {
            transform: translateX(4px);
            opacity: 1;
            color: var(--primary);
        }

        .news-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
            gap: 1rem;
        }

        .news-empty svg {
            opacity: 0.5;
        }

        .news-empty p {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .news-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            gap: 1rem;
        }

        .news-loading.hidden {
            display: none;
        }

        .news-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .news-loading p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Responsive для новостей */
        @media (max-width: 640px) {
            .news-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .news-toolbar-left {
                flex-direction: column;
            }

            .news-select {
                width: 100%;
                min-width: unset;
            }

            .news-item {
                padding: 0.75rem;
            }

            .news-item-image,
            .news-item-image-placeholder {
                width: 60px;
                height: 60px;
            }
        }

        /* Language Dropdown Styles */
        .language-dropdown {
            position: relative;
        }

        .language-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid rgba(212, 175, 55, 0.25);
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-dropdown-btn:hover {
            border-color: var(--gold-primary);
            background: rgba(212, 175, 55, 0.1);
        }

        .language-dropdown-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(10, 22, 40, 0.15);
            display: none;
            flex-direction: row;
            gap: 0.5rem;
            z-index: 100;
        }

        .language-dropdown-menu.show {
            display: flex;
        }

        .language-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }

        .language-option img {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
        }

        .language-option:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
        }

        .language-option.active {
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.6);
            transform: scale(1.05);
        }

        .language-option span {
            display: none;
        }

        /* News Panel Styles - REBUILT Premium Style */
        .news-panel {
            padding: 18px;
            border-radius: var(--card-radius-xl);
            border: 2px solid var(--glass-border-light);
            background: var(--card-gradient-light);
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-card-light);
            transition: all 0.3s ease;
        }

        .news-panel:hover {
            box-shadow: var(--shadow-gold);
            border-color: var(--border-gold);
        }

        .dark .news-panel {
            background: var(--card-gradient-dark);
            border-color: var(--glass-border-dark);
            box-shadow: var(--shadow-card-dark);
        }

        /* News List Container */
        #news-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .news-item {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.15);
            background: var(--bg-primary);
            transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s ease, background-color 0.2s ease;
        }

        .news-item:hover {
            border-color: var(--gold-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15);
            background-color: rgba(227, 179, 65, 0.08);
        }

        /* Do not force oversized images; keep thumbnails compact via utility classes */
        .news-item img {
            border-radius: 6px;
        }

        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Enhanced Calendar Styles */
        .calendar-day {
            min-height: 100px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: scale(1.02);
        }

        .calendar-day-today {
            border: 2px solid var(--gold-primary);
            background: rgba(212, 175, 55, 0.1);
        }

        /* Luxury Accent Lines */
        .accent-line {
            position: relative;
        }

        .accent-line::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--gold-primary), transparent);
            border-radius: 2px;
        }

        /* ============================================
           CONTAINER & SPACING OPTIMIZATIONS
           ============================================ */

        /* Max width container for ultra-wide screens */
        @media (min-width: 1920px) {
            #app {
                max-width: 1800px;
                margin: 0 auto;
            }
        }

        /* Flexible gap system */
        @media (max-width: 480px) {

            .flex,
            .grid {
                gap: 0.5rem !important;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {

            .flex,
            .grid {
                gap: 0.75rem !important;
            }
        }

        @media (min-width: 769px) {

            .flex,
            .grid {
                gap: 1rem !important;
            }
        }

        /* Responsive padding for main sections */
        @media (max-width: 480px) {
            .page-content {
                padding: 0.75rem 0;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .page-content {
                padding: 1rem 0;
            }
        }

        @media (min-width: 769px) {
            .page-content {
                padding: 1.5rem 0;
            }
        }

        /* Premium Loading Animation */
        @keyframes luxuryPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        .luxury-pulse {
            animation: luxuryPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>

<body class="antialiased text-gray-800">
    <!-- Particles Background -->
    <div id="particles-js"></div>

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50" style="z-index: 10000;">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-300" data-i18n="loading">Загрузка
                данных...</p>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-container"
        class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 py-4 px-4">
        <div class="max-w-sm w-full space-y-6">
            <div class="flex justify-center space-x-2 mb-4">
                <button id="lang-ru-login" title="Русский"
                    class="px-3 py-1 text-xs font-medium rounded-lg bg-blue-600 text-white">RU</button>
                <button id="lang-en-login" title="English"
                    class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">EN</button>
                <button id="lang-az-login" title="Azərbaycan"
                    class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">AZ</button>
            </div>
            <div class="text-center">
                <div class="mb-4">
                    <img src="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png"
                        alt="ORDINA Logo" class="mx-auto h-48 sm:h-56 w-auto drop-shadow-lg">
                </div>
                <h2 class="text-base sm:text-lg font-bold text-gray-800 dark:text-gray-200 mb-1" data-i18n="authTitle">
                    Войдите в свой аккаунт</h2>
                <p class="text-xs text-gray-600 dark:text-gray-400">Добро пожаловать в ORDINA</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-3 sm:p-4 space-y-3">
                <button type="button" id="google-signin-btn"
                    class="group relative w-full flex justify-center items-center py-2 px-3 border border-gray-300 dark:border-gray-600 text-xs font-medium rounded-xl text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="h-3 w-3 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px"
                        height="48px">
                        <path fill="#FFC107"
                            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z">
                        </path>
                        <path fill="#FF3D00"
                            d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z">
                        </path>
                        <path fill="#4CAF50"
                            d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.521-3.108-11.28-7.481l-6.522,5.025C9.505,39.556,16.227,44,24,44z">
                        </path>
                        <path fill="#1976D2"
                            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.566,44,30.84,44,24C44,22.659,43.862,21.35,43.611,20.083z">
                        </path>
                    </svg>
                    <span data-i18n="loginWithGoogle">Войти через Google</span>
                </button>
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200 dark:border-gray-600"></div>
                    </div>
                    <div class="relative flex justify-center text-xs"><span
                            class="px-2 bg-white dark:bg-gray-800 text-gray-400 dark:text-gray-500 font-medium">или</span>
                    </div>
                </div>
                <form id="auth-form" class="space-y-3">
                    <div class="space-y-2">
                        <div>
                            <label for="email-address"
                                class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                            <input id="email-address" name="email" type="email" autocomplete="email" required
                                class="w-full px-2.5 py-2 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm bg-white dark:bg-gray-700"
                                placeholder="Введите ваш email">
                        </div>
                        <div>
                            <label for="password"
                                class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Пароль</label>
                            <input id="password" name="password" type="password" autocomplete="current-password"
                                required
                                class="w-full px-2.5 py-2 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm bg-white dark:bg-gray-700"
                                placeholder="Введите пароль">
                        </div>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs text-center"></p>
                    <div class="space-y-2">
                        <button type="submit" id="login-btn"
                            class="w-full flex justify-center py-2 px-3 border border-transparent text-xs font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-lg hover:shadow-xl"
                            data-i18n="login">Войти</button>
                        <button type="button" id="register-btn"
                            class="w-full flex justify-center py-2 px-3 border border-gray-300 dark:border-gray-600 text-xs font-medium rounded-xl text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
                            data-i18n="register">Зарегистрироваться</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-2 sm:p-4 md:p-6 relative opacity-0 transition-opacity duration-300 hidden">
        <!-- Fixed header wrapper to keep top bar, logo, and navigation static on scroll -->
        <div id="fixed-header" class="sticky top-0 z-30 premium-card">
            <!-- Compact top bar for logo and controls -->
            <div class="flex items-center justify-between px-1.5 sm:px-2 md:px-2.5 py-0.5 gap-1 sm:gap-1.5">
                <!-- Left: Logo and Motto -->
                <div class="flex items-center gap-2 flex-1">
                    <!-- Logo -->
                    <div class="flex items-center gap-2">
                        <img src="https://raw.githubusercontent.com/Kenny-Corleone/ORDINA.github.io/main/logo%20ORDINA.png"
                            alt="ORDINA Logo" class="w-auto drop-shadow-lg">
                        <!-- Motto - Каллиграфический стиль -->
                        <div class="hidden md:block">
                            <div class="font-medium calligraphy-motto" style="color: var(--text-secondary); font-size: 0.875rem !important;"
                                data-i18n="appSubtitle">Управляй своей жизнью с легкостью</div>
                        </div>
                    </div>

                    <!-- 🌤️ КРАСИВЫЙ КОМПАКТНЫЙ ВИДЖЕТ ПОГОДЫ -->
                    <div id="ordina-weather-widget" class="hidden lg:block">
                        <div class="weather-widget-new">
                            <div class="weather-widget-header">
                                <div class="weather-icon-wrapper">
                                    <div id="weather-animated-icon" class="weather-icon-circle">
                                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <circle cx="12" cy="12" r="5" stroke-width="2"/>
                                            <line x1="12" y1="1" x2="12" y2="3" stroke-width="2"/>
                                            <line x1="12" y1="21" x2="12" y2="23" stroke-width="2"/>
                                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke-width="2"/>
                                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke-width="2"/>
                                            <line x1="1" y1="12" x2="3" y2="12" stroke-width="2"/>
                                            <line x1="21" y1="12" x2="23" y2="12" stroke-width="2"/>
                                        </svg>
                                    </div>
                                    <div class="weather-temp-wrapper">
                                        <span id="weather-temp-new" class="weather-temp-value">--</span>
                                        <span class="weather-temp-unit">°C</span>
                                    </div>
                                </div>
                                <div class="weather-info-wrapper">
                                    <div id="weather-city-new" class="weather-city-text">—</div>
                                    <div id="weather-desc-new" class="weather-desc-text">—</div>
                                    <div id="weather-datetime-new" class="weather-datetime-text">—</div>
                                </div>
                            </div>
                            <div class="weather-widget-controls">
                                <input type="text" id="weather-search-input" placeholder="" class="weather-search-field" data-i18n-placeholder="weatherCitySearchPlaceholder"/>
                                <button id="weather-search-btn" class="weather-control-btn" title="Поиск">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <circle cx="11" cy="11" r="8" stroke-width="2"/>
                                        <path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                                <button id="weather-location-btn-new" class="weather-control-btn" title="Моя локация">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7z" stroke-width="2"/>
                                        <circle cx="12" cy="9" r="2.5" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button id="weather-refresh-btn-new" class="weather-control-btn" title="Обновить">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls справа: валюта/язык/тема над калькулятором, radio/калькулятор/покупки/выход -->
                <div class="flex flex-col items-end gap-1">
                    <!-- Верхняя строка: валюта, язык, тема -->
                    <div class="flex items-center gap-0.5 sm:gap-1">
                    <!-- Currency Toggle -->
                    <div
                        class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden text-xs">
                        <button id="currency-azn" class="px-1.5 py-0.5 currency-btn-active">AZN</button>
                        <button id="currency-usd" class="px-1.5 py-0.5">USD</button>
                    </div>
                    <!-- Language Dropdown -->
                    <div class="language-dropdown">
                        <button id="language-dropdown-btn" class="language-dropdown-btn">
                            <img id="language-flag" src="https://flagcdn.com/w40/ru.png" alt="Flag"
                                class="w-6 h-4 rounded-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="language-dropdown-menu" class="language-dropdown-menu">
                            <div class="language-option active" data-lang="ru" title="Русский">
                                <img src="https://flagcdn.com/w40/ru.png" alt="RU">
                                <span>Русский</span>
                            </div>
                            <div class="language-option" data-lang="en" title="English">
                                <img src="https://flagcdn.com/w40/gb.png" alt="EN">
                                <span>English</span>
                            </div>
                            <div class="language-option" data-lang="az" title="Azərbaycan">
                                <img src="https://flagcdn.com/w40/az.png" alt="AZ">
                                <span>Azərbaycan</span>
                            </div>
                        </div>
                    </div>
                    <!-- Premium Theme Toggle Button -->
                    <button id="theme-toggle" title="Toggle theme" class="theme-toggle-btn">
                        <!-- Sun icon - shown in dark mode to switch to light -->
                        <svg id="theme-icon-sun" class="theme-icon hidden dark:block" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" fill="currentColor" />
                            <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                        <!-- Moon icon - shown in light mode to switch to dark -->
                        <svg id="theme-icon-moon" class="theme-icon block dark:hidden" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    </div>
                    <!-- Нижняя строка: radio, калькулятор, покупки, выход -->
                    <div class="flex items-center gap-0.5 sm:gap-1">
                    <!-- 🎵 Premium Radio Player -->
                    <div class="flex items-center gap-1 sm:gap-2 rounded-xl px-2 sm:px-3 py-1.5 sm:py-2"
                        style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(102, 126, 234, 0.3); box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);"
                        role="region" aria-label="Radio player">
                        <button id="radio-play-pause-btn"
                            class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center rounded-xl transition-all duration-300 shadow-md hover:shadow-lg hover:scale-110 active:scale-95"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                            aria-label="Play/Pause radio" title="Play/Pause (Space)">
                            <svg id="play-icon" class="w-3.5 h-3.5 sm:w-4 sm:h-4 ml-0.5 text-white" fill="currentColor" viewBox="0 0 24 24"
                                aria-hidden="true">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            <svg id="pause-icon" class="w-3.5 h-3.5 sm:w-4 sm:h-4 hidden text-white" fill="currentColor" viewBox="0 0 24 24"
                                aria-hidden="true">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                            </svg>
                        </button>

                        <!-- Enhanced Animated Equalizer -->
                        <div id="equalizer" class="flex items-end gap-0.5 sm:gap-1 h-4 sm:h-5">
                            <div class="equalizer-bar w-1 rounded-full"
                                style="background: linear-gradient(to top, #667eea, #764ba2); min-height: 4px;"></div>
                            <div class="equalizer-bar w-1 rounded-full"
                                style="background: linear-gradient(to top, #667eea, #764ba2); min-height: 4px;"></div>
                            <div class="equalizer-bar w-1 rounded-full"
                                style="background: linear-gradient(to top, #667eea, #764ba2); min-height: 4px;"></div>
                            <div class="equalizer-bar w-1 rounded-full"
                                style="background: linear-gradient(to top, #667eea, #764ba2); min-height: 4px;"></div>
                            <div class="equalizer-bar w-1 rounded-full"
                                style="background: linear-gradient(to top, #667eea, #764ba2); min-height: 4px;"></div>
                        </div>

                        <div class="text-xs font-semibold hidden sm:block" style="color: var(--text-primary); background: rgba(255, 255, 255, 0.6); padding: 0.25rem 0.5rem; border-radius: 6px; backdrop-filter: blur(4px);" data-i18n="radioTitle">AzerbaiJazz Radio</div>
                        <audio id="radio-player" src="https://stream.zeno.fm/tjqlpbsxi4ytv"
                            aria-label="AzerbaiJazz Radio stream"></audio>
                    </div>
                    <!-- Premium Calculator Button -->
                    <button id="calculator-btn"
                        class="flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 via-blue-600 to-cyan-500 text-white hover:from-blue-600 hover:via-blue-700 hover:to-cyan-600 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95"
                        title="Калькулятор">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <!-- Premium Shopping List Button -->
                    <button id="shopping-list-btn"
                        class="flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-green-500 via-emerald-600 to-teal-500 text-white hover:from-green-600 hover:via-emerald-700 hover:to-teal-600 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95"
                        title="Список покупок">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                    </button>
                    <!-- Compact Logout -->
                    <button id="logout-btn" class="text-xs font-medium px-1 hover:opacity-70 transition"
                        style="color: var(--text-secondary);" data-i18n="logout">Выйти</button>
                </div>
            </div>
            </div>
            <!-- Navigation - Компактная -->
            <nav class="border-t" style="background: var(--bg-primary); border-color: var(--border-color);">
                <div class="flex overflow-x-auto pb-0.5">
                    <button data-tab="dashboard"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent tab-active whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'" data-i18n="tabDashboard">Сводка</button>
                    <button data-tab="debts"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'" data-i18n="tabDebts">Долги</button>
                    <button data-tab="recurring-expenses"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'"
                        data-i18n="tabRecurringExpenses">Ежемесячные</button>
                    <button data-tab="expenses"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'"
                        data-i18n="tabMonthlyExpenses">Расходы</button>
                    <button data-tab="tasks"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'" data-i18n="tabTasks">Задачи</button>
                    <button data-tab="calendar"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'" data-i18n="tabCalendar">Календарь</button>
                    <button data-tab="payments"
                        class="tab-button px-2 sm:px-3 md:px-4 py-1 sm:py-1.5 border-b-2 border-transparent whitespace-nowrap text-xs font-medium"
                        style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'"
                        onmouseout="this.style.color='var(--text-secondary)'" data-i18n="tabPayments">Оплата</button>
                </div>
            </nav>
        </div><!-- end of fixed-header -->

        <main>
            <div id="dashboard-page" class="page-content">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 md:mb-8 gap-4">
                    <div>
                        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200"
                            data-i18n="dashboardTitle">Сводка за месяц</h2>
                    </div>
                    <div class="w-full lg:w-auto">
                        <select id="month-selector"
                            class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent block w-full lg:w-48 p-2.5 md:p-3 shadow-sm hover:shadow-md transition-all duration-200"></select>
                    </div>
                </div>
                <div id="dashboard-loading" class="text-center p-8" data-i18n="loading">Загрузка данных...</div>
                <div id="dashboard-content" class="hidden">
                    <div class="flex flex-wrap gap-2 mb-6">
                        <div class="stat-card flex-1 min-w-[120px]">
                            <h3 class="text-xs font-medium mb-1 text-gray-500 dark:text-gray-400"
                                data-i18n="dashRecurringPaid">Ежемесячные (оплачено)</h3>
                            <p id="total-recurring-paid" class="text-lg font-bold" style="color: var(--accent-color);">0
                                AZN</p>
                        </div>
                        <div class="stat-card flex-1 min-w-[120px]">
                            <h3 class="text-xs font-medium mb-1 text-gray-500 dark:text-gray-400"
                                data-i18n="dashRecurringRemaining">Ежемесячные (осталось)</h3>
                            <p id="total-recurring-remaining" class="text-lg font-bold"
                                style="color: var(--accent-color);">0 AZN</p>
                        </div>
                        <div class="stat-card flex-1 min-w-[120px]">
                            <h3 class="text-xs font-medium mb-1 text-gray-500 dark:text-gray-400"
                                data-i18n="dashMonthlyExpenses">Расходы за месяц</h3>
                            <p id="total-monthly-outflow" class="text-lg font-bold" style="color: var(--accent-color);">
                                0 AZN</p>
                        </div>
                        <div class="stat-card flex-1 min-w-[120px]">
                            <h3 class="text-xs font-medium mb-1 text-gray-500 dark:text-gray-400"
                                data-i18n="dashTotalDebt">Остаток общего долга</h3>
                            <p id="total-debt-remaining" class="text-lg font-bold" style="color: var(--accent-color);">0
                                AZN</p>
                        </div>
                        <div class="stat-card flex-1 min-w-[120px]">
                            <h3 class="text-xs font-medium mb-1 text-gray-500 dark:text-gray-400"
                                data-i18n="dashTasksMonth">Осталось задач (месяц)</h3>
                            <p id="tasks-remaining-month" class="text-lg font-bold" style="color: var(--accent-color);">
                                0</p>
                        </div>
                        <div class="stat-card flex-1 min-w-[120px]">
                            <h3 class="text-xs font-medium mb-1 text-gray-500 dark:text-gray-400"
                                data-i18n="dashTasksYear">Осталось задач (год)</h3>
                            <p id="tasks-remaining-year" class="text-lg font-bold" style="color: var(--accent-color);">0
                            </p>
                        </div>
                    </div>

                    <!-- Chart and News Box Container -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                        <!-- Left Side - Enhanced Content -->
                        <div class="space-y-4">
                            <!-- Quick Stats Card -->
                            <div class="premium-card p-4">
                                <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);"
                                    data-i18n="dashTopCategories">Топ категорий расходов</h3>
                                <div class="max-h-64"><canvas id="expenses-chart"></canvas></div>
                            </div>

                            <!-- Quick Actions Card - Fixed with onclick handlers -->
                            <div class="premium-card p-4">
                                <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);"
                                    data-i18n="quickActionsTitle">Быстрые действия</h3>
                                <div class="grid grid-cols-2 gap-3" role="group" aria-label="Quick action buttons">
                                    <button onclick="document.getElementById('add-expense-btn').click()"
                                        class="premium-btn bg-gradient-to-r from-blue-600 to-blue-700 text-white px-3 py-2 text-sm rounded-lg hover:shadow-lg transition-all"
                                        data-i18n="addExpense" aria-label="Add new expense" title="Ctrl+E">
                                        Добавить расход
                                    </button>
                                    <button onclick="document.getElementById('add-daily-task-btn').click()"
                                        class="premium-btn bg-gradient-to-r from-green-600 to-green-700 text-white px-3 py-2 text-sm rounded-lg hover:shadow-lg transition-all"
                                        data-i18n="addTask" aria-label="Add new task" title="Ctrl+T">
                                        Добавить задачу
                                    </button>
                                    <button onclick="document.getElementById('add-debt-btn').click()"
                                        class="premium-btn bg-gradient-to-r from-purple-600 to-purple-700 text-white px-3 py-2 text-sm rounded-lg hover:shadow-lg transition-all"
                                        data-i18n="addDebt" aria-label="Add new debt" title="Ctrl+D">
                                        Добавить долг
                                    </button>
                                    <button onclick="document.getElementById('add-recurring-expense-btn').click()"
                                        class="premium-btn bg-gradient-to-r from-orange-600 to-orange-700 text-white px-3 py-2 text-sm rounded-lg hover:shadow-lg transition-all"
                                        data-i18n="addTemplate" aria-label="Add recurring expense template"
                                        title="Ctrl+R">
                                        Добавить шаблон
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Activity Card -->
                            <div class="premium-card p-4">
                                <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);"
                                    data-i18n="lastActivity">Последняя активность</h3>
                                <div id="recent-activity" class="space-y-2">
                                    <div class="flex items-center gap-2 text-sm">
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span style="color: var(--text-secondary);"
                                            data-i18n="activityExpenseAdded">Расход добавлен: Продукты - 25 AZN</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span style="color: var(--text-secondary);" data-i18n="activityTaskDone">Задача
                                            выполнена: Позвонить в банк</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        <span style="color: var(--text-secondary);" data-i18n="activityDebtUpdated">Долг
                                            обновлен: Кредит - 150 AZN</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 📰 КРАСИВЫЙ КОМПАКТНЫЙ ВИДЖЕТ НОВОСТЕЙ -->
                        <section id="news-widget" class="w-full">
                            <!-- Компактная панель управления -->
                            <div class="news-toolbar">
                                <div class="news-toolbar-left">
                                    <select id="news-category" class="news-select">
                                        <option value="" data-i18n-option="newsAllCategories">Все категории</option>
                                        <option value="technology" data-i18n-option="newsTechnology">💻 Технологии</option>
                                        <option value="business" data-i18n-option="newsBusiness">💼 Бизнес</option>
                                        <option value="science" data-i18n-option="newsScience">🔬 Наука</option>
                                        <option value="sports" data-i18n-option="newsSports">⚽ Спорт</option>
                                        <option value="health" data-i18n-option="newsHealth">🏥 Здоровье</option>
                                        <option value="entertainment" data-i18n-option="newsEntertainment">🎬 Развлечения</option>
                                    </select>
                                    <input type="text" id="news-search" placeholder="" class="news-search-input"/>
                                </div>
                                <button id="news-refresh" class="news-refresh-btn" title="Обновить">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                                </div>

                            <!-- Контейнер новостей -->
                            <div id="news-results" class="news-list"></div>
                            
                            <!-- Индикатор загрузки -->
                            <div id="news-loading" class="news-loading hidden">
                                <div class="news-spinner"></div>
                                <p>Загрузка новостей...</p>
                                </div>
                        </section>
                    </div>
                </div>
            </div>

            <div id="debts-page" class="page-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-200" data-i18n="debtsTitle">
                        Общие долги</h2><button id="add-debt-btn"
                        class="modern-btn bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 md:px-6 py-3 text-sm md:text-base"
                        data-i18n="addDebt">Добавить долг</button>
                </div>
                <div id="debts-table-wrapper"
                    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                    <table class="w-full text-sm text-left responsive-table">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-3" data-i18n="debtName">Долг (Имя)</th>
                                <th class="px-6 py-3" data-i18n="amount">Сумма</th>
                                <th class="px-6 py-3" data-i18n="paid">Оплачено</th>
                                <th class="px-6 py-3" data-i18n="remaining">Осталось</th>
                                <th class="px-6 py-3" data-i18n="lastPaymentDate">Дата последней оплаты</th>
                                <th class="px-6 py-3" data-i18n="comments">Комментарии</th>
                                <th class="px-6 py-3" data-i18n="actions">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="debts-table"></tbody>
                    </table>
                </div>
                <div id="debts-empty" class="hidden"></div>
            </div>

            <div id="recurring-expenses-page" class="page-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-200"><span
                            data-i18n="recurringTitle">Ежемесячные расходы</span> (<span
                            id="recurring-month-name"></span>)</h2><button id="add-recurring-expense-btn"
                        class="modern-btn bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 md:px-6 py-3 text-sm md:text-base"
                        data-i18n="addTemplate">Добавить шаблон</button>
                </div>
                <div id="recurring-expenses-table-wrapper"
                    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                    <table class="w-full text-sm text-left responsive-table">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-3" data-i18n="name">Наименование</th>
                                <th class="px-6 py-3" data-i18n="amount">Сумма</th>
                                <th class="px-6 py-3" data-i18n="paymentDay">День оплаты</th>
                                <th class="px-6 py-3" data-i18n="status">Статус оплаты</th>
                                <th class="px-6 py-3" data-i18n="details">Детали</th>
                                <th class="px-6 py-3" data-i18n="templateActions">Действия с шаблоном</th>
                            </tr>
                        </thead>
                        <tbody id="recurring-expenses-table"></tbody>
                    </table>
                </div>
                <div id="recurring-expenses-empty" class="hidden"></div>
            </div>

            <div id="expenses-page" class="page-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-200"><span
                            data-i18n="expensesTitle">Все расходы за</span> <span class="current-month-name"></span>
                    </h2>
                    <div class="flex flex-wrap gap-2"><button id="manage-categories-btn"
                            class="modern-btn bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-800 text-gray-800 dark:text-gray-200 px-4 md:px-6 py-3 text-sm md:text-base"
                            data-i18n="manageCategories">Управление категориями</button><button id="add-expense-btn"
                            class="modern-btn bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 md:px-6 py-3 text-sm md:text-base"
                            data-i18n="addExpense">Добавить расход</button></div>
                </div>
                <div id="expenses-table-wrapper"
                    class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                    <table class="w-full text-sm text-left responsive-table">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="px-6 py-3" data-i18n="name">Наименование</th>
                                <th class="px-6 py-3" data-i18n="category">Категория</th>
                                <th class="px-6 py-3" data-i18n="amount">Сумма</th>
                                <th class="px-6 py-3" data-i18n="date">Дата</th>
                                <th class="px-6 py-3" data-i18n="actions">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table"></tbody>
                    </table>
                </div>
                <div id="expenses-empty" class="hidden"></div>
            </div>

            <div id="tasks-page" class="page-content hidden">
                <!-- Task tabs redesigned: buttons with icons -->
                <div class="mb-6">
                    <nav class="flex flex-wrap gap-2" aria-label="Task Tabs">
                        <button class="task-tab-button task-tab-active" data-task-tab="today">
                            <!-- Day icon -->
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="5"></circle>
                                <g stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </g>
                            </svg>
                            <span data-i18n="taskToday">На сегодня</span>
                            <span class="ml-1">(</span><span id="today-date"></span><span>)</span>
                        </button>
                        <button class="task-tab-button" data-task-tab="month">
                            <!-- Month icon: four squares -->
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <rect x="3" y="4" width="6" height="6"></rect>
                                <rect x="3" y="12" width="6" height="6"></rect>
                                <rect x="11" y="4" width="6" height="6"></rect>
                                <rect x="11" y="12" width="6" height="6"></rect>
                            </svg>
                            <span data-i18n="taskMonth">На месяц</span>
                        </button>
                        <button class="task-tab-button" data-task-tab="year">
                            <!-- Long-term icon: bookmark shape -->
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 2a2 2 0 012-2h8a2 2 0 012 2v18l-6-4-6 4V2z"></path>
                            </svg>
                            <span data-i18n="taskYear">Долгосрочный</span>
                        </button>
                    </nav>
                </div>
                <div id="task-tab-today" class="task-tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" data-i18n="taskTodayTitle">Задачи на сегодня</h3><button
                            id="add-daily-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"
                            data-i18n="addTask">Добавить задачу</button>
                    </div>
                    <div id="daily-tasks-table-wrapper"
                        class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                        <table class="w-full text-sm text-left responsive-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="w-1/3 px-6 py-3" data-i18n="name">Имя</th>
                                    <th class="px-6 py-3" data-i18n="status">Статус</th>
                                    <th class="w-1/3 px-6 py-3" data-i18n="notes">Заметки</th>
                                    <th class="px-6 py-3" data-i18n="actions">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="daily-tasks-table"></tbody>
                        </table>
                    </div>
                    <div id="daily-tasks-empty" class="hidden"></div>
                </div>
                <div id="task-tab-month" class="task-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" data-i18n="taskMonthTitle">Задачи на месяц</h3><button
                            id="add-monthly-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"
                            data-i18n="addTask">Добавить задачу</button>
                    </div>
                    <div id="monthly-tasks-table-wrapper"
                        class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                        <table class="w-full text-sm text-left responsive-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="px-6 py-3" data-i18n="name">Имя</th>
                                    <th class="px-6 py-3" data-i18n="deadline">Дедлайн</th>
                                    <th class="px-6 py-3" data-i18n="status">Статус</th>
                                    <th class="px-6 py-3" data-i18n="actions">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-tasks-table"></tbody>
                        </table>
                    </div>
                    <div id="monthly-tasks-empty" class="hidden"></div>
                </div>
                <div id="task-tab-year" class="task-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold" data-i18n="taskYearTitle">Задачи на год</h3><button
                            id="add-yearly-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"
                            data-i18n="addTask">Добавить задачу</button>
                    </div>
                    <div id="yearly-tasks-table-wrapper"
                        class="bg-white rounded-lg shadow-sm overflow-x-auto md:bg-transparent md:shadow-none">
                        <table class="w-full text-sm text-left responsive-table">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="w-1/3 px-6 py-3" data-i18n="name">Имя</th>
                                    <th class="px-6 py-3" data-i18n="deadline">Дедлайн</th>
                                    <th class="px-6 py-3" data-i18n="status">Статус</th>
                                    <th class="w-1/3 px-6 py-3" data-i18n="notes">Заметки</th>
                                    <th class="px-6 py-3" data-i18n="actions">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="yearly-tasks-table"></tbody>
                        </table>
                    </div>
                    <div id="yearly-tasks-empty" class="hidden"></div>
                </div>
            </div>

            <div id="calendar-page" class="page-content hidden">
                <div class="premium-card p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn"
                            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="calendar-month-year" class="text-xl font-semibold" style="color: var(--text-primary);">
                        </h2>
                        <button id="next-month-btn"
                            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div id="calendar-weekdays"
                        class="grid grid-cols-7 gap-1 text-center font-semibold text-sm mb-2 p-2"
                        style="color: var(--accent-color); background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>

            <div id="payments-page" class="page-content hidden">
                <iframe src="https://hesab.az/" class="w-full h-screen border-0"></iframe>
            </div>

        </main>
    </div>

    <!-- Модальные окна -->
    <dialog id="debt-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="debt-modal-title" class="text-xl font-semibold mb-4" data-i18n="addDebt"></h3>
            <form id="debt-form" data-original-paid="0"><input type="hidden" id="debt-id">
                <div class="mb-4"><label for="debt-name" class="block mb-2 text-sm font-medium"
                        data-i18n="debtorName">Имя должника/Название</label><input type="text" id="debt-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="debt-total" class="block mb-2 text-sm font-medium"><span
                            data-i18n="totalAmount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="debt-total" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="debt-paid" class="block mb-2 text-sm font-medium"><span
                            data-i18n="paidAmount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="debt-paid" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required value="0"></div>
                <div class="mb-4"><label for="debt-comment" class="block mb-2 text-sm font-medium"
                        data-i18n="comment">Комментарий</label><textarea id="debt-comment" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="debt-payment-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 class="text-xl font-semibold mb-4" data-i18n="addDebtPayment">Добавить платеж по долгу</h3>
            <form id="debt-payment-form"><input type="hidden" id="debt-payment-id">
                <div class="mb-4"><label for="debt-payment-amount" class="block mb-2 text-sm font-medium"><span
                            data-i18n="paymentAmount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="debt-payment-amount" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="add">Добавить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="recurring-expense-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="recurring-expense-modal-title" class="text-xl font-semibold mb-4" data-i18n="addTemplate"></h3>
            <form id="recurring-expense-form"><input type="hidden" id="recurring-expense-id">
                <div class="mb-4"><label for="recurring-expense-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Наименование</label><input type="text" id="recurring-expense-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="recurring-expense-amount" class="block mb-2 text-sm font-medium"><span
                            data-i18n="amount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="recurring-expense-amount" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="recurring-expense-due-day" class="block mb-2 text-sm font-medium"
                        data-i18n="paymentDayNum">День оплаты (1-31)</label><input type="number"
                        id="recurring-expense-due-day" min="1" max="31"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="recurring-expense-details" class="block mb-2 text-sm font-medium"
                        data-i18n="details">Детали</label><textarea id="recurring-expense-details" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="expense-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="expense-modal-title" class="text-xl font-semibold mb-4" data-i18n="addExpense"></h3>
            <form id="expense-form"><input type="hidden" id="expense-id">
                <div class="mb-4"><label for="expense-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Наименование</label><input type="text" id="expense-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="expense-category" class="block mb-2 text-sm font-medium"
                        data-i18n="category">Категория</label><input type="text" id="expense-category"
                        list="expense-categories-list" class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"
                        required><datalist id="expense-categories-list"></datalist></div>
                <div class="mb-4"><label for="expense-amount" class="block mb-2 text-sm font-medium"><span
                            data-i18n="amount"></span> (<span class="currency-symbol">AZN</span>)</label><input
                        type="number" id="expense-amount" step="0.01"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="expense-date" class="block mb-2 text-sm font-medium"
                        data-i18n="date">Дата</label><input type="date" id="expense-date"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="daily-task-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="daily-task-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="daily-task-form"><input type="hidden" id="daily-task-id">
                <div class="mb-4"><label for="daily-task-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Имя</label><input type="text" id="daily-task-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="daily-task-notes" class="block mb-2 text-sm font-medium"
                        data-i18n="notes">Заметки</label><textarea id="daily-task-notes" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="monthly-task-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="monthly-task-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="monthly-task-form"><input type="hidden" id="monthly-task-id">
                <div class="mb-4"><label for="monthly-task-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Имя</label><input type="text" id="monthly-task-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="monthly-task-deadline" class="block mb-2 text-sm font-medium"
                        data-i18n="deadline">Дедлайн</label><input type="date" id="monthly-task-deadline"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="yearly-task-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="yearly-task-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="yearly-task-form"><input type="hidden" id="yearly-task-id">
                <div class="mb-4"><label for="yearly-task-name" class="block mb-2 text-sm font-medium"
                        data-i18n="name">Имя</label><input type="text" id="yearly-task-name"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="yearly-task-deadline" class="block mb-2 text-sm font-medium"
                        data-i18n="deadline">Дедлайн</label><input type="date" id="yearly-task-deadline"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="mb-4"><label for="yearly-task-notes" class="block mb-2 text-sm font-medium"
                        data-i18n="notes">Заметки</label><textarea id="yearly-task-notes" rows="3"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></textarea></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button"
                        class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="cancel">Отмена</button><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="save">Сохранить</button></div>
            </form>
        </div>
    </dialog>
    <dialog id="event-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 id="event-modal-title" class="text-xl font-semibold mb-4"></h3>
            <form id="event-form"><input type="hidden" id="event-id">
                <div class="mb-4"><label for="event-category" class="block mb-2 text-sm font-medium"
                        data-i18n="category">Категория</label><select id="event-category"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="event" data-i18n="categoryEvent">Событие</option>
                        <option value="birthday" data-i18n="categoryBirthday">День рождения</option>
                        <option value="meeting" data-i18n="categoryMeeting">Встреча</option>
                        <option value="wedding" data-i18n="categoryWedding">Свадьба</option>
                    </select></div>
                <div id="event-fields-event" class="event-category-fields">
                    <div class="mb-4"><label for="event-name-generic" class="block mb-2 text-sm font-medium"
                            data-i18n="eventName">Название события</label><input type="text" id="event-name-generic"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                </div>
                <div id="event-fields-birthday" class="event-category-fields hidden">
                    <div class="mb-4"><label for="event-birthday-name" class="block mb-2 text-sm font-medium"
                            data-i18n="birthdayName">Имя именинника</label><input type="text" id="event-birthday-name"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                    <div class="mb-4"><label for="event-birthday-year" class="block mb-2 text-sm font-medium"
                            data-i18n="birthYear">Год рождения (опционально)</label><input type="number"
                            id="event-birthday-year" placeholder="1990"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                </div>
                <div id="event-fields-meeting" class="event-category-fields hidden">
                    <div class="mb-4"><label for="event-meeting-with" class="block mb-2 text-sm font-medium"
                            data-i18n="meetingWith">С кем</label><input type="text" id="event-meeting-with"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="event-meeting-time" class="block mb-2 text-sm font-medium"
                                data-i18n="time">Время (опц.)</label><input type="time" id="event-meeting-time"
                                class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                        <div><label for="event-meeting-place" class="block mb-2 text-sm font-medium"
                                data-i18n="place">Место (опц.)</label><input type="text" id="event-meeting-place"
                                class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                    </div>
                </div>
                <div id="event-fields-wedding" class="event-category-fields hidden">
                    <div class="mb-4"><label for="event-wedding-names" class="block mb-2 text-sm font-medium"
                            data-i18n="weddingNames">Имена пары</label><input type="text" id="event-wedding-names"
                            class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5"></div>
                </div>
                <div class="mb-4"><label for="event-date" class="block mb-2 text-sm font-medium"
                        data-i18n="date">Дата</label><input type="date" id="event-date"
                        class="bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required></div>
                <div class="flex items-center mb-4"><input id="event-create-task" type="checkbox" checked
                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><label
                        for="event-create-task" class="ml-2 text-sm font-medium text-gray-900"
                        data-i18n="createTaskForEvent">Создать задачу для этого события</label></div>
                <div class="flex justify-between items-center mt-6"><button type="button" id="delete-event-btn"
                        class="text-red-600 hover:text-red-800 hidden" data-i18n="delete">Удалить</button>
                    <div class="flex justify-end gap-4"><button type="button"
                            class="cancel-btn text-gray-600 hover:text-gray-900"
                            data-i18n="cancel">Отмена</button><button type="submit"
                            class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                            data-i18n="save">Сохранить</button></div>
                </div>
            </form>
        </div>
    </dialog>
    <dialog id="category-modal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
            <h3 class="text-xl font-semibold mb-4" data-i18n="manageCategoriesTitle">Управление категориями</h3>
            <form id="category-form" class="mb-4">
                <div class="flex gap-2"><input type="text" id="category-name" placeholder="Новая категория"
                        class="flex-grow bg-gray-50 border border-gray-300 rounded-lg w-full p-2.5" required><button
                        type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700"
                        data-i18n="add">Добавить</button></div>
            </form>
            <div id="category-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-end mt-6"><button type="button"
                    class="cancel-btn text-gray-600 hover:text-gray-900" data-i18n="close">Закрыть</button></div>
        </div>
    </dialog>

    <!-- Custom Confirm Modal -->
    <dialog id="confirm-modal" class="p-0 rounded-lg shadow-xl w-full max-w-sm">
        <div class="p-6 text-center">
            <svg class="mx-auto mb-4 text-gray-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 20 20">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <p id="confirm-modal-text" class="mb-5 text-lg font-normal text-gray-600"></p>
            <button id="confirm-modal-yes" type="button"
                class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center me-2">
                Да, удалить
            </button>
            <button id="confirm-modal-no" type="button"
                class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                Нет, отмена
            </button>
        </div>
    </dialog>

    <!-- Toast Container -->
    <div id="toast-container"></div>


    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot,
            collection, query, where, Timestamp, writeBatch, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDi0cFirxRJ9eC6mvy1WEDpB9MPzDDac3g",
            authDomain: "life-order-assistant.firebaseapp.com",
            projectId: "life-order-assistant",
            storageBucket: "life-order-assistant.appspot.com",
            messagingSenderId: "284691407205",
            appId: "1:284691407205:web:a6e935c498b280ce55c18c",
            measurementId: "G-E1MWRNNKDM"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app').innerHTML = `<div class="p-4 text-center text-red-500">
                <h1 class="text-2xl font-bold">Ошибка конфигурации Firebase</h1>
                <p>Пожалуйста, убедитесь, что вы правильно вставили ваш <b>firebaseConfig</b> в HTML-файл.</p>
            </div>`;
        }

        let userId = null;
        let currentMonthId;
        let selectedMonthId;

        let currentCurrency = localStorage.getItem('currency') || 'AZN';
        const exchangeRate = 1.70;

        let allDebts = [], allExpenses = [], allRecurringTemplates = [], currentMonthStatuses = {};
        let dailyTasks = [], monthlyTasks = [], yearlyTasks = [];
        let calendarEvents = [];
        let calendarDate = new Date();

        let debtsCol, recurringExpensesCol, expensesCol, monthlyDataCol, recurringExpenseStatusesCol;
        let dailyTasksCol, monthlyTasksCol, yearlyTasksCol, calendarEventsCol, categoriesCol;

        let unsubscribes = [];
        let expensesChart = null;
        let dateTimeInterval = null;

        const translations = {
            ru: {
                appTitle: "ORDINA", appSubtitle: "Управляй своей жизнью с легкостью",
                tabDashboard: "Сводка", tabDebts: "Долги", tabRecurringExpenses: "Ежемесячные расходы", tabMonthlyExpenses: "Расходы месяца", tabTasks: "Список задач", tabCalendar: "Календарь",
                dashboardTitle: "Сводка за месяц", loading: "Загрузка данных...",
                dashRecurringPaid: "Ежемесячные (оплачено)", dashRecurringRemaining: "Ежемесячные (осталось)", dashMonthlyExpenses: "Расходы за месяц", dashTotalDebt: "Остаток общего долга", dashTopCategories: "Топ категорий расходов",
                debtsTitle: "Общие долги", addDebt: "Добавить долг", debtName: "Долг (Имя)", amount: "Сумма", paid: "Оплачено", remaining: "Осталось", lastPaymentDate: "Дата последней оплаты", comments: "Комментарии", actions: "Действия", emptyDebts: "Список долгов пуст. Нажмите кнопку 'Добавить долг', чтобы начать.",
                recurringTitle: "Ежемесячные расходы", addTemplate: "Добавить шаблон", paymentDay: "День оплаты", status: "Статус", details: "Детали", templateActions: "Действия с шаблоном", emptyRecurring: "Список ежемесячных расходов пуст. Создайте шаблон.",
                expensesTitle: "Все расходы за", addExpense: "Добавить расход", category: "Категория", date: "Дата", emptyExpenses: "Расходов в этом месяце еще нет.",
                taskToday: "На сегодня", taskMonth: "На месяц", taskYear: "Долгосрочный", taskTodayTitle: "Задачи на сегодня", taskMonthTitle: "Задачи на месяц", taskYearTitle: "Долгосрочные задачи", addTask: "Добавить задачу", name: "Имя", notes: "Заметки", deadline: "Дедлайн", emptyTasks: "Список задач пуст.",
                cancel: "Отмена", save: "Сохранить", add: "Добавить", delete: "Удалить", close: "Закрыть",
                debtorName: "Имя должника/Название", totalAmount: "Общая сумма", paidAmount: "Оплаченная сумма", comment: "Комментарий",
                addDebtPayment: "Добавить платеж по долгу", paymentAmount: "Сумма платежа", paymentDayNum: "День оплаты (1-31)",
                deleteConfirm: "Вы уверены, что хотите удалить это?",
                paidStatus: "Оплачено", unpaidStatus: "Не оплачено",
                statusDone: "Выполнено", statusNotDone: "Не выполнено", statusSkipped: "Пропущено",
                editDebt: "Редактировать долг", editTemplate: "Редактировать шаблон", editExpense: "Редактировать расход", editTask: "Редактировать задачу",
                addTaskForToday: "Добавить задачу на сегодня", addTaskForMonth: "Добавить задачу на месяц", addTaskForYear: "Добавить долгосрочную задачу",
                chartLabel: "Расходы",
                dashTasksMonth: "Осталось задач (месяц)", dashTasksYear: "Осталось задач (год)",
                debtRepayments: "Погашение долгов", recurringPayments: "Ежемесячные платежи",
                placeholderComment: "Добавить комментарий...",
                addEvent: "Добавить событие", editEvent: "Редактировать событие", eventName: "Название события", createTaskForEvent: "Создать задачу для этого события",
                weekdays: ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"],
                categoryEvent: "Событие", categoryBirthday: "День рождения", categoryMeeting: "Встреча", categoryWedding: "Свадьба",
                birthdayName: "Имя именинника", birthYear: "Год рождения (опционально)", meetingWith: "С кем", time: "Время (опц.)", place: "Место (опц.)", weddingNames: "Имена пары",
                taskCongratulate: "Поздравить", taskTurning: "исполняется", taskYearsOld: "лет", taskMeetWith: "Встретиться с", taskWeddingOf: "Свадьба",
                authTitle: "Войдите в свой аккаунт", login: "Войти", register: "Зарегистрироваться", logout: "Выйти", loginWithGoogle: "Войти через Google",
                authInvalidEmail: "Неверный формат email адреса.",
                authEmailInUse: "Этот email уже зарегистрирован.",
                authWeakPassword: "Пароль слишком слабый. Он должен содержать не менее 6 символов.",
                authInvalidCredentials: "Неверный email или пароль.",
                authGenericError: "Произошла ошибка. Попробуйте снова.",
                manageCategories: "Управление категориями", manageCategoriesTitle: "Управление категориями",
                toastSuccess: "Успешно сохранено!", toastError: "Ошибка сохранения!", toastDeleted: "Запись удалена.",
                radioTitle: "AzerbaiJazz Radio",
                tabPayments: "Оплата",
                shoppingListTitle: "Список покупок",
                shoppingListCopy: "Копировать",
                shoppingListQuantity: "Кол-во",
                shoppingListProduct: "Название товара",
                shoppingListPrice: "Цена (AZN)",
                shoppingListAdd: "Добавить",
                shoppingListTotal: "Итого",
                shoppingListQuantityColumn: "Кол-во",
                shoppingListProductColumn: "Товар",
                shoppingListPriceColumn: "Цена",
                shoppingListSumColumn: "Сумма",
                shoppingListActionsColumn: "Действия",
                toPurchase: "К ПРИОБРЕТЕНИЮ",
                purchased: "КУПЛЕНО",
                generalTotal: "ОБЩАЯ СУММА",
                newsBoxTitle: "Новости",
                prev: "Назад",
                next: "Вперед",
                quickActionsTitle: "Быстрые действия",
                weatherLocation: "Локация",
                newsCountry: "Страна",
                newsCategory: "Категория",
                newsAllCountries: "Все страны",
                newsAzerbaijan: "Азербайджан",
                newsRussia: "Россия",
                newsUSA: "США",
                newsUK: "Великобритания",
                newsGermany: "Германия",
                newsTurkey: "Турция",
                newsUkraine: "Украина",
                newsFrance: "Франция",
                newsItaly: "Италия",
                newsSpain: "Испания",
                newsChina: "Китай",
                newsGeneral: "Общее",
                newsBusiness: "Бизнес",
                newsTech: "Технологии",
                newsScience: "Наука",
                newsPolitics: "Политика",
                newsEconomy: "Экономика",
                newsWar: "Война",
                newsCulture: "Культура",
                newsHealth: "Здоровье",
                newsSport: "Спорт",
                weatherLoading: "Загрузка...",
                weatherError: "Ошибка загрузки",
                weatherLocationError: "Геолокация недоступна",
                weatherLocationSuccess: "Геолокация получена",
                weatherUpdated: "Погода обновлена для города",
                radioTitle: "AzerbaiJazz Radio",
                radioPlaying: "Играет",
                radioPaused: "Пауза",
                newsNotFound: "Новости не найдены",
                lastActivity: "Последняя активность",
                activityExpenseAdded: "Расход добавлен: Продукты - 25 AZN",
                activityTaskDone: "Задача выполнена: Позвонить в банк",
                activityDebtUpdated: "Долг обновлен: Кредит - 150 AZN",
                months: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
                monthsShort: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"],
                weekdaysFull: ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"],
                weatherCityPlaceholder: "Баку",
                weatherCitySearchPlaceholder: "Город...",
                weatherGeoTitle: "По геолокации",
                weatherRefresh: "Обновить погоду",
                newsSource: "Источник",
                newsPublished: "Опубликовано",
                newsLoadingNews: "Загрузка новостей...",
                newsNoNews: "Новости не найдены",
                newsAllCategories: "Все категории",
                newsTechnology: "💻 Технологии",
                newsBusiness: "💼 Бизнес",
                newsScience: "🔬 Наука",
                newsSports: "⚽ Спорт",
                newsHealth: "🏥 Здоровье",
                newsEntertainment: "🎬 Развлечения",
                newsSearchPlaceholder: "Поиск...",
                newsRefresh: "Обновить",
                newsArticlesLoaded: "новостей загружено",
                newsError: "Ошибка загрузки новостей",
            },
            en: {
                appTitle: "ORDINA", appSubtitle: "Manage your life with ease",
                tabDashboard: "Dashboard", tabDebts: "Debts", tabRecurringExpenses: "Recurring Expenses", tabMonthlyExpenses: "Monthly Expenses", tabTasks: "Task List", tabCalendar: "Calendar",
                dashboardTitle: "Monthly Dashboard", loading: "Loading data...",
                dashRecurringPaid: "Recurring (Paid)", dashRecurringRemaining: "Recurring (Remaining)", dashMonthlyExpenses: "Monthly Expenses", dashTotalDebt: "Total Debt Remaining", dashTopCategories: "Top Expense Categories",
                debtsTitle: "All Debts", addDebt: "Add Debt", debtName: "Debt (Name)", amount: "Amount", paid: "Paid", remaining: "Remaining", lastPaymentDate: "Last Payment Date", comments: "Comments", actions: "Actions", emptyDebts: "Debt list is empty. Click 'Add Debt' to start.",
                recurringTitle: "Recurring Expenses", addTemplate: "Add Template", paymentDay: "Payment Day", status: "Status", details: "Details", templateActions: "Template Actions", emptyRecurring: "Recurring expense list is empty. Create a template.",
                expensesTitle: "All Expenses for", addExpense: "Add Expense", category: "Category", date: "Date", emptyExpenses: "No expenses for this month yet.",
                taskToday: "Today", taskMonth: "Month", taskYear: "Long-term", taskTodayTitle: "Today's Tasks", taskMonthTitle: "Monthly Tasks", taskYearTitle: "Long-term Tasks", addTask: "Add Task", name: "Name", notes: "Notes", deadline: "Deadline", emptyTasks: "Task list is empty.",
                cancel: "Cancel", save: "Save", add: "Add", delete: "Delete", close: "Close",
                debtorName: "Debtor Name/Title", totalAmount: "Total Amount", paidAmount: "Paid Amount", comment: "Comment",
                addDebtPayment: "Add Debt Payment", paymentAmount: "Payment Amount", paymentDayNum: "Payment Day (1-31)",
                deleteConfirm: "Are you sure you want to delete this?",
                paidStatus: "Paid", unpaidStatus: "Unpaid",
                statusDone: "Done", statusNotDone: "Not Done", statusSkipped: "Skipped",
                editDebt: "Edit Debt", editTemplate: "Edit Template", editExpense: "Edit Expense", editTask: "Edit Task",
                addTaskForToday: "Add Task for Today", addTaskForMonth: "Add Task for Month", addTaskForYear: "Add Long-term Task",
                chartLabel: "Expenses",
                dashTasksMonth: "Tasks Remaining (Month)", dashTasksYear: "Tasks Remaining (Year)",
                debtRepayments: "Debt Repayments", recurringPayments: "Recurring Payments",
                placeholderComment: "Add a comment...",
                addEvent: "Add Event", editEvent: "Edit Event", eventName: "Event Name", createTaskForEvent: "Create a task for this event",
                weekdays: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                categoryEvent: "Event", categoryBirthday: "Birthday", categoryMeeting: "Meeting", categoryWedding: "Wedding",
                birthdayName: "Birthday person's name", birthYear: "Year of birth (optional)", meetingWith: "With whom", time: "Time (opt.)", place: "Place (opt.)", weddingNames: "Couple's names",
                taskCongratulate: "Congratulate", taskTurning: "turning", taskYearsOld: "years old", taskMeetWith: "Meet with", taskWeddingOf: "Wedding of",
                authTitle: "Sign in to your account", login: "Sign in", register: "Register", logout: "Log out", loginWithGoogle: "Sign in with Google",
                authInvalidEmail: "Invalid email format.",
                authEmailInUse: "This email is already in use.",
                authWeakPassword: "Password is too weak. It should be at least 6 characters.",
                authInvalidCredentials: "Invalid email or password.",
                authGenericError: "An error occurred. Please try again.",
                manageCategories: "Manage Categories", manageCategoriesTitle: "Manage Categories",
                toastSuccess: "Saved successfully!", toastError: "Error saving!", toastDeleted: "Entry deleted.",
                shoppingListTitle: "Shopping List",
                shoppingListCopy: "Copy",
                shoppingListQuantity: "Qty",
                shoppingListProduct: "Product Name",
                shoppingListPrice: "Price (AZN)",
                shoppingListAdd: "Add",
                shoppingListTotal: "Total",
                shoppingListQuantityColumn: "Qty",
                shoppingListProductColumn: "Product",
                shoppingListPriceColumn: "Price",
                shoppingListSumColumn: "Sum",
                shoppingListActionsColumn: "Actions",
                toPurchase: "TO PURCHASE",
                purchased: "PURCHASED",
                generalTotal: "GRAND TOTAL",
                newsBoxTitle: "News",
                prev: "Previous",
                next: "Next",
                quickActionsTitle: "Quick Actions",
                weatherLocation: "Location",
                newsCountry: "Country",
                newsCategory: "Category",
                newsAllCountries: "All Countries",
                newsAzerbaijan: "Azerbaijan",
                newsRussia: "Russia",
                newsUSA: "USA",
                newsUK: "United Kingdom",
                newsGermany: "Germany",
                newsTurkey: "Turkey",
                newsUkraine: "Ukraine",
                newsFrance: "France",
                newsItaly: "Italy",
                newsSpain: "Spain",
                newsChina: "China",
                newsGeneral: "General",
                newsBusiness: "Business",
                newsTech: "Technology",
                newsScience: "Science",
                newsPolitics: "Politics",
                newsEconomy: "Economy",
                newsWar: "War",
                newsCulture: "Culture",
                newsHealth: "Health",
                newsSport: "Sports",
                weatherLoading: "Loading...",
                weatherError: "Loading error",
                weatherLocationError: "Geolocation unavailable",
                weatherLocationSuccess: "Geolocation obtained",
                weatherUpdated: "Weather updated for city",
                radioTitle: "AzerbaiJazz Radio",
                radioPlaying: "Playing",
                radioPaused: "Paused",
                newsNotFound: "No news found",
                lastActivity: "Recent Activity",
                activityExpenseAdded: "Expense added: Groceries - 25 AZN",
                activityTaskDone: "Task completed: Call the bank",
                activityDebtUpdated: "Debt updated: Credit - 150 AZN",
                months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                weekdaysFull: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                weatherCityPlaceholder: "Baku",
                weatherCitySearchPlaceholder: "City...",
                weatherGeoTitle: "By geolocation",
                weatherRefresh: "Refresh weather",
                newsSource: "Source",
                newsPublished: "Published",
                newsLoadingNews: "Loading news...",
                newsNoNews: "No news found",
                newsAllCategories: "All Categories",
                newsTechnology: "💻 Technology",
                newsBusiness: "💼 Business",
                newsScience: "🔬 Science",
                newsSports: "⚽ Sports",
                newsHealth: "🏥 Health",
                newsEntertainment: "🎬 Entertainment",
                newsSearchPlaceholder: "Search...",
                newsRefresh: "Refresh",
                newsArticlesLoaded: "news articles loaded",
                newsError: "Failed to load news",
                tabPayments: "Payments",
            },
            az: {
                appTitle: "ORDINA", appSubtitle: "Həyatını asanlıqla idarə et",
                tabDashboard: "Ümumi", tabDebts: "Borclar", tabRecurringExpenses: "Aylıq xərclər", tabMonthlyExpenses: "Aylıq xərclər", tabTasks: "Tapşırıqlar", tabCalendar: "Təqvim",
                dashboardTitle: "Aylıq ümumi", loading: "Məlumatlar yüklənir...",
                dashRecurringPaid: "Aylıq (ödənilmiş)", dashRecurringRemaining: "Aylıq (qalan)", dashMonthlyExpenses: "Aylıq xərclər", dashTotalDebt: "Ümumi borc qalığı", dashTopCategories: "Əsas xərc kateqoriyaları",
                debtsTitle: "Bütün borclar", addDebt: "Borç əlavə et", debtName: "Borç (Ad)", amount: "Məbləğ", paid: "Ödənilmiş", remaining: "Qalan", lastPaymentDate: "Son ödəniş tarixi", comments: "Şərhlər", actions: "Əməлијјатлар", emptyDebts: "Borclar siyahısı boşdur. Başlamaq üçün 'Borç əlavə et' düyməsini basın.",
                recurringTitle: "Aylıq xərclər", addTemplate: "Şablon əlavə et", paymentDay: "Ödəniş günü", status: "Status", details: "Təfərrüatlar", templateActions: "Şablon əməliyyatları", emptyRecurring: "Aylıq xərclər siyahısı boşdur. Şablon yaradın.",
                expensesTitle: "Bütün xərclər", addExpense: "Xərc əlavə et", category: "Kateqoriya", date: "Tarix", emptyExpenses: "Bu ay üçün hələ xərc yoxdur.",
                taskToday: "Bu gün", taskMonth: "Ay", taskYear: "Uzunmüddətli", taskTodayTitle: "Bu günkü tapşırıqlar", taskMonthTitle: "Aylıq tapşırıqlar", taskYearTitle: "Uzunmüddətli tapşırıqlar", addTask: "Tapşırıq əlavə et", name: "Ad", notes: "Qeydlər", deadline: "Müddət", emptyTasks: "Tapşırıqlar siyahısı boşdur.",
                cancel: "Ləğv et", save: "Saxla", add: "Əlavə et", delete: "Sil", close: "Bağla",
                debtorName: "Borclu adı/Başlıq", totalAmount: "Ümumi məbləğ", paidAmount: "Ödənilmiş məbləğ", comment: "Şərh",
                addDebtPayment: "Borç ödənişi əlavə et", paymentAmount: "Ödəniş məbləği", paymentDayNum: "Ödəniş günü (1-31)",
                deleteConfirm: "Bunu silmək istədiyinizə əminsiniz?",
                paidStatus: "Ödənilmiş", unpaidStatus: "Ödənilməmiş",
                statusDone: "Tamamlanmış", statusNotDone: "Tamamlanmamış", statusSkipped: "Keçilmiş",
                editDebt: "Borcu redaktə et", editTemplate: "Şablonu redaktə et", editExpense: "Xərci redaktə et", editTask: "Tapşırığı redaktə et",
                addTaskForToday: "Bu gün üçün tapşırıq əlavə et", addTaskForMonth: "Ay üçün tapşırıq əlavə et", addTaskForYear: "Uzunmüddətli tapşırıq əlavə et",
                chartLabel: "Xərclər",
                dashTasksMonth: "Qalan tapşırıqlar (ay)", dashTasksYear: "Qalan tapşırıqlar (il)",
                debtRepayments: "Borç ödənişləri", recurringPayments: "Aylıq ödənişlər",
                placeholderComment: "Şərh əlavə edin...",
                addEvent: "Tədbir əlavə et", editEvent: "Tədbiri redaktə et", eventName: "Tədbir adı", createTaskForEvent: "Bu tədbir üçün tapşırıq yaradın",
                weekdays: ["B.E", "Ç.A", "Ç", "C.A", "C", "Ş", "B"],
                categoryEvent: "Tədbir", categoryBirthday: "Ad günü", categoryMeeting: "Görüş", categoryWedding: "Toy",
                birthdayName: "Ad günü olan şəxsin adı", birthYear: "Doğum ili (istəyə bağlı)", meetingWith: "Kiminlə", time: "Vaxt (istəyə bağlı)", place: "Yer (istəyə bağlı)", weddingNames: "Cütlüyün adları",
                taskCongratulate: "Təbrik et", taskTurning: "yaşını tamamlayır", taskYearsOld: "yaşında", taskMeetWith: "ilə görüş", taskWeddingOf: "Toyu",
                authTitle: "Hesabınıza daxil olun", login: "Daxil ol", register: "Qeydiyyat", logout: "Çıxış", loginWithGoogle: "Google ilə daxil ol",
                authInvalidEmail: "Yanlış email formatı.",
                authEmailInUse: "Bu email artıq istifadə olunur.",
                authWeakPassword: "Parol çox zəifdir. Ən azı 6 simvol olmalıdır.",
                authInvalidCredentials: "Yanlış email və ya parol.",
                authGenericError: "Xəta baş verdi. Yenidən cəhd edin.",
                manageCategories: "Kateqoriyaları idarə et", manageCategoriesTitle: "Kateqoriyaları idarə et",
                toastSuccess: "Uğurla yadda saxlanıldı!", toastError: "Yaddaş xətası!", toastDeleted: "Yazı silindi.",
                shoppingListTitle: "Alış-veriş siyahısı",
                shoppingListCopy: "Kopyala",
                shoppingListQuantity: "Miqdar",
                shoppingListProduct: "Məhsul adı",
                shoppingListPrice: "Qiymət (AZN)",
                shoppingListAdd: "Əlavə et",
                shoppingListTotal: "Cəmi",
                shoppingListQuantityColumn: "Miqdar",
                shoppingListProductColumn: "Məhsul",
                shoppingListPriceColumn: "Qiymət",
                shoppingListSumColumn: "Məbləğ",
                shoppingListActionsColumn: "Əməliyyatlar",
                toPurchase: "ALINMALI",
                purchased: "ALINMIŞ",
                generalTotal: "ÜMUMİ CƏMİ",
                newsBoxTitle: "Xəbərlər",
                prev: "Geri",
                next: "İrəli",
                quickActionsTitle: "Sürətli əməliyyatlar",
                weatherLocation: "Yer",
                newsCountry: "Ölkə",
                newsCategory: "Kateqoriya",
                newsAllCountries: "Bütün ölkələr",
                newsAzerbaijan: "Azərbaycan",
                newsRussia: "Rusiya",
                newsUSA: "ABŞ",
                newsUK: "Böyük Britaniya",
                newsGermany: "Almaniya",
                newsTurkey: "Türkiyə",
                newsUkraine: "Ukrayna",
                newsFrance: "Fransa",
                newsItaly: "İtaliya",
                newsSpain: "İspaniya",
                newsChina: "Çin",
                newsGeneral: "Ümumi",
                newsBusiness: "Biznes",
                newsTech: "Texnologiya",
                newsScience: "Elm",
                newsPolitics: "Siyasət",
                newsEconomy: "İqtisadiyyat",
                newsWar: "Müharibə",
                newsCulture: "Mədəniyyət",
                newsHealth: "Sağlamlıq",
                newsSport: "İdman",
                weatherLoading: "Yüklənir...",
                weatherError: "Yükləmə xətası",
                weatherLocationError: "Geolokasiya əlçatan deyil",
                weatherLocationSuccess: "Geolokasiya əldə edildi",
                weatherUpdated: "Hava şəhər üçün yeniləndi",
                radioTitle: "AzerbaiJazz Radio",
                radioPlaying: "Oynayır",
                radioPaused: "Pauza",
                newsNotFound: "Xəbər tapılmadı",
                lastActivity: "Son fəaliyyət",
                activityExpenseAdded: "Xərc əlavə edildi: Məhsullar - 25 AZN",
                activityTaskDone: "Tapşırıq tamamlandı: Banka zəng et",
                activityDebtUpdated: "Borc yeniləndi: Kredit - 150 AZN",
                months: ["Yanvar", "Fevral", "Mart", "Aprel", "May", "İyun", "İyul", "Avqust", "Sentyabr", "Oktyabr", "Noyabr", "Dekabr"],
                monthsShort: ["Yan", "Fev", "Mar", "Apr", "May", "İyn", "İyl", "Avq", "Sen", "Okt", "Noy", "Dek"],
                weekdaysFull: ["Bazar ertəsi", "Çərşənbə axşamı", "Çərşənbə", "Cümə axşamı", "Cümə", "Şənbə", "Bazar"],
                weatherCityPlaceholder: "Bakı",
                weatherCitySearchPlaceholder: "Şəhər...",
                weatherGeoTitle: "Geolokasiya ilə",
                weatherRefresh: "Hava məlumatını yenilə",
                newsSource: "Mənbə",
                newsPublished: "Dərc edilib",
                newsLoadingNews: "Xəbərlər yüklənir...",
                newsNoNews: "Xəbər tapılmadı",
                newsAllCategories: "Bütün kateqoriyalar",
                newsTechnology: "💻 Texnologiya",
                newsBusiness: "💼 Biznes",
                newsScience: "🔬 Elm",
                newsSports: "⚽ İdman",
                newsHealth: "🏥 Sağlamlıq",
                newsEntertainment: "🎬 Əyləncə",
                newsSearchPlaceholder: "Axtarış...",
                newsRefresh: "Yenilə",
                newsArticlesLoaded: "xəbər yükləndi",
                newsError: "Xəbərlərin yüklənməsində xəta",
                tabPayments: "Ödənişlər",
            }
        };
        let currentLang = localStorage.getItem('appLanguage') || 'ru';

        function getTodayISOString() {
            const today = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Baku' };
            return new Intl.DateTimeFormat('en-CA', options).format(today);
        }
        function formatISODateForDisplay(isoString, options = {}) {
            if (!isoString || typeof isoString !== 'string' || !isoString.includes('-')) return '—';
            const [year, month, day] = isoString.split('-').map(Number);
            const monthIndex = month - 1;
            
            // Используем массив месяцев из локализации вместо toLocaleDateString для гарантии правильного отображения
            const monthName = translations[currentLang]?.months?.[monthIndex] || '';
            if (!monthName) {
                // Fallback на toLocaleDateString если массив не найден
            const locale = currentLang === 'ru' ? 'ru-RU' : (currentLang === 'az' ? 'az-Latn-AZ' : 'en-US');
                return new Date(year, monthIndex, day).toLocaleDateString(locale, { day: 'numeric', month: 'long', ...(options.year && { year: 'numeric' }) });
            }
            
            let result = `${day} ${monthName}`;
            if (options.year) {
                result += ` ${year}`;
            }
            return result;
        }
        function formatMonthId(monthId) {
            if (!monthId) return '';
            const [year, month] = monthId.split('-');
            const monthIndex = parseInt(month) - 1;
            
            // Используем массив месяцев из локализации
            const monthName = translations[currentLang].months[monthIndex];
            return `${monthName} ${year}`;
        }

        function applyDynamicTranslations() {
            // textContent translations
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (translations[currentLang][key]) el.textContent = translations[currentLang][key];
            });
            // placeholders
            const weatherCityInputEl = document.getElementById('weather-city-input');
            if (weatherCityInputEl) weatherCityInputEl.placeholder = translations[currentLang].weatherCityPlaceholder || '';
            const weatherSearchInputEl = document.getElementById('weather-search-input');
            if (weatherSearchInputEl && translations[currentLang].weatherCitySearchPlaceholder) {
                weatherSearchInputEl.placeholder = translations[currentLang].weatherCitySearchPlaceholder;
            }
            const locationBtn = document.getElementById('weather-location-btn');
            if (locationBtn) locationBtn.title = translations[currentLang].weatherGeoTitle || '';
            
            // News widget translations
            const newsSearchInput = document.getElementById('news-search');
            if (newsSearchInput) {
                newsSearchInput.placeholder = translations[currentLang].newsSearchPlaceholder || 'Search...';
            }
            
            const newsCategorySelect = document.getElementById('news-category');
            if (newsCategorySelect) {
                const options = newsCategorySelect.querySelectorAll('option[data-i18n-option]');
                options.forEach(opt => {
                    const key = opt.dataset.i18nOption;
                    if (translations[currentLang][key]) {
                        const emoji = opt.textContent.match(/^[^\w\s]+/)?.[0] || '';
                        opt.textContent = emoji + translations[currentLang][key];
                    }
                });
            }
            
            const newsRefreshBtn = document.getElementById('news-refresh');
            if (newsRefreshBtn) {
                newsRefreshBtn.title = translations[currentLang].newsRefresh || 'Refresh';
            }
        }

        function setLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang;
            applyDynamicTranslations();
            updateLanguageButtons();
            updateMonthDisplay();
            renderCalendar();
            // re-render weather with translated description/time format
            try { updateWeatherNew(currentWeatherCity || 'Baku'); } catch (e) { /* noop */ }
            // re-fetch or re-render news to reflect UI language
            try { fetchNews(); } catch (e) { try { renderNews(); } catch (_) { } }
            attachListeners();
        }

        function updateLanguageButtons() {
            // Update login language buttons
            ['ru-login', 'en-login', 'az-login'].forEach(lang => {
                const btn = document.getElementById(`lang-${lang}`);
                if (btn) {
                    if (lang.replace('-login', '') === currentLang) {
                        btn.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-blue-600 text-white';
                    } else {
                        btn.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300';
                    }
                }
            });

            // Update dropdown UI
            const flagMap = {
                'ru': 'https://flagcdn.com/w40/ru.png',
                'en': 'https://flagcdn.com/w40/gb.png',
                'az': 'https://flagcdn.com/w40/az.png'
            };

            const languageFlag = document.getElementById('language-flag');
            if (languageFlag) {
                languageFlag.src = flagMap[currentLang];
            }

            // Update dropdown options
            document.querySelectorAll('.language-option').forEach(opt => {
                const isActive = opt.dataset.lang === currentLang;
                opt.classList.toggle('active', isActive);
            });
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app');
        function showLoginScreen() { loadingOverlay.classList.add('hidden'); authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); }
        function showApp() { authContainer.classList.add('hidden'); appContainer.classList.remove('hidden'); }

        async function setupDefaultData(user) {
            const categoriesRef = collection(db, `users/${user.uid}/categories`);
            const q = query(categoriesRef, limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                const batch = writeBatch(db);
                const defaultCategories = {
                    ru: ["Продукты", "Транспорт", "Жилье", "Здоровье", "Развлечения", "Одежда", "Кафе и рестораны", "Подарки", "Связь и интернет", "Образование"],
                    en: ["Groceries", "Transport", "Housing", "Health", "Entertainment", "Clothing", "Cafes & Restaurants", "Gifts", "Communication & Internet", "Education"],
                    az: ["Ərzaq", "Nəqliyyat", "Mənzil", "Sağlamlıq", "Əyləncə", "Geyim", "Kafe və Restoranlar", "Hədiyyələr", "Rabitə və İnternet", "Təhsil"]
                };
                for (const [lang, names] of Object.entries(defaultCategories)) {
                    names.forEach(name => {
                        const newCatRef = doc(categoriesRef);
                        batch.set(newCatRef, { name, lang });
                    });
                }
                await batch.commit();
            }
        }

        if (auth) {
            // Login language buttons
            const langRuLogin = document.getElementById('lang-ru-login');
            const langEnLogin = document.getElementById('lang-en-login');
            const langAzLogin = document.getElementById('lang-az-login');
            
            if (langRuLogin) langRuLogin.addEventListener('click', () => setLanguage('ru'));
            if (langEnLogin) langEnLogin.addEventListener('click', () => setLanguage('en'));
            if (langAzLogin) langAzLogin.addEventListener('click', () => setLanguage('az'));

            // Language dropdown
            const langDropdownBtn = document.getElementById('language-dropdown-btn');
            const langDropdownMenu = document.getElementById('language-dropdown-menu');

            if (langDropdownBtn && langDropdownMenu) {
                langDropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    langDropdownMenu.classList.toggle('show');
                });

                document.querySelectorAll('.language-option').forEach(opt => {
                    opt.addEventListener('click', () => {
                        const lang = opt.dataset.lang;
                        setLanguage(lang);
                        langDropdownMenu.classList.remove('show');
                    });
                });

                // Close when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.language-dropdown')) {
                        langDropdownMenu.classList.remove('show');
                    }
                });
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const todayISO = getTodayISOString();
                    currentMonthId = todayISO.slice(0, 7);
                    selectedMonthId = currentMonthId;
                    calendarDate = new Date(todayISO + 'T00:00:00');

                    await setupDefaultData(user);
                    showApp();
                    setupCollections(todayISO);
                    await checkAndCarryOverDailyTasks(todayISO);
                    await checkAndCarryOverTasks();
                    await ensureRecurringTasksForMonth(selectedMonthId);
                    attachListeners();
                    setLanguage(currentLang);

                    // Wait for DOM to be fully ready
                    setTimeout(() => {
                        updateDateTime();
                        if (dateTimeInterval) clearInterval(dateTimeInterval);
                        dateTimeInterval = setInterval(updateDateTime, 60000);

                        // Initialize weather and news after DOM is ready
                        initWeatherNew();
                        initNews();
                    }, 1000);
                } else { showLoginScreen(); }
            });
        } else {
            console.error('Firebase Auth не инициализирован');
            showLoginScreen();
        }

        function setupCollections(todayId = getTodayISOString()) {
            if (!userId) return;
            // Если selectedMonthId не установлен, используем текущий месяц
            if (!selectedMonthId) {
                const todayISO = getTodayISOString();
                selectedMonthId = todayISO.slice(0, 7);
            }
            debtsCol = collection(db, `users/${userId}/debts`);
            recurringExpensesCol = collection(db, `users/${userId}/recurringExpenses`);
            monthlyDataCol = collection(db, `users/${userId}/monthlyData`);
            // Обновляем expensesCol с актуальным selectedMonthId при каждой смене месяца
            expensesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/expenses`);
            recurringExpenseStatusesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/recurringExpenseStatuses`);
            dailyTasksCol = collection(db, `users/${userId}/dailyTasks/${todayId}/tasks`);
            monthlyTasksCol = collection(db, `users/${userId}/monthlyTasks`);
            yearlyTasksCol = collection(db, `users/${userId}/yearlyTasks`);
            calendarEventsCol = collection(db, `users/${userId}/calendarEvents`);
            categoriesCol = collection(db, `users/${userId}/categories`);
        }

        async function checkAndCarryOverDailyTasks(todayId) {
            const lastCheckKey = `lastDailyCheck_${userId}`;
            const lastCheck = localStorage.getItem(lastCheckKey);
            if (lastCheck === todayId) return;
            const yesterday = new Date(todayId + 'T00:00:00');
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayId = yesterday.toISOString().split('T')[0];
            if (lastCheck && lastCheck < todayId) {
                try {
                    const yesterdayTasksCol = collection(db, `users/${userId}/dailyTasks/${yesterdayId}/tasks`);
                    const q = query(yesterdayTasksCol, where("status", "==", translations.ru.statusNotDone));
                    const tasksToCarryOverSnapshot = await getDocs(q);
                    if (!tasksToCarryOverSnapshot.empty) {
                        const batch = writeBatch(db);
                        const todayTasksColRef = collection(db, `users/${userId}/dailyTasks/${todayId}/tasks`);
                        tasksToCarryOverSnapshot.forEach(docSnap => {
                            const taskData = docSnap.data();
                            const newTaskRef = doc(todayTasksColRef);
                            const originalDate = taskData.originalDate || yesterdayId;
                            batch.set(newTaskRef, {
                                ...taskData,
                                notes: `(Перенесено с ${formatISODateForDisplay(yesterdayId)}) ${taskData.notes || ''}`.trim(),
                                carriedOver: true,
                                originalDate: originalDate,
                                carriedOverFrom: yesterdayId
                            });
                        });
                        await batch.commit();
                    }
                } catch (error) { showToast(translations[currentLang].toastError, 'error'); }
            }
            localStorage.setItem(lastCheckKey, todayId);
        }

        async function checkAndCarryOverTasks() {
            const lastCheckKey = `taskCarryOverMonth_${userId}`;
            const lastCheck = localStorage.getItem(lastCheckKey);
            if (lastCheck !== currentMonthId) {
                const prevMonthDate = new Date(currentMonthId + '-01T00:00:00');
                prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
                const prevMonthId = prevMonthDate.toISOString().slice(0, 7);
                const q = query(monthlyTasksCol, where("month", "==", prevMonthId), where("status", "==", translations.ru.statusNotDone));
                const tasksSnapshot = await getDocs(q);
                const batch = writeBatch(db);
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    if (!task.fromCalendar) batch.update(doc.ref, { month: currentMonthId, carriedOver: true });
                });
                await batch.commit();
                localStorage.setItem(lastCheckKey, currentMonthId);
            }
        }

        async function ensureRecurringTasksForMonth(monthId) {
            if (!userId) return;
            const [year, month] = monthId.split('-');
            const t = translations[currentLang];
            const q = query(calendarEventsCol, where("category", "==", "birthday"));
            const birthdayEventsSnapshot = await getDocs(q);
            const batch = writeBatch(db);
            for (const eventDoc of birthdayEventsSnapshot.docs) {
                const event = eventDoc.data();
                if (event.date.substring(5, 7) === month) {
                    const taskQuery = query(monthlyTasksCol, where("fromCalendar", "==", eventDoc.id), where("month", "==", monthId));
                    const existingTasksSnapshot = await getDocs(taskQuery);
                    if (existingTasksSnapshot.empty) {
                        let taskName = `${t.taskCongratulate} ${event.birthdayName}`;
                        if (event.birthYear) { const age = parseInt(year) - parseInt(event.birthYear); if (age >= 0) taskName += ` (${t.taskTurning} ${age} ${t.taskYearsOld})`; }
                        const deadline = `${monthId}-${event.date.substring(8)}`;
                        batch.set(doc(monthlyTasksCol), { name: taskName, deadline, status: translations.ru.statusNotDone, month: monthId, year: parseInt(year), fromCalendar: eventDoc.id });
                    }
                }
            }
            await batch.commit();
        }

        function updateDateTime() { /* removed separate date strip per requirements */ }

        function updateMonthDisplay() {
            const formattedDate = formatMonthId(selectedMonthId);
            document.querySelectorAll('.current-month-name').forEach(el => {
                if (el) el.textContent = formattedDate;
            });
            const recurringMonthNameEl = document.getElementById('recurring-month-name');
            const todayDateEl = document.getElementById('today-date');
            if (recurringMonthNameEl) recurringMonthNameEl.textContent = formattedDate;
            if (todayDateEl) todayDateEl.textContent = formatISODateForDisplay(getTodayISOString(), { year: undefined });
        }

        // Weather functions (remove legacy placeholder)
        // (legacy stub removed)

        // 🌤️ NEW PREMIUM WEATHER WIDGET - OpenWeatherMap API
        let currentWeatherCity = 'Baku';
        const OPENWEATHER_API_KEY = '91b705287b193e8debf755a8ff4cb0c7';
        
        // Weather icon mapping
        const weatherIcons = {
            '01d': '<circle cx="12" cy="12" r="5" stroke-width="2"/><line x1="12" y1="1" x2="12" y2="3" stroke-width="2"/><line x1="12" y1="21" x2="12" y2="23" stroke-width="2"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke-width="2"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke-width="2"/><line x1="1" y1="12" x2="3" y2="12" stroke-width="2"/><line x1="21" y1="12" x2="23" y2="12" stroke-width="2"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke-width="2"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke-width="2"/>',
            '01n': '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"/>',
            '02d': '<circle cx="12" cy="12" r="4" stroke-width="2"/><path d="M20 20c-2-2-4-3-8-3s-6 1-8 3" stroke-width="2"/>',
            '02n': '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"/><path d="M20 20c-2-2-4-3-8-3s-6 1-8 3" stroke-width="2"/>',
            '03d': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/>',
            '03n': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/>',
            '04d': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><path d="M16 8a4 4 0 0 0-8 0" stroke-width="2"/>',
            '04n': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><path d="M16 8a4 4 0 0 0-8 0" stroke-width="2"/>',
            '09d': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><line x1="8" y1="19" x2="8" y2="21" stroke-width="2"/><line x1="12" y1="19" x2="12" y2="21" stroke-width="2"/><line x1="16" y1="19" x2="16" y2="21" stroke-width="2"/>',
            '09n': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><line x1="8" y1="19" x2="8" y2="21" stroke-width="2"/><line x1="12" y1="19" x2="12" y2="21" stroke-width="2"/><line x1="16" y1="19" x2="16" y2="21" stroke-width="2"/>',
            '10d': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><line x1="8" y1="19" x2="8" y2="21" stroke-width="2"/><line x1="12" y1="19" x2="12" y2="21" stroke-width="2"/>',
            '10n': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><line x1="8" y1="19" x2="8" y2="21" stroke-width="2"/><line x1="12" y1="19" x2="12" y2="21" stroke-width="2"/>',
            '11d': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><polyline points="13 13 11 16 13 16 11 19" stroke-width="2"/>',
            '11n': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><polyline points="13 13 11 16 13 16 11 19" stroke-width="2"/>',
            '13d': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><line x1="8" y1="19" x2="8.01" y2="19" stroke-width="3" stroke-linecap="round"/><line x1="12" y1="19" x2="12.01" y2="19" stroke-width="3" stroke-linecap="round"/><line x1="16" y1="19" x2="16.01" y2="19" stroke-width="3" stroke-linecap="round"/>',
            '13n': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" stroke-width="2"/><line x1="8" y1="19" x2="8.01" y2="19" stroke-width="3" stroke-linecap="round"/><line x1="12" y1="19" x2="12.01" y2="19" stroke-width="3" stroke-linecap="round"/><line x1="16" y1="19" x2="16.01" y2="19" stroke-width="3" stroke-linecap="round"/>',
            '50d': '<path d="M3 15h18M3 9h18M3 21h18" stroke-width="2" stroke-linecap="round"/>',
            '50n': '<path d="M3 15h18M3 9h18M3 21h18" stroke-width="2" stroke-linecap="round"/>'
        };

        async function geocodeToCity(lat, lon) {
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`);
                const d = await r.json();
                return d.address?.city || d.address?.town || d.address?.village || d.address?.state || 'Baku';
            } catch (_) { return 'Baku'; }
        }

        function formatLocalDateTime(timezone) {
            const now = new Date();
            const timeZone = timezone || 'Asia/Baku';
            
            // Получаем дату и время в указанном часовом поясе
            const dateStr = now.toLocaleString('en-US', { timeZone: timeZone, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            const parts = dateStr.match(/(\d+)\/(\d+)\/(\d+),\s*(\d+):(\d+)/);
            if (!parts) {
                // Fallback на стандартный формат
                const locale = currentLang === 'ru' ? 'ru-RU' : (currentLang === 'az' ? 'az-Latn-AZ' : 'en-US');
            return now.toLocaleString(locale, {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit',
                    timeZone: timeZone
                });
            }
            
            const monthIndex = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            const year = parseInt(parts[3]);
            const hour = parts[4].padStart(2, '0');
            const minute = parts[5].padStart(2, '0');
            
            // Создаем Date объект для получения дня недели
            const dateObj = new Date(year, monthIndex, day);
            const weekdayIndex = dateObj.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
            
            // Используем наши массивы для месяцев и дней недели
            const monthShort = translations[currentLang]?.monthsShort?.[monthIndex] || '';
            // Адаптируем день недели: JavaScript возвращает 0-6 (воскресенье = 0), наш массив начинается с понедельника (Bazar ertəsi)
            let weekdayShort = '';
            if (translations[currentLang]?.weekdaysFull) {
                // Если неделя начинается с понедельника в массиве [0=Пн, 1=Вт, ..., 6=Вс]
                const adjustedIndex = weekdayIndex === 0 ? 6 : weekdayIndex - 1; // Воскресенье -> 6 (последний элемент)
                const weekdayFull = translations[currentLang].weekdaysFull[adjustedIndex] || '';
                weekdayShort = weekdayFull.substring(0, 3);
            }
            
            // Если массивы не найдены, используем toLocaleString как fallback
            if (!monthShort || !weekdayShort) {
                const locale = currentLang === 'ru' ? 'ru-RU' : (currentLang === 'az' ? 'az-Latn-AZ' : 'en-US');
                return now.toLocaleString(locale, {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: timeZone
                });
            }
            
            return `${weekdayShort}, ${day} ${monthShort}, ${hour}:${minute}`;
        }

        function translateWeatherDesc(desc) {
            const map = {
                ru: { 'clear sky': 'Ясно', 'few clouds': 'Малооблачно', 'scattered clouds': 'Переменная облачность', 'broken clouds': 'Облачно', 'overcast clouds': 'Пасмурно', 'light rain': 'Небольшой дождь', 'moderate rain': 'Умеренный дождь', 'heavy rain': 'Сильный дождь', 'thunderstorm': 'Гроза', 'snow': 'Снег', 'mist': 'Дымка', 'fog': 'Туман' },
                en: { 'clear sky': 'Clear Sky', 'few clouds': 'Few Clouds', 'scattered clouds': 'Scattered Clouds', 'broken clouds': 'Broken Clouds', 'overcast clouds': 'Overcast', 'light rain': 'Light Rain', 'moderate rain': 'Moderate Rain', 'heavy rain': 'Heavy Rain', 'thunderstorm': 'Thunderstorm', 'snow': 'Snow', 'mist': 'Mist', 'fog': 'Fog' },
                az: { 'clear sky': 'Açıq', 'few clouds': 'Az buludlu', 'scattered clouds': 'Dağınıq buludlar', 'broken clouds': 'Buludlu', 'overcast clouds': 'Tutqun', 'light rain': 'Yüngül yağış', 'moderate rain': 'Orta yağış', 'heavy rain': 'Güclü yağış', 'thunderstorm': 'Ildırım', 'snow': 'Qar', 'mist': 'Duman', 'fog': 'Sis' }
            };
            const table = map[currentLang] || map.en;
            return table[desc.toLowerCase()] || desc;
        }

        async function updateWeatherNew(city = 'Baku') {
            try {
                currentWeatherCity = city;
                
                // Show loading state
                const tempEl = document.getElementById('weather-temp-new');
                const cityEl = document.getElementById('weather-city-new');
                const descEl = document.getElementById('weather-desc-new');
                const datetimeEl = document.getElementById('weather-datetime-new');
                const iconEl = document.getElementById('weather-animated-icon');

                if (tempEl) tempEl.textContent = '...';
                if (cityEl) cityEl.textContent = city;
                if (descEl) descEl.textContent = translations[currentLang].weatherLoading || 'Loading...';

                // Fetch weather data from OpenWeatherMap
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=${currentLang}`);
                
                if (!res.ok) throw new Error('Weather API error');
                
                const data = await res.json();
                
                // Update UI
                const temp = Math.round(data.main.temp);
                const feelsLike = Math.round(data.main.feels_like);
                const humidity = data.main.humidity;
                const pressure = data.main.pressure;
                const windSpeed = Math.round(data.wind.speed);
                const description = translateWeatherDesc(data.weather[0].description);
                const iconCode = data.weather[0].icon;
                // OpenWeatherMap returns timezone offset in seconds
                const timezoneOffset = data.timezone || 0;

                if (tempEl) tempEl.textContent = temp;
                if (cityEl) cityEl.textContent = data.name;
                if (descEl) descEl.textContent = description;
                // Format date and time using UTC offset (OpenWeatherMap returns offset in seconds from UTC)
                if (datetimeEl) {
                    const now = new Date();
                    const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
                    const localTime = new Date(utcTime + (timezoneOffset * 1000));
                    
                    // Используем наши массивы месяцев вместо toLocaleString
                    const monthIndex = localTime.getMonth();
                    const day = localTime.getDate();
                    const weekdayIndex = localTime.getDay();
                    const hour = localTime.getHours().toString().padStart(2, '0');
                    const minute = localTime.getMinutes().toString().padStart(2, '0');
                    
                    const monthShort = translations[currentLang]?.monthsShort?.[monthIndex] || '';
                    let weekdayShort = '';
                    if (translations[currentLang]?.weekdaysFull) {
                        const adjustedIndex = weekdayIndex === 0 ? 6 : weekdayIndex - 1;
                        weekdayShort = (translations[currentLang].weekdaysFull[adjustedIndex] || '').substring(0, 3);
                    }
                    
                    if (monthShort && weekdayShort) {
                        datetimeEl.textContent = `${weekdayShort}, ${day} ${monthShort} • ${hour}:${minute}`;
                    } else {
                        // Fallback если массивы не найдены
                        const locale = currentLang === 'ru' ? 'ru-RU' : currentLang === 'az' ? 'az-Latn-AZ' : 'en-US';
                        const dateStr = localTime.toLocaleDateString(locale, { weekday: 'short', day: 'numeric', month: 'short' });
                        const timeStr = localTime.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                        datetimeEl.textContent = `${dateStr} • ${timeStr}`;
                    }
                }
                // Update icon
                if (iconEl) {
                    const iconSvg = weatherIcons[iconCode] || weatherIcons['01d'];
                    iconEl.innerHTML = `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">${iconSvg}</svg>`;
                }

                showToast(`${translations[currentLang].weatherUpdated || 'Weather updated for'} ${data.name}`, 'success');
            } catch (e) {
                console.error('Weather error:', e);
                const tempEl = document.getElementById('weather-temp-new');
                const descEl = document.getElementById('weather-desc-new');
                if (tempEl) tempEl.textContent = '--';
                if (descEl) descEl.textContent = translations[currentLang].weatherError || 'Error loading weather';
                showToast(translations[currentLang].weatherError || 'Error loading weather', 'error');
            }
        }

        function initWeatherNew() {
            const searchInput = document.getElementById('weather-search-input');
            const searchBtn = document.getElementById('weather-search-btn');
            const locationBtn = document.getElementById('weather-location-btn-new');
            const refreshBtn = document.getElementById('weather-refresh-btn-new');

            const performSearch = () => {
                const city = searchInput?.value?.trim();
                if (city) {
                    updateWeatherNew(city);
                }
            };

            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            }

            if (searchBtn) {
                searchBtn.addEventListener('click', performSearch);
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    updateWeatherNew(currentWeatherCity);
                });
            }

            if (locationBtn && navigator.geolocation) {
                locationBtn.addEventListener('click', () => {
                    navigator.geolocation.getCurrentPosition(
                        async ({ coords }) => {
                            const city = await geocodeToCity(coords.latitude, coords.longitude);
                            if (searchInput) searchInput.value = city;
                            updateWeatherNew(city);
                            showToast(translations[currentLang].weatherLocationSuccess || 'Location detected', 'success');
                        },
                        () => {
                            showToast(translations[currentLang].weatherLocationError || 'Location unavailable', 'error');
                        }
                    );
                });
            }

            // Initial load
            updateWeatherNew('Baku');
        }

        // 📰 БЕСПЛАТНЫЙ RSS NEWS WIDGET - ЛОКАЛИЗОВАННЫЕ ИСТОЧНИКИ
        let newsData = [];
        let currentNewsCategory = '';
        let currentNewsSearch = '';
        
        // RSS источники новостей по языкам (бесплатные, не требуют API ключа)
        const RSS_SOURCES = {
            'ru': {
                'all': [
                    'https://lenta.ru/rss',
                    'https://www.kommersant.ru/RSS/news.xml',
                    'https://ria.ru/export/rss2/index.xml',
                    'https://www.gazeta.ru/export/rss/lenta.xml'
                ],
                'technology': [
                    'https://habr.com/ru/rss/flows/develop/all/',
                    'https://habr.com/ru/rss/flows/infosecurity/all/',
                    'https://vc.ru/rss'
                ],
                'business': [
                    'https://www.kommersant.ru/RSS/economics.xml',
                    'https://www.vedomosti.ru/rss/news',
                    'https://www.rbc.ru/rss/frontpage.xml'
                ],
                'science': [
                    'https://nauka.tass.ru/rss',
                    'https://scientificrussia.ru/rss.xml'
                ],
                'sports': [
                    'https://www.championat.com/rss/news.xml',
                    'https://rsport.ria.ru/export/rss2/index.xml'
                ],
                'health': [
                    'https://www.takzdorovo.ru/rss/',
                    'https://www.aif.ru/rss/health.xml'
                ],
                'entertainment': [
                    'https://www.kinopoisk.ru/media/rss/rss_top_movies.xml',
                    'https://www.kp.ru/rss/incidents.xml'
                ]
            },
            'az': {
                'all': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss',
                    'https://www.aztv.az/rss',
                    'https://news.milli.az/rss'
                ],
                'technology': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss'
                ],
                'business': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss'
                ],
                'science': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss'
                ],
                'sports': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss'
                ],
                'health': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss'
                ],
                'entertainment': [
                    'https://azertag.az/rss/ru',
                    'https://report.az/rss'
                ]
            },
            'en': {
                'all': [
                    'https://rss.cnn.com/rss/edition.rss',
                    'https://feeds.bbci.co.uk/news/world/rss.xml',
                    'https://www.theguardian.com/world/rss',
                    'https://rss.nytimes.com/services/xml/rss/nyt/World.xml'
                ],
                'technology': [
                    'https://feeds.feedburner.com/oreilly/radar',
                    'https://techcrunch.com/feed/',
                    'https://www.theverge.com/rss/index.xml'
                ],
                'business': [
                    'https://feeds.reuters.com/reuters/businessNews',
                    'https://www.bloomberg.com/feed/topics/economics'
                ],
                'science': [
                    'https://www.scientificamerican.com/rss/all/',
                    'https://feeds.nature.com/nature/rss/current'
                ],
                'sports': [
                    'https://www.espn.com/espn/rss/news',
                    'https://feeds.bbci.co.uk/sport/rss.xml'
                ],
                'health': [
                    'https://www.webmd.com/rss/rss.aspx?RSSSource=RSS_PUBLIC'
                ],
                'entertainment': [
                    'https://www.rollingstone.com/rss/',
                    'https://feeds.feedburner.com/oreilly/radar'
                ]
            }
        };
        
        // Функция получения источников для текущего языка
        function getRSSSourcesForLanguage(lang, category = 'all') {
            const langSources = RSS_SOURCES[lang] || RSS_SOURCES['en'];
            return langSources[category] || langSources['all'] || [];
        }

        // Парсинг RSS через бесплатный сервис
        async function parseRSSFeed(url) {
            try {
                // Используем CORS proxy для обхода ограничений
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error('RSS fetch failed');
                
                const data = await res.json();
                const xmlText = data.contents;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const items = xmlDoc.querySelectorAll('item');
                const articles = [];
                
                items.forEach(item => {
                    const title = item.querySelector('title')?.textContent || '';
                    const desc = item.querySelector('description')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || '';
                    
                    // Извлекаем изображение из медиа-контента или описания
                    let image = '';
                    const mediaContent = item.querySelector('media\\:content, content');
                    if (mediaContent && mediaContent.getAttribute('url')) {
                        image = mediaContent.getAttribute('url');
            } else {
                        const imgMatch = desc.match(/<img[^>]+src="([^"]+)"/);
                        if (imgMatch) image = imgMatch[1];
                    }
                    
                    articles.push({
                        title: title.replace(/<[^>]*>/g, '').trim(),
                        desc: desc.replace(/<[^>]*>/g, '').trim().substring(0, 200),
                        image: image,
                        url: link,
                        source: url.split('/')[2]?.replace('www.', '') || 'News',
                        publishedAt: pubDate,
                        categories: []
                    });
                });
                
                return articles;
            } catch (e) {
                console.error('RSS parse error:', e);
                return [];
            }
        }

        async function fetchNews() {
            const newsLoading = document.getElementById('news-loading');
            const newsResults = document.getElementById('news-results');
            
            if (newsLoading) newsLoading.classList.remove('hidden');
            if (newsResults) newsResults.innerHTML = '';

            try {
                // Определяем какие RSS источники использовать в зависимости от языка
                const categoryKey = currentNewsCategory || 'all';
                const rssUrls = getRSSSourcesForLanguage(currentLang, categoryKey);
                
                if (rssUrls.length === 0) {
                    // Fallback на английские источники если для языка нет
                    const fallbackUrls = RSS_SOURCES['en'][categoryKey] || RSS_SOURCES['en']['all'];
                    rssUrls.push(...fallbackUrls);
                }
                
                // Загружаем новости из всех источников категории (ограничиваем до 2 для скорости)
                const allArticles = [];
                const promises = rssUrls.slice(0, 2).map(url => parseRSSFeed(url));
                const results = await Promise.all(promises);
                
                results.forEach(articles => {
                    allArticles.push(...articles);
                });
                
                // Фильтруем по поисковому запросу если есть
                if (currentNewsSearch) {
                    const searchLower = currentNewsSearch.toLowerCase();
                    newsData = allArticles.filter(article => 
                        article.title.toLowerCase().includes(searchLower) ||
                        article.desc.toLowerCase().includes(searchLower)
                    );
                } else {
                    newsData = allArticles;
                }
                
                // Сортируем по дате и ограничиваем до 20
                newsData.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                newsData = newsData.slice(0, 20);

            renderNews();
                showToast(`${newsData.length} ${translations[currentLang].newsArticlesLoaded || 'news articles loaded'}`, 'success');
            } catch (e) {
                console.error('News fetch error:', e);
                newsResults.innerHTML = `
                    <div class="news-empty">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p data-i18n="newsError">Ошибка загрузки новостей</p>
                    </div>
                `;
                setTimeout(() => {
                    const errorText = newsResults.querySelector('[data-i18n="newsError"]');
                    if (errorText && translations[currentLang].newsError) {
                        errorText.textContent = translations[currentLang].newsError;
                    }
                }, 0);
                showToast(translations[currentLang].newsError || 'Failed to load news', 'error');
            } finally {
            if (newsLoading) newsLoading.classList.add('hidden');
            }
        }

        function renderNews() {
            const newsResults = document.getElementById('news-results');
            if (!newsResults) return;

            if (newsData.length === 0) {
                newsResults.innerHTML = `
                    <div class="news-empty">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                        </svg>
                        <p data-i18n="newsNoNews">Новости не найдены</p>
                    </div>
                `;
                // Применяем перевод после добавления в DOM
                setTimeout(() => {
                    const emptyText = newsResults.querySelector('[data-i18n="newsNoNews"]');
                    if (emptyText && translations[currentLang].newsNoNews) {
                        emptyText.textContent = translations[currentLang].newsNoNews;
                    }
                }, 0);
                return;
            }

            newsResults.innerHTML = newsData.map((news) => {
                const date = new Date(news.publishedAt);
                // Используем наши массивы месяцев вместо toLocaleDateString
                const monthIndex = date.getMonth();
                const day = date.getDate();
                const hour = date.getHours().toString().padStart(2, '0');
                const minute = date.getMinutes().toString().padStart(2, '0');
                const monthShort = translations[currentLang]?.monthsShort?.[monthIndex] || '';
                const formattedDate = monthShort ? `${day} ${monthShort}, ${hour}:${minute}` : date.toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : currentLang === 'az' ? 'az-Latn-AZ' : 'en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const cleanTitle = news.title.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                const cleanDesc = (news.desc || '').substring(0, 120).replace(/'/g, '&#39;').replace(/"/g, '&quot;');

                return `
                    <article class="news-item" onclick="window.open('${news.url}', '_blank', 'noopener,noreferrer')">
                        ${news.image ? `
                            <div class="news-item-image">
                                <img src="${news.image}" alt="${cleanTitle}" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="news-item-image-placeholder" style="display:none;">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                                    </svg>
                            </div>
                        </div>
                        ` : `
                            <div class="news-item-image-placeholder">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                                </svg>
                    </div>
                        `}
                        <div class="news-item-content">
                            <div class="news-item-header">
                                <span class="news-item-source">${news.source}</span>
                                <span class="news-item-date">${formattedDate}</span>
                </div>
                            <h3 class="news-item-title">${cleanTitle}</h3>
                            ${news.desc ? `<p class="news-item-desc">${cleanDesc}${news.desc.length > 120 ? '...' : ''}</p>` : ''}
                        </div>
                        <div class="news-item-arrow">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function initNews() {
            const categorySelect = document.getElementById('news-category');
            const searchInput = document.getElementById('news-search');
            const refreshBtn = document.getElementById('news-refresh');

            if (categorySelect) {
                categorySelect.addEventListener('change', (e) => {
                    currentNewsCategory = e.target.value;
                    fetchNews();
                });
            }

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        currentNewsSearch = e.target.value.trim();
                    fetchNews();
                    }, 500);
                });
                
                // Also allow Enter key
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        currentNewsSearch = e.target.value.trim();
                        fetchNews();
                    }
                });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    fetchNews();
                });
            }

            // Initial load
            fetchNews();
        }

        const tabs = document.querySelectorAll('.tab-button');
        const taskTabs = document.querySelectorAll('.task-tab-button');
        tabs.forEach(tab => tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('tab-active')); tab.classList.add('tab-active'); document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden')); document.getElementById(`${tab.dataset.tab}-page`).classList.remove('hidden'); }));
        taskTabs.forEach(tab => tab.addEventListener('click', () => { taskTabs.forEach(t => t.classList.remove('task-tab-active')); tab.classList.add('task-tab-active'); document.querySelectorAll('.task-tab-content').forEach(p => p.classList.add('hidden')); document.getElementById(`task-tab-${tab.dataset.taskTab}`).classList.remove('hidden'); }));

        function attachListeners() {
            if (!userId || !currentMonthId || !selectedMonthId) {
                // Инициализация еще не завершена
                return;
            }
            detachListeners();
            setupCollections();
            unsubscribes.push(onSnapshot(query(debtsCol), s => { allDebts = s.docs; renderDebts(allDebts); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(expensesCol), s => { allExpenses = s.docs; renderExpenses(allExpenses); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(recurringExpensesCol), s => { allRecurringTemplates = s.docs.map(d => ({ id: d.id, ...d.data() })); renderRecurringExpenses(); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(recurringExpenseStatusesCol), s => { currentMonthStatuses = {}; s.docs.forEach(d => { currentMonthStatuses[d.id] = d.data().status; }); renderRecurringExpenses(); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(monthlyDataCol), s => { const m = s.docs.map(d => d.id); if (!m.includes(currentMonthId)) m.push(currentMonthId); m.sort().reverse(); renderMonthSelector(m); }));
            unsubscribes.push(onSnapshot(query(categoriesCol), s => { const categories = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCategoryDatalist(s.docs); renderCategories(categories); }));
            unsubscribes.push(onSnapshot(query(dailyTasksCol), s => { dailyTasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderDailyTasks(dailyTasks); }));
            unsubscribes.push(onSnapshot(query(monthlyTasksCol, where("month", "==", selectedMonthId)), s => { monthlyTasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderMonthlyTasks(monthlyTasks); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(yearlyTasksCol, where("year", "==", calendarDate.getFullYear())), s => { yearlyTasks = s.docs.map(d => ({ id: d.id, ...d.data() })); renderYearlyTasks(yearlyTasks); updateDashboard(); }));
            unsubscribes.push(onSnapshot(query(calendarEventsCol), s => { calendarEvents = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCalendar(); }));
        }

        function detachListeners() { unsubscribes.forEach(unsub => unsub()); unsubscribes = []; }
        function formatCurrency(amount) { if (typeof amount !== 'number') amount = 0; const value = currentCurrency === 'USD' ? amount / exchangeRate : amount; const symbol = currentCurrency === 'USD' ? '$' : 'AZN'; return `${value.toFixed(2)} ${symbol}`; }
        function renderCategoryDatalist(docs) { const datalist = document.getElementById('expense-categories-list'); datalist.innerHTML = docs.filter(doc => doc.data().lang === currentLang).map(doc => `<option value="${doc.data().name}"></option>`).join(''); }
        function renderCategories(categories) { const list = document.getElementById('category-list'); if (!list) return; const langCategories = categories.filter(c => c.lang === currentLang); list.innerHTML = langCategories.map(cat => `<div class="flex justify-between items-center p-2 bg-gray-100 rounded-lg"><span>${cat.name}</span><button data-id="${cat.id}" class="delete-category-btn text-red-500 hover:text-red-700">🗑️</button></div>`).join(''); }

        const createEmptyState = (messageKey) => `<div class="flex flex-col items-center justify-center p-12 bg-gray-50 rounded-lg"><svg class="w-16 h-16 text-gray-300 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg><p class="text-gray-500 font-medium">${translations[currentLang][messageKey]}</p></div>`;

        function renderDebts(docs) {
            if (!userId) return;
            const tableWrapper = document.getElementById('debts-table-wrapper');
            const tableBody = document.getElementById('debts-table');
            const emptyState = document.getElementById('debts-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyDebts');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = docs.map(doc => {
                const debt = doc.data(), id = doc.id; const remaining = (debt.totalAmount || 0) - (debt.paidAmount || 0);
                let colorClass = remaining <= 0 ? 'text-green-600' : (debt.paidAmount > 0 ? 'text-yellow-600' : 'text-red-600');
                const lastPaymentDate = debt.lastPaymentDate ? formatISODateForDisplay(debt.lastPaymentDate.toDate().toISOString().split('T')[0]) : '—';
                return `<tr class="border-b hover:bg-gray-50 md:border-b-0"><td data-label="${translations[currentLang].debtName}" class="font-medium">${debt.name}</td><td data-label="${translations[currentLang].amount}">${formatCurrency(debt.totalAmount)}</td><td data-label="${translations[currentLang].paid}">${formatCurrency(debt.paidAmount)}</td><td data-label="${translations[currentLang].remaining}" class="font-bold ${colorClass}">${formatCurrency(remaining)}</td><td data-label="${translations[currentLang].lastPaymentDate}">${lastPaymentDate}</td><td data-label="${translations[currentLang].comments}"><input type="text" class="editable-debt-comment bg-transparent w-full p-1" data-id="${id}" value="${debt.comment || ''}" placeholder="${translations[currentLang].placeholderComment}"></td><td data-label="${translations[currentLang].actions}" class="flex gap-2"><button data-id="${id}" class="add-debt-payment-btn text-green-600 hover:text-green-800" title="${translations[currentLang].addDebtPayment}">➕</button><button data-id="${id}" class="edit-debt-btn text-blue-600 hover:text-blue-800" title="${translations[currentLang].editDebt}">✏️</button><button data-id="${id}" class="delete-debt-btn text-red-600 hover:text-red-800" title="${translations[currentLang].delete}">🗑️</button></td></tr>`;
            }).join('');
        }

        function renderRecurringExpenses() {
            if (!userId || !selectedMonthId) return;
            const tableWrapper = document.getElementById('recurring-expenses-table-wrapper');
            const tableBody = document.getElementById('recurring-expenses-table');
            const emptyState = document.getElementById('recurring-expenses-empty');
            if (allRecurringTemplates.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyRecurring');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const todayDay = new Date(getTodayISOString() + 'T00:00:00').getDate();
            tableBody.innerHTML = allRecurringTemplates.map(template => {
                const status = currentMonthStatuses[template.id] || translations.ru.unpaidStatus;
                const isOverdue = status === translations.ru.unpaidStatus && template.dueDay < todayDay && selectedMonthId === currentMonthId;
                const isPaid = status === translations.ru.paidStatus;
                return `<tr class="border-b hover:bg-gray-50 ${isOverdue ? 'bg-red-50' : ''} md:border-b-0">
                        <td data-label="${translations[currentLang].name}" class="font-medium">${template.name}</td>
                        <td data-label="${translations[currentLang].amount}">${formatCurrency(template.amount)}</td>
                        <td data-label="${translations[currentLang].paymentDay}">${template.dueDay || '—'}</td>
                        <td data-label="${translations[currentLang].status}">
                            <select data-id="${template.id}" class="recurring-status-select p-1 rounded-md border-0 ring-1 ring-inset ring-gray-300 ${isPaid ? 'bg-green-100' : 'bg-red-100'}">
                                <option value="${translations.ru.unpaidStatus}" ${!isPaid ? 'selected' : ''}>${translations[currentLang].unpaidStatus}</option>
                                <option value="${translations.ru.paidStatus}" ${isPaid ? 'selected' : ''}>${translations[currentLang].paidStatus}</option>
                            </select></td>
                        <td data-label="${translations[currentLang].details}">${template.details || '—'}</td>
                        <td data-label="${translations[currentLang].templateActions}" class="flex gap-2">
                            <button data-id="${template.id}" class="edit-recurring-expense-btn text-blue-600 hover:text-blue-800">✏️</button>
                            <button data-id="${template.id}" class="delete-recurring-expense-btn text-red-600 hover:text-red-800">🗑️</button>
                        </td></tr>`;
            }).join('');
        }

        function renderExpenses(docs) {
            if (!userId || !selectedMonthId) return;
            const tableWrapper = document.getElementById('expenses-table-wrapper');
            const tableBody = document.getElementById('expenses-table');
            const emptyState = document.getElementById('expenses-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyExpenses');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const sortedDocs = [...docs].sort((a, b) => {
                const dateA = a.data()?.date || '';
                const dateB = b.data()?.date || '';
                return dateB.localeCompare ? dateB.localeCompare(dateA) : dateB > dateA ? -1 : 1;
            });

            tableBody.innerHTML = sortedDocs.map(doc => {
                const expense = doc.data(), id = doc.id;
                let actionsHtml = (!expense.recurringExpenseId && !expense.debtPaymentId) ? `<button data-id="${id}" class="edit-expense-btn text-blue-600 hover:text-blue-800" title="${translations[currentLang].editExpense}">✏️</button><button data-id="${id}" class="delete-expense-btn text-red-600 hover:text-red-800" title="${translations[currentLang].delete}">🗑️</button>` : '';
                return `<tr class="border-b hover:bg-gray-50 md:border-b-0">
                        <td data-label="${translations[currentLang].name}" class="font-medium">${expense.name}</td>
                        <td data-label="${translations[currentLang].category}">${expense.category}</td>
                        <td data-label="${translations[currentLang].amount}">${formatCurrency(expense.amount)}</td>
                        <td data-label="${translations[currentLang].date}">${formatISODateForDisplay(expense.date)}</td>
                        <td data-label="${translations[currentLang].actions}" class="flex gap-2">${actionsHtml}</td></tr>`;
            }).join('');
        }

        function createTaskStatusDropdown(id, status, colName) {
            const t = translations[currentLang]; const ruT = translations.ru;
            const options = { [ruT.statusNotDone]: { text: t.statusNotDone, class: 'bg-yellow-100 text-yellow-800' }, [ruT.statusDone]: { text: t.statusDone, class: 'bg-green-100 text-green-800' }, [ruT.statusSkipped]: { text: t.statusSkipped, class: 'bg-gray-100 text-gray-800' } };
            const currentStatus = status || ruT.statusNotDone;
            let selectHTML = `<select data-id="${id}" data-col="${colName}" class="task-status-select p-1 rounded-md border-0 ring-1 ring-inset ring-gray-300 ${options[currentStatus]?.class}">`;
            for (const [value, { text }] of Object.entries(options)) { selectHTML += `<option value="${value}" ${currentStatus === value ? 'selected' : ''}>${text}</option>`; }
            selectHTML += `</select>`; return selectHTML;
        }

        function renderDailyTasks(docs) {
            const tableWrapper = document.getElementById('daily-tasks-table-wrapper');
            const tableBody = document.getElementById('daily-tasks-table');
            const emptyState = document.getElementById('daily-tasks-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyTasks');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = docs.map(d => {
                const t = d;
                const s = t.status;
                const originalDateStr = t.originalDate ? ` (С ${formatISODateForDisplay(t.originalDate)})` : '';
                return `<tr class="md:border-b-0 ${t.carriedOver ? 'bg-blue-50' : ''}">
                    <td data-label="${translations[currentLang].name}" class="${s === translations.ru.statusDone ? 'line-through text-gray-500' : ''}">
                        ${t.name}${originalDateStr}
                    </td>
                    <td data-label="${translations[currentLang].status}">${createTaskStatusDropdown(t.id, s, 'dailyTasks')}</td>
                    <td data-label="${translations[currentLang].notes}">
                        <input type="text" class="editable-task-notes bg-transparent w-full p-1" data-id="${t.id}" data-col="dailyTasks" value="${t.notes || ''}" placeholder="${translations[currentLang].placeholderComment}">
                    </td>
                    <td data-label="${translations[currentLang].actions}" class="flex gap-2">
                        <button data-id="${t.id}" class="edit-daily-task-btn text-blue-600">✏️</button>
                        <button data-id="${t.id}" class="delete-daily-task-btn text-red-600">🗑️</button>
                    </td>
                </tr>`;
            }).join('');
        }
        function renderMonthlyTasks(docs) {
            const tableWrapper = document.getElementById('monthly-tasks-table-wrapper');
            const tableBody = document.getElementById('monthly-tasks-table');
            const emptyState = document.getElementById('monthly-tasks-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyTasks');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const sortedDocs = [...docs].sort((a, b) => {
                const deadlineA = a.deadline || '';
                const deadlineB = b.deadline || '';
                return deadlineA.localeCompare ? deadlineA.localeCompare(deadlineB) : deadlineA > deadlineB ? 1 : -1;
            });

            tableBody.innerHTML = sortedDocs.map(d => { const t = d, id = d.id; const s = t.status; return `<tr class="md:border-b-0 ${t.carriedOver ? 'bg-yellow-50' : ''}"><td data-label="${translations[currentLang].name}" class="${s === translations.ru.statusDone ? 'line-through text-gray-500' : ''}">${t.name}</td><td data-label="${translations[currentLang].deadline}">${formatISODateForDisplay(t.deadline)}</td><td data-label="${translations[currentLang].status}">${createTaskStatusDropdown(id, s, 'monthlyTasks')}</td><td data-label="${translations[currentLang].actions}" class="flex gap-2">${!t.recurringExpenseId && !t.fromCalendar ? `<button data-id="${id}" class="edit-monthly-task-btn text-blue-600">✏️</button><button data-id="${id}" class="delete-monthly-task-btn text-red-600">🗑️</button>` : ''}</td></tr>`; }).join('');
        }
        function renderYearlyTasks(docs) {
            const tableWrapper = document.getElementById('yearly-tasks-table-wrapper');
            const tableBody = document.getElementById('yearly-tasks-table');
            const emptyState = document.getElementById('yearly-tasks-empty');
            if (docs.length === 0) {
                tableWrapper.classList.add('hidden');
                emptyState.innerHTML = createEmptyState('emptyTasks');
                emptyState.classList.remove('hidden');
                return;
            }
            tableWrapper.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = docs.map(d => { const t = d, id = d.id; const s = t.status; return `<tr class="md:border-b-0"><td data-label="${translations[currentLang].name}" class="${s === translations.ru.statusDone ? 'line-through text-gray-500' : ''}">${t.name}</td><td data-label="${translations[currentLang].deadline}">${formatISODateForDisplay(t.deadline, { year: 'numeric' })}</td><td data-label="${translations[currentLang].status}">${createTaskStatusDropdown(id, s, 'yearlyTasks')}</td><td data-label="${translations[currentLang].notes}"><input type="text" class="editable-task-notes bg-transparent w-full p-1" data-id="${id}" data-col="yearlyTasks" value="${t.notes || ''}" placeholder="${translations[currentLang].placeholderComment}"></td><td data-label="${translations[currentLang].actions}" class="flex gap-2"><button data-id="${id}" class="edit-yearly-task-btn text-blue-600">✏️</button><button data-id="${id}" class="delete-yearly-task-btn text-red-600">🗑️</button></td></tr>`; }).join('');
        }

        function renderMonthSelector(months) { const s = document.getElementById('month-selector'); s.innerHTML = months.map(m => { const [y, mm] = m.split('-'); const label = formatMonthId(m); return `<option value="${m}" ${m === selectedMonthId ? 'selected' : ''}>${label}</option>`; }).join(''); }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); const monthYearEl = document.getElementById('calendar-month-year'); const weekdaysEl = document.getElementById('calendar-weekdays'); const month = calendarDate.getMonth(), year = calendarDate.getFullYear();
            // Используем массив месяцев из локализации вместо toLocaleString
            const monthName = translations[currentLang]?.months?.[month] || '';
            monthYearEl.textContent = monthName ? `${monthName} ${year}` : calendarDate.toLocaleString(currentLang === 'ru' ? 'ru-RU' : (currentLang === 'az' ? 'az-Latn-AZ' : 'en-US'), { month: 'long', year: 'numeric', timeZone: 'Asia/Baku' });
            weekdaysEl.innerHTML = translations[currentLang].weekdays.map(day => `<div>${day}</div>`).join('');
            const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const startingDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            grid.innerHTML = ''; for (let i = 0; i < startingDay; i++) { grid.insertAdjacentHTML('beforeend', '<div></div>'); }
            const todayISO = getTodayISOString();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const monthDayStr = dateStr.substring(5); const isToday = dateStr === todayISO;
                const dayEvents = calendarEvents.filter(e => e.category === 'birthday' ? e.date.substring(5) === monthDayStr : e.date === dateStr);
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day border-2 p-2 flex flex-col cursor-pointer transition-all ${isToday ? 'calendar-day-today' : 'border-gray-200 dark:border-gray-700'}`;
                dayEl.dataset.date = dateStr;
                dayEl.innerHTML = `
                    <div class="calendar-day-number self-end text-center rounded-full flex items-center justify-center w-8 h-8 font-semibold transition-all" 
                         style="${isToday ? 'background: var(--accent-color); color: white; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);' : ''}">
                        ${day}
                    </div>
                    <div class="events mt-1 space-y-1 overflow-y-auto text-xs">
                        ${dayEvents.map(e => `
                            <div data-event-id="${e.id}" class="event-item p-1 rounded truncate text-xs font-medium" 
                                 style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 100%); color: var(--text-primary);">
                                ${e.name}
                            </div>
                        `).join('')}
                    </div>
                `;
                grid.appendChild(dayEl);
            }
        }
        document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

        document.getElementById('month-selector').addEventListener('change', async (e) => {
            selectedMonthId = e.target.value;
            // Обновляем calendarDate для корректного отображения годовых задач
            const [year, month] = selectedMonthId.split('-').map(Number);
            calendarDate = new Date(year, month - 1, 1);
            await ensureRecurringTasksForMonth(selectedMonthId);
            updateMonthDisplay();
            attachListeners();
        });
        document.getElementById('app').addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            if (e.target.classList.contains('task-status-select')) {
                const newStatus = e.target.value; const colName = e.target.dataset.col; let colRef;
                if (colName === 'dailyTasks') colRef = dailyTasksCol; else if (colName === 'monthlyTasks') colRef = monthlyTasksCol; else if (colName === 'yearlyTasks') colRef = yearlyTasksCol;
                if (colRef && id) await updateDoc(doc(colRef, id), { status: newStatus });
            }
            if (!id) return;
            if (e.target.classList.contains('editable-debt-comment')) await updateDoc(doc(debtsCol, id), { comment: e.target.value });
            if (e.target.classList.contains('editable-task-notes')) { const colName = e.target.dataset.col; const colRef = colName === 'dailyTasks' ? dailyTasksCol : yearlyTasksCol; await updateDoc(doc(colRef, id), { notes: e.target.value }); }
            if (e.target.classList.contains('recurring-status-select')) {
                const newStatus = e.target.value;
                const targetRecurringStatusesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/recurringExpenseStatuses`);
                await setDoc(doc(targetRecurringStatusesCol, id), { status: newStatus });

                const taskQuery = query(monthlyTasksCol, where("recurringExpenseId", "==", id), where("month", "==", selectedMonthId));
                const targetExpensesCol = collection(db, `users/${userId}/monthlyData/${selectedMonthId}/expenses`);

                if (newStatus === translations.ru.paidStatus) {
                    const template = allRecurringTemplates.find(t => t.id === id);
                    if (template) await addDoc(targetExpensesCol, { name: template.name, category: translations[currentLang].recurringPayments, amount: template.amount, date: getTodayISOString(), recurringExpenseId: id });
                    const tasks = await getDocs(taskQuery);
                    if (!tasks.empty) await updateDoc(tasks.docs[0].ref, { status: translations.ru.statusDone });
                } else {
                    const q = query(targetExpensesCol, where("recurringExpenseId", "==", id));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); await batch.commit();
                    const tasks = await getDocs(taskQuery);
                    if (!tasks.empty) await updateDoc(tasks.docs[0].ref, { status: translations.ru.statusNotDone });
                }
            }
        });

        const eventCategorySelector = document.getElementById('event-category');
        eventCategorySelector.addEventListener('change', (e) => {
            document.querySelectorAll('.event-category-fields').forEach(div => div.classList.add('hidden'));
            document.getElementById(`event-fields-${e.target.value}`).classList.remove('hidden');
            document.querySelectorAll('.event-category-fields input').forEach(input => { input.value = ''; input.required = false; });
            document.querySelectorAll(`#event-fields-${e.target.value} input`).forEach(input => { if (input.id !== 'event-birthday-year' && input.id !== 'event-meeting-time' && input.id !== 'event-meeting-place') { input.required = true; } });
        });
        document.getElementById('calendar-grid').addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day'); const eventEl = e.target.closest('.event-item'); const eventModal = document.getElementById('event-modal'); const t = translations[currentLang]; const form = document.getElementById('event-form');
            const openModal = () => { eventCategorySelector.dispatchEvent(new Event('change')); eventModal.showModal(); };
            if (eventEl) {
                const eventId = eventEl.dataset.eventId; const event = calendarEvents.find(ev => ev.id === eventId);
                if (event) {
                    form.reset(); document.getElementById('event-id').value = event.id; const category = event.category || 'event'; document.getElementById('event-category').value = category; document.getElementById('event-date').value = event.date;
                    switch (category) {
                        case 'birthday': document.getElementById('event-birthday-name').value = event.birthdayName || ''; document.getElementById('event-birthday-year').value = event.birthYear || ''; break;
                        case 'meeting': document.getElementById('event-meeting-with').value = event.meetingWith || ''; document.getElementById('event-meeting-time').value = event.meetingTime || ''; document.getElementById('event-meeting-place').value = event.meetingPlace || ''; break;
                        case 'wedding': document.getElementById('event-wedding-names').value = event.weddingNames || ''; break;
                        default: document.getElementById('event-name-generic').value = event.name || ''; break;
                    }
                    document.getElementById('event-modal-title').textContent = t.editEvent; document.getElementById('delete-event-btn').classList.remove('hidden'); openModal();
                }
            } else if (dayEl) {
                form.reset(); document.getElementById('event-id').value = ''; document.getElementById('event-category').value = 'event'; document.getElementById('event-date').value = dayEl.dataset.date; document.getElementById('event-modal-title').textContent = t.addEvent; document.getElementById('delete-event-btn').classList.add('hidden'); openModal();
            }
        });

        async function updateDashboard() {
            if (!userId || !currentMonthId || !selectedMonthId) {
                // Инициализация еще не завершена, не вызываем ошибку
                return;
            }
            document.getElementById('app').classList.remove('opacity-0'); document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('dashboard-loading').classList.add('hidden'); document.getElementById('dashboard-content').classList.remove('hidden');
            const totalRecurringPaid = allRecurringTemplates.filter(t => currentMonthStatuses[t.id] === translations.ru.paidStatus).reduce((s, t) => s + (t.amount || 0), 0);
            document.getElementById('total-recurring-paid').textContent = formatCurrency(totalRecurringPaid);
            const totalRecurringRemaining = allRecurringTemplates.filter(t => (currentMonthStatuses[t.id] || translations.ru.unpaidStatus) === translations.ru.unpaidStatus).reduce((s, t) => s + (t.amount || 0), 0);
            document.getElementById('total-recurring-remaining').textContent = formatCurrency(totalRecurringRemaining);
            const allMonthlyExpensesTotal = allExpenses.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
            document.getElementById('total-monthly-outflow').textContent = formatCurrency(allMonthlyExpensesTotal);
            const totalDebtRemaining = allDebts.reduce((s, d) => s + ((d.data().totalAmount || 0) - (d.data().paidAmount || 0)), 0);
            document.getElementById('total-debt-remaining').textContent = formatCurrency(totalDebtRemaining);
            document.getElementById('tasks-remaining-month').textContent = monthlyTasks.filter(t => t.status === translations.ru.statusNotDone).length;
            document.getElementById('tasks-remaining-year').textContent = yearlyTasks.filter(t => t.status === translations.ru.statusNotDone).length;
            const expensesByCategory = {}; allExpenses.forEach(doc => { const e = doc.data(); expensesByCategory[e.category] = (expensesByCategory[e.category] || 0) + e.amount; });
            const sortedCategories = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a).slice(0, 7);
            const chartLabels = sortedCategories.map(item => item[0]);
            const chartData = sortedCategories.map(item => item[1]);
            if (expensesChart) expensesChart.destroy();
            expensesChart = new Chart(document.getElementById('expenses-chart').getContext('2d'), { type: 'bar', data: { labels: chartLabels, datasets: [{ label: `${translations[currentLang].chartLabel}`, data: chartData.map(amount => currentCurrency === 'USD' ? amount / exchangeRate : amount), backgroundColor: ['rgba(59,130,246,0.7)', 'rgba(239,68,68,0.7)', 'rgba(245,158,11,0.7)', 'rgba(16,185,129,0.7)', 'rgba(139,92,246,0.7)', 'rgba(236,72,153,0.7)', 'rgba(107,114,128,0.7)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = `toast toast-${type}`; toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function showConfirmModal(text) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-modal-text').textContent = text;
                const yesBtn = document.getElementById('confirm-modal-yes');
                const noBtn = document.getElementById('confirm-modal-no');

                const close = () => modal.close();
                const onYes = () => { resolve(true); close(); cleanup(); };
                const onNo = () => { resolve(false); close(); cleanup(); };

                const cleanup = () => {
                    yesBtn.removeEventListener('click', onYes);
                    noBtn.removeEventListener('click', onNo);
                };

                yesBtn.addEventListener('click', onYes, { once: true });
                noBtn.addEventListener('click', onNo, { once: true });
                modal.addEventListener('close', () => { resolve(false); cleanup(); }, { once: true });
                modal.showModal();
            });
        }

        function setupModal(modalId, openBtnId, resetFn) {
            const modal = document.getElementById(modalId); if (!modal) return;
            const openBtn = document.getElementById(openBtnId);
            if (openBtn) openBtn.addEventListener('click', () => { if (resetFn) resetFn(); modal.showModal(); });
            modal.querySelector('.cancel-btn')?.addEventListener('click', () => modal.close());
            modal.querySelector('form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const handler = { 'debt-form': handleDebtFormSubmit, 'debt-payment-form': handleDebtPaymentFormSubmit, 'recurring-expense-form': handleRecurringExpenseFormSubmit, 'expense-form': handleExpenseFormSubmit, 'daily-task-form': handleDailyTaskFormSubmit, 'monthly-task-form': handleMonthlyTaskFormSubmit, 'yearly-task-form': handleYearlyTaskFormSubmit, 'event-form': handleEventFormSubmit }[e.target.id];
                if (handler) handler(e.target);
                modal.close();
            });
        }

        async function handleDebtFormSubmit(form) {
            try {
                const id = form.querySelector('#debt-id').value; const originalPaid = parseFloat(form.dataset.originalPaid || 0); const newPaidAmount = parseFloat(form.querySelector('#debt-paid').value); const name = form.querySelector('#debt-name').value;
                const debtData = { name, totalAmount: parseFloat(form.querySelector('#debt-total').value), paidAmount: newPaidAmount, comment: form.querySelector('#debt-comment').value };
                if (id && newPaidAmount > originalPaid) { debtData.lastPaymentDate = Timestamp.now(); await addDoc(collection(db, `users/${userId}/monthlyData/${currentMonthId}/expenses`), { name: `${translations[currentLang].addDebtPayment}: ${name}`, category: translations[currentLang].debtRepayments, amount: newPaidAmount - originalPaid, date: getTodayISOString(), debtPaymentId: id }); }
                if (!id) {
                    debtData.createdAt = Timestamp.now(); const newDocRef = await addDoc(debtsCol, debtData);
                    if (debtData.paidAmount > 0) { await updateDoc(newDocRef, { lastPaymentDate: Timestamp.now() }); await addDoc(collection(db, `users/${userId}/monthlyData/${currentMonthId}/expenses`), { name: `${translations[currentLang].addDebtPayment}: ${name}`, category: translations[currentLang].debtRepayments, amount: debtData.paidAmount, date: getTodayISOString(), debtPaymentId: newDocRef.id }); }
                } else { await updateDoc(doc(debtsCol, id), debtData); }
                form.dataset.originalPaid = "0"; showToast(translations[currentLang].toastSuccess);
            } catch (error) { console.error("Error saving debt:", error); showToast(translations[currentLang].toastError, 'error'); }
        }
        async function handleDebtPaymentFormSubmit(form) {
            try {
                const id = form.querySelector('#debt-payment-id').value;
                const amount = parseFloat(form.querySelector('#debt-payment-amount').value);
                showToast(`ID: ${id}, Amount: ${amount}`); // Отладка
                const debtRef = doc(debtsCol, id);
                const debtDoc = await getDoc(debtRef);
                if (debtDoc.exists()) {
                    const debt = debtDoc.data();
                    showToast(`Найден долг: ${debt.name}`); // Отладка
                    await updateDoc(debtRef, { paidAmount: (debt.paidAmount || 0) + amount, lastPaymentDate: Timestamp.now() });
                    await addDoc(collection(db, `users/${userId}/monthlyData/${currentMonthId}/expenses`), { name: `${translations[currentLang].addDebtPayment}: ${debt.name}`, category: translations[currentLang].debtRepayments, amount: amount, date: getTodayISOString(), debtPaymentId: id });
                    showToast(translations[currentLang].toastSuccess);
                } else {
                    showToast(`Долг с ID ${id} не найден`, 'error'); // Отладка
                }
            } catch (error) {
                console.error("Error adding debt payment:", error);
                showToast(`Ошибка: ${error.message}`, 'error'); // Отладка
            }
        }
        async function handleRecurringExpenseFormSubmit(form) {
            try {
                const id = form.querySelector('#recurring-expense-id').value; const data = { name: form.querySelector('#recurring-expense-name').value, amount: parseFloat(form.querySelector('#recurring-expense-amount').value), dueDay: parseInt(form.querySelector('#recurring-expense-due-day').value), details: form.querySelector('#recurring-expense-details').value, }; let docRef;
                if (!id) { data.createdAt = Timestamp.now(); docRef = await addDoc(recurringExpensesCol, data); } else { docRef = doc(recurringExpensesCol, id); await updateDoc(docRef, data); }
                const taskQuery = query(monthlyTasksCol, where("recurringExpenseId", "==", docRef.id), where("month", "==", selectedMonthId));
                const existingTasks = await getDocs(taskQuery); const [year, month] = selectedMonthId.split('-').map(Number); const deadline = `${selectedMonthId}-${String(data.dueDay).padStart(2, '0')}`;
                const taskData = { name: `${data.name}`, deadline, status: translations.ru.statusNotDone, recurringExpenseId: docRef.id, month: selectedMonthId, year: year, };
                if (existingTasks.empty) await addDoc(monthlyTasksCol, taskData); else await updateDoc(existingTasks.docs[0].ref, taskData);
                showToast(translations[currentLang].toastSuccess);
            } catch (error) { console.error("Error saving recurring expense:", error); showToast(translations[currentLang].toastError, 'error'); }
        }
        async function handleExpenseFormSubmit(form) {
            try {
                const id = form.querySelector('#expense-id').value;
                const expenseData = {
                    name: form.querySelector('#expense-name').value,
                    category: form.querySelector('#expense-category').value,
                    amount: parseFloat(form.querySelector('#expense-amount').value),
                    date: form.querySelector('#expense-date').value,
                };
                const newMonthId = expenseData.date.slice(0, 7);

                if (!id) {
                    const targetCol = collection(db, `users/${userId}/monthlyData/${newMonthId}/expenses`);
                    await addDoc(targetCol, expenseData);

                    // Если расход добавлен в другой месяц, переключаемся на него и обновляем подписки
                    if (newMonthId !== selectedMonthId) {
                        selectedMonthId = newMonthId;
                        const [year, month] = selectedMonthId.split('-').map(Number);
                        calendarDate = new Date(year, month - 1, 1);
                        updateMonthDisplay();
                        attachListeners();
                    }
                } else {
                    const originalDocRef = doc(expensesCol, id);
                    const originalDocSnap = await getDoc(originalDocRef);

                    if (originalDocSnap.exists()) {
                        const originalData = originalDocSnap.data();
                        if (originalData.date.slice(0, 7) !== newMonthId) {
                            const newTargetCol = collection(db, `users/${userId}/monthlyData/${newMonthId}/expenses`);
                            const batch = writeBatch(db);
                            batch.delete(originalDocRef);
                            batch.set(doc(newTargetCol), expenseData);
                            await batch.commit();

                            // Переключаемся на месяц расхода
                            selectedMonthId = newMonthId;
                            const [year, month] = selectedMonthId.split('-').map(Number);
                            calendarDate = new Date(year, month - 1, 1);
                            updateMonthDisplay();
                            attachListeners();
                        } else {
                            await updateDoc(originalDocRef, expenseData);
                        }
                    }
                }
                showToast(translations[currentLang].toastSuccess);
            } catch (error) {
                console.error("Error saving expense:", error);
                showToast(translations[currentLang].toastError, 'error');
            }
        }
        const handleTaskSubmit = async (col, id, data) => {
            try { if (!id) await addDoc(col, { ...data, createdAt: Timestamp.now(), status: translations.ru.statusNotDone }); else await updateDoc(doc(col, id), data); showToast(translations[currentLang].toastSuccess); }
            catch (error) { console.error("Error saving task:", error); showToast(translations[currentLang].toastError, 'error'); }
        };
        const handleDailyTaskFormSubmit = (form) => handleTaskSubmit(dailyTasksCol, form.querySelector('#daily-task-id').value, { name: form.querySelector('#daily-task-name').value, notes: form.querySelector('#daily-task-notes').value });
        const handleMonthlyTaskFormSubmit = (form) => handleTaskSubmit(monthlyTasksCol, form.querySelector('#monthly-task-id').value, { name: form.querySelector('#monthly-task-name').value, deadline: form.querySelector('#monthly-task-deadline').value, month: form.querySelector('#monthly-task-deadline').value.slice(0, 7), year: new Date(form.querySelector('#monthly-task-deadline').value).getFullYear() });
        const handleYearlyTaskFormSubmit = (form) => handleTaskSubmit(yearlyTasksCol, form.querySelector('#yearly-task-id').value, { name: form.querySelector('#yearly-task-name').value, deadline: form.querySelector('#yearly-task-deadline').value, notes: form.querySelector('#yearly-task-notes').value, year: new Date(form.querySelector('#yearly-task-deadline').value).getFullYear() });

        async function handleEventFormSubmit(form) {
            try {
                const id = form.querySelector('#event-id').value; const category = form.querySelector('#event-category').value; const t = translations[currentLang]; const data = { category, date: form.querySelector('#event-date').value }; let taskName = '';
                switch (category) {
                    case 'birthday': const birthdayName = form.querySelector('#event-birthday-name').value; const birthYear = form.querySelector('#event-birthday-year').value; data.birthdayName = birthdayName; data.birthYear = birthYear; data.name = `${t.categoryBirthday}: ${birthdayName}`; taskName = `${t.taskCongratulate} ${birthdayName}`; if (birthYear) { const age = new Date(data.date).getFullYear() - parseInt(birthYear); if (age >= 0) taskName += ` (${t.taskTurning} ${age} ${t.taskYearsOld})`; } break;
                    case 'meeting': const meetingWith = form.querySelector('#event-meeting-with').value; const meetingTime = form.querySelector('#event-meeting-time').value; const meetingPlace = form.querySelector('#event-meeting-place').value; data.meetingWith = meetingWith; data.meetingTime = meetingTime; data.meetingPlace = meetingPlace; data.name = `${t.categoryMeeting}: ${meetingWith}`; taskName = `${t.taskMeetWith} ${meetingWith}`; if (meetingTime) taskName += ` в ${meetingTime}`; if (meetingPlace) taskName += ` в ${meetingPlace}`; break;
                    case 'wedding': const weddingNames = form.querySelector('#event-wedding-names').value; data.weddingNames = weddingNames; data.name = `${t.categoryWedding}: ${weddingNames}`; taskName = `${t.taskWeddingOf} ${weddingNames}`; break;
                    default: data.name = form.querySelector('#event-name-generic').value; taskName = data.name; break;
                }
                let eventId = id; if (id) { await updateDoc(doc(calendarEventsCol, id), data); } else { const newDoc = await addDoc(calendarEventsCol, data); eventId = newDoc.id; }
                if (!eventId) return;
                const shouldCreateTask = form.querySelector('#event-create-task').checked;
                const taskQuery = query(monthlyTasksCol, where("fromCalendar", "==", eventId)); const existingTasksSnapshot = await getDocs(taskQuery); const existingTaskDoc = existingTasksSnapshot.docs[0];
                const taskData = { name: taskName, deadline: data.date, status: translations.ru.statusNotDone, month: data.date.slice(0, 7), year: parseInt(data.date.slice(0, 4)), fromCalendar: eventId };
                if (shouldCreateTask) {
                    if (existingTaskDoc) await updateDoc(existingTaskDoc.ref, taskData);
                    else await addDoc(monthlyTasksCol, taskData);
                    const newMonthId = data.date.slice(0, 7);
                    if (newMonthId !== selectedMonthId) {
                        selectedMonthId = newMonthId;
                        const [year, month] = selectedMonthId.split('-').map(Number);
                        calendarDate = new Date(year, month - 1, 1);
                        updateMonthDisplay();
                        attachListeners();
                    }
                    document.querySelector('.tab-button[data-tab="tasks"]').click();
                }
                else { if (existingTaskDoc) await deleteDoc(existingTaskDoc.ref); }
                showToast(translations[currentLang].toastSuccess);
            } catch (error) { console.error("Error saving event:", error); showToast(translations[currentLang].toastError, 'error'); }
        };
        async function handleCategoryFormSubmit(form) { const nameInput = form.querySelector('#category-name'); const name = nameInput.value.trim(); if (name) { await addDoc(categoriesCol, { name: name, lang: currentLang }); nameInput.value = ''; showToast(translations[currentLang].toastSuccess); } }

        setupModal('debt-modal', 'add-debt-btn', () => { document.getElementById('debt-form').reset(); document.getElementById('debt-id').value = ''; document.getElementById('debt-modal-title').textContent = translations[currentLang].addDebt; });
        setupModal('recurring-expense-modal', 'add-recurring-expense-btn', () => { document.getElementById('recurring-expense-form').reset(); document.getElementById('recurring-expense-id').value = ''; document.getElementById('recurring-expense-modal-title').textContent = translations[currentLang].addTemplate; });
        setupModal('expense-modal', 'add-expense-btn', () => {
            document.getElementById('expense-form').reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-date').value = `${selectedMonthId}-01`;
            document.getElementById('expense-modal-title').textContent = translations[currentLang].addExpense;
        });
        setupModal('daily-task-modal', 'add-daily-task-btn', () => { document.getElementById('daily-task-form').reset(); document.getElementById('daily-task-id').value = ''; document.getElementById('daily-task-modal-title').textContent = translations[currentLang].addTaskForToday; });
        setupModal('monthly-task-modal', 'add-monthly-task-btn', () => { document.getElementById('monthly-task-form').reset(); document.getElementById('monthly-task-id').value = ''; document.getElementById('monthly-task-modal-title').textContent = translations[currentLang].addTaskForMonth; });
        setupModal('yearly-task-modal', 'add-yearly-task-btn', () => { document.getElementById('yearly-task-form').reset(); document.getElementById('yearly-task-id').value = ''; document.getElementById('yearly-task-modal-title').textContent = translations[currentLang].addTaskForYear; });
        setupModal('category-modal', 'manage-categories-btn');
        setupModal('event-modal');
        document.getElementById('category-form').addEventListener('submit', (e) => { e.preventDefault(); handleCategoryFormSubmit(e.target); });

        function setCurrency(currency) {
            currentCurrency = currency; localStorage.setItem('currency', currency);
            document.getElementById('currency-azn').classList.toggle('currency-btn-active', currency === 'AZN');
            document.getElementById('currency-usd').classList.toggle('currency-btn-active', currency === 'USD');
            document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = currentCurrency);
            if (userId) { renderDebts(allDebts); renderRecurringExpenses(); renderExpenses(allExpenses); updateDashboard(); }
        }
        document.getElementById('currency-azn').addEventListener('click', () => setCurrency('AZN'));
        document.getElementById('currency-usd').addEventListener('click', () => setCurrency('USD'));
        setCurrency(currentCurrency);

        const authForm = document.getElementById('auth-form'); const authError = document.getElementById('auth-error');
        document.getElementById('login-btn')?.addEventListener('click', async (e) => {
            e.preventDefault(); const email = authForm.email.value; const password = authForm.password.value; authError.textContent = '';
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) { const t = translations[currentLang]; authError.textContent = { 'auth/invalid-email': t.authInvalidEmail, 'auth/user-not-found': t.authInvalidCredentials, 'auth/wrong-password': t.authInvalidCredentials, 'auth/invalid-credential': t.authInvalidCredentials }[error.code] || t.authGenericError; }
        });
        document.getElementById('register-btn')?.addEventListener('click', async () => {
            const email = authForm.email.value; const password = authForm.password.value; authError.textContent = '';
            try { await createUserWithEmailAndPassword(auth, email, password); }
            catch (error) { const t = translations[currentLang]; authError.textContent = { 'auth/invalid-email': t.authInvalidEmail, 'auth/email-already-in-use': t.authEmailInUse, 'auth/weak-password': t.authWeakPassword }[error.code] || t.authGenericError; }
        });
        document.getElementById('google-signin-btn')?.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { authError.textContent = translations[currentLang].authGenericError; } });
        document.getElementById('logout-btn')?.addEventListener('click', async () => await signOut(auth));

        document.getElementById('app').addEventListener('click', async (e) => {
            const target = e.target; const id = target.dataset.id || target.closest('[data-id]')?.dataset.id; if (!id) return;
            const t = translations[currentLang];
            const confirm = () => showConfirmModal(t.deleteConfirm);

            if (target.closest('.delete-category-btn')) { if (await confirm()) { await deleteDoc(doc(categoriesCol, id)); showToast(t.toastDeleted); } }
            else if (target.classList.contains('edit-debt-btn')) { const debt = (await getDoc(doc(debtsCol, id))).data(); const form = document.getElementById('debt-form'); form.dataset.originalPaid = debt.paidAmount || 0; form.querySelector('#debt-id').value = id; form.querySelector('#debt-name').value = debt.name; form.querySelector('#debt-total').value = debt.totalAmount; form.querySelector('#debt-paid').value = debt.paidAmount; form.querySelector('#debt-comment').value = debt.comment; document.getElementById('debt-modal-title').textContent = t.editDebt; document.getElementById('debt-modal').showModal(); }
            else if (target.classList.contains('delete-debt-btn') && await confirm()) { await deleteDoc(doc(debtsCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('add-debt-payment-btn')) { document.getElementById('debt-payment-id').value = id; document.getElementById('debt-payment-form').reset(); document.getElementById('debt-payment-modal').showModal(); }
            else if (target.classList.contains('edit-recurring-expense-btn')) { const expense = (await getDoc(doc(recurringExpensesCol, id))).data(); const form = document.getElementById('recurring-expense-form'); form.querySelector('#recurring-expense-id').value = id; form.querySelector('#recurring-expense-name').value = expense.name; form.querySelector('#recurring-expense-amount').value = expense.amount; form.querySelector('#recurring-expense-due-day').value = expense.dueDay; form.querySelector('#recurring-expense-details').value = expense.details; document.getElementById('recurring-expense-modal-title').textContent = t.editTemplate; document.getElementById('recurring-expense-modal').showModal(); }
            else if (target.classList.contains('delete-recurring-expense-btn') && await confirm()) { await deleteDoc(doc(recurringExpensesCol, id)); const q = query(monthlyTasksCol, where("recurringExpenseId", "==", id)); const tasksToDelete = await getDocs(q); const batch = writeBatch(db); tasksToDelete.forEach(d => batch.delete(d.ref)); await batch.commit(); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-expense-btn')) { const expenseDoc = await getDoc(doc(expensesCol, id)); if (!expenseDoc.exists()) return; const expense = expenseDoc.data(); const form = document.getElementById('expense-form'); form.querySelector('#expense-id').value = id; form.querySelector('#expense-name').value = expense.name; form.querySelector('#expense-category').value = expense.category; form.querySelector('#expense-amount').value = expense.amount; form.querySelector('#expense-date').value = expense.date; document.getElementById('expense-modal-title').textContent = t.editExpense; document.getElementById('expense-modal').showModal(); }
            else if (target.classList.contains('delete-expense-btn') && await confirm()) { await deleteDoc(doc(expensesCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-daily-task-btn')) { const task = (await getDoc(doc(dailyTasksCol, id))).data(); const form = document.getElementById('daily-task-form'); form.querySelector('#daily-task-id').value = id; form.querySelector('#daily-task-name').value = task.name; form.querySelector('#daily-task-notes').value = task.notes; document.getElementById('daily-task-modal-title').textContent = t.editTask; document.getElementById('daily-task-modal').showModal(); }
            else if (target.classList.contains('delete-daily-task-btn') && await confirm()) { await deleteDoc(doc(dailyTasksCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-monthly-task-btn')) { const task = (await getDoc(doc(monthlyTasksCol, id))).data(); const form = document.getElementById('monthly-task-form'); form.querySelector('#monthly-task-id').value = id; form.querySelector('#monthly-task-name').value = task.name; form.querySelector('#monthly-task-deadline').value = task.deadline; document.getElementById('monthly-task-modal-title').textContent = t.editTask; document.getElementById('monthly-task-modal').showModal(); }
            else if (target.classList.contains('delete-monthly-task-btn') && await confirm()) { await deleteDoc(doc(monthlyTasksCol, id)); showToast(t.toastDeleted); }
            else if (target.classList.contains('edit-yearly-task-btn')) { const task = (await getDoc(doc(yearlyTasksCol, id))).data(); const form = document.getElementById('yearly-task-form'); form.querySelector('#yearly-task-id').value = id; form.querySelector('#yearly-task-name').value = task.name; form.querySelector('#yearly-task-deadline').value = task.deadline; form.querySelector('#yearly-task-notes').value = task.notes; document.getElementById('yearly-task-modal-title').textContent = t.editTask; document.getElementById('yearly-task-modal').showModal(); }
            else if (target.classList.contains('delete-yearly-task-btn') && await confirm()) { await deleteDoc(doc(yearlyTasksCol, id)); showToast(t.toastDeleted); }
            else if (target.id === 'delete-event-btn') { const eventId = document.getElementById('event-id').value; if (eventId && await confirm()) { await deleteDoc(doc(calendarEventsCol, eventId)); const taskQuery = query(monthlyTasksCol, where("fromCalendar", "==", eventId)); const tasksSnapshot = await getDocs(taskQuery); const batch = writeBatch(db); tasksSnapshot.forEach(d => batch.delete(d.ref)); await batch.commit(); document.getElementById('event-modal').close(); showToast(t.toastDeleted); } }
        });

        // Radio Player Logic
        // Enhanced Radio Player with Equalizer
        const radioPlayer = document.getElementById('radio-player');
        const playPauseBtn = document.getElementById('radio-play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const equalizerBars = document.querySelectorAll('.equalizer-bar');
        const volumeSlider = document.getElementById('radio-volume');

        let isPlaying = false;
        let equalizerInterval;

        function startEqualizer() {
            // CSS animation handles it, but we can add extra randomness
            equalizerBars.forEach(bar => {
                bar.classList.remove('paused');
            });
        }

        function stopEqualizer() {
            if (equalizerInterval) {
                clearInterval(equalizerInterval);
                equalizerInterval = null;
            }
            equalizerBars.forEach(bar => {
                bar.classList.add('paused');
                bar.style.height = '4px';
            });
        }

        playPauseBtn.addEventListener('click', () => {
            if (radioPlayer.paused) {
                radioPlayer.play().catch(e => console.error('Radio play error:', e));
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                startEqualizer();
                isPlaying = true;
            } else {
                radioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                stopEqualizer();
                isPlaying = false;
            }
        });

        radioPlayer.addEventListener('ended', () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            stopEqualizer();
            isPlaying = false;
        });

        radioPlayer.addEventListener('error', () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            stopEqualizer();
            isPlaying = false;
            console.error('Radio player error');
        });

        if (volumeSlider && radioPlayer) {
            volumeSlider.addEventListener('input', (e) => {
                radioPlayer.volume = Number(e.target.value);
            });
        }

        // Theme toggle logic
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const moonIcon = document.getElementById('theme-icon-moon');
            const sunIcon = document.getElementById('theme-icon-sun');

            function updateIcons() {
                if (document.documentElement.classList.contains('dark')) {
                    // Show sun icon in dark mode (to switch to light)
                    if (moonIcon) moonIcon.classList.add('hidden');
                    if (sunIcon) sunIcon.classList.remove('hidden');
                } else {
                    // Show moon icon in light mode (to switch to dark)
                    if (moonIcon) moonIcon.classList.remove('hidden');
                    if (sunIcon) sunIcon.classList.add('hidden');
                }
            }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                if (savedTheme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            } else {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
            }
            updateIcons();

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    const newTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    updateIcons();
                });
            }
        });

    </script>

    <!-- Calculator Modal -->
    <dialog id="calculator-modal" class="rounded-2xl p-0 backdrop:bg-black/50">
        <div class="p-3 sm:p-4 md:p-6 rounded-2xl w-[90vw] max-w-[400px]" style="background: var(--bg-primary);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg md:text-xl font-bold" style="color: var(--text-primary);">Калькулятор</h2>
                <button id="close-calculator" class="hover:opacity-70 transition"
                    style="color: var(--text-secondary);">✕</button>
            </div>
            <div class="space-y-3">
                <input type="text" id="calc-display"
                    class="w-full p-3 md:p-4 text-xl md:text-2xl font-bold text-right rounded-lg focus:outline-none focus:ring-2"
                    style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);"
                    readonly value="0">
                <div class="grid grid-cols-4 gap-2">
                    <button class="calc-btn" data-value="clear">C</button>
                    <button class="calc-btn" data-value="clearEntry">CE</button>
                    <button class="calc-btn" data-value="backspace">⌫</button>
                    <button class="calc-btn bg-blue-600 hover:bg-blue-700 text-white" data-value="÷">÷</button>

                    <button class="calc-btn" data-value="7">7</button>
                    <button class="calc-btn" data-value="8">8</button>
                    <button class="calc-btn" data-value="9">9</button>
                    <button class="calc-btn bg-blue-600 hover:bg-blue-700 text-white" data-value="×">×</button>

                    <button class="calc-btn" data-value="4">4</button>
                    <button class="calc-btn" data-value="5">5</button>
                    <button class="calc-btn" data-value="6">6</button>
                    <button class="calc-btn bg-blue-600 hover:bg-blue-700 text-white" data-value="−">−</button>

                    <button class="calc-btn" data-value="1">1</button>
                    <button class="calc-btn" data-value="2">2</button>
                    <button class="calc-btn" data-value="3">3</button>
                    <button class="calc-btn bg-blue-600 hover:bg-blue-700 text-white" data-value="+">+</button>

                    <button class="calc-btn" data-value="0">0</button>
                    <button class="calc-btn" data-value=".">.</button>
                    <button class="calc-btn bg-green-600 hover:bg-green-700 text-white col-span-2"
                        data-value="=">=</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Shopping List Modal -->
    <dialog id="shopping-list-modal" class="rounded-2xl p-0 backdrop:bg-black/50">
        <div class="p-3 sm:p-4 md:p-6 rounded-2xl w-[95vw] max-w-[600px]" style="background: var(--bg-primary);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg md:text-2xl font-bold" style="color: var(--text-primary);"
                    data-i18n="shoppingListTitle">Список покупок</h2>
                <div class="flex gap-2">
                    <button id="copy-shopping-list"
                        class="px-3 md:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium text-xs md:text-sm"
                        data-i18n="shoppingListCopy">📋 Копировать</button>
                    <button id="close-shopping-list" class="hover:opacity-70 transition px-2"
                        style="color: var(--text-secondary);">✕</button>
                </div>
            </div>

            <!-- Add Item Form -->
            <div class="p-4 rounded-xl mb-4" style="background: var(--bg-secondary);">
                <div class="grid grid-cols-12 gap-2">
                    <div class="col-span-2">
                        <input type="number" id="item-quantity" placeholder="" min="1" data-i18n="shoppingListQuantity"
                            class="w-full p-2 rounded-lg text-sm focus:outline-none focus:ring-2"
                            style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);"
                            value="1">
                    </div>
                    <div class="col-span-5">
                        <input type="text" id="item-name" placeholder="" data-i18n="shoppingListProduct"
                            class="w-full p-2 rounded-lg focus:outline-none focus:ring-2"
                            style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">
                    </div>
                    <div class="col-span-3">
                        <input type="number" id="item-price" placeholder="" data-i18n="shoppingListPrice" step="0.01"
                            min="0" class="w-full p-2 rounded-lg focus:outline-none focus:ring-2"
                            style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">
                    </div>
                    <div class="col-span-2">
                        <button id="add-shopping-item"
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                            data-i18n="shoppingListAdd">+ Добавить</button>
                    </div>
                </div>
            </div>

            <!-- Shopping List Table -->
            <div class="rounded-xl overflow-hidden"
                style="background: var(--bg-primary); border: 1px solid var(--border-color);">
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full">
                        <thead class="sticky top-0" style="background: var(--bg-secondary);">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase"
                                    style="color: var(--text-secondary);">№</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase"
                                    style="color: var(--text-secondary);" data-i18n="shoppingListQuantityColumn">Кол-во
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase"
                                    style="color: var(--text-secondary);" data-i18n="shoppingListProductColumn">Товар
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase"
                                    style="color: var(--text-secondary);" data-i18n="shoppingListPriceColumn">Цена</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold uppercase"
                                    style="color: var(--text-secondary);" data-i18n="shoppingListSumColumn">Сумма</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase"
                                    style="color: var(--text-secondary);" data-i18n="shoppingListActionsColumn">Действия
                                </th>
                            </tr>
                        </thead>
                        <tbody id="shopping-list-items" class="text-sm" style="color: var(--text-primary);"></tbody>
                    </table>
                </div>
                <div class="px-4 py-3 border-t"
                    style="background: var(--bg-secondary); border-color: var(--border-color);">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold" style="color: var(--text-primary);"
                            data-i18n="shoppingListTotal">Итого:</span>
                        <span id="shopping-total" class="text-xl font-bold" style="color: var(--accent-color);">0
                            AZN</span>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <style>
        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            background-color: rgb(229, 231, 235);
            color: rgb(31, 41, 55);
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        /* Calculator Responsive Styles */
        @media (max-width: 400px) {
            .calc-btn {
                padding: 0.4rem;
                font-size: 0.75rem;
            }

            #calculator-display {
                font-size: 1.25rem;
                padding: 0.75rem;
            }
        }

        @media (min-width: 401px) and (max-width: 640px) {
            .calc-btn {
                padding: 0.5rem;
                font-size: 0.875rem;
            }

            #calculator-display {
                font-size: 1.5rem;
            }
        }

        @media (min-width: 641px) {
            .calc-btn {
                padding: 0.75rem;
                font-size: 1rem;
            }

            #calculator-display {
                font-size: 2rem;
            }
        }

        .dark .calc-btn {
            background-color: rgb(55, 65, 81);
            color: rgb(229, 231, 235);
        }

        .calc-btn:hover {
            background-color: rgb(209, 213, 219);
        }

        .dark .calc-btn:hover {
            background-color: rgb(75, 85, 99);
        }

        #shopping-list-items tr {
            transition: background-color 0.2s;
        }

        #shopping-list-items tr:hover {
            background-color: rgb(249, 250, 251);
        }

        .dark #shopping-list-items tr:hover {
            background-color: rgb(55, 65, 81);
        }

        #shopping-list-items tr {
            color: var(--text-primary) !important;
        }

        #shopping-list-items tr.completed {
            opacity: 0.6;
        }

        #shopping-list-items tr.completed td {
            text-decoration: line-through;
        }

        input[type="checkbox"] {
            cursor: pointer;
        }


        /* ============================================
           ULTRA SMALL DEVICES (320px - 400px)
           Samsung S23, iPhone SE, etc. - УЛУЧШЕННАЯ АДАПТАЦИЯ
           ============================================ */
        @media (max-width: 400px) {
            #app {
                padding: 0.5rem !important; /* Увеличено для лучшего вида */
            }

            body {
                font-size: 13.5px; /* Увеличено */
            }

            .premium-card {
                border-radius: 14px; /* Увеличено */
                padding: 0.875rem; /* Увеличено */
                border-width: 1.5px;
            }

            .stat-card {
                padding: 1rem; /* Увеличено */
                border-radius: 12px;
                font-size: 0.8125rem;
            }

            /* Оптимизированные таблицы */
            .responsive-table {
                font-size: 0.75rem; /* Увеличено */
            }

            .responsive-table th,
            .responsive-table td {
                padding: 0.625rem 0.5rem; /* Увеличено */
            }

            .responsive-table td::before {
                font-size: 0.7rem; /* Увеличено */
            }

            /* Улучшенные отступы в grid */
            .grid {
                gap: 0.75rem; /* Увеличено */
            }

            /* Кнопки с минимальной высотой */
            .premium-btn {
                padding: 10px 20px; /* Увеличено */
                font-size: 0.8125rem;
                border-radius: 10px;
                min-height: 42px; /* Минимальная высота */
            }

            /* Увеличенная кнопка темы */
            .theme-toggle-btn {
                width: 42px; /* Увеличено */
                height: 42px;
            }

            .theme-icon {
                width: 21px; /* Увеличено */
                height: 21px;
            }

            /* Компактный логотип для маленьких экранов */
            img[alt="ORDINA Logo"] {
                height: 80px !important;
                max-height: 80px !important;
                min-height: 80px !important;
            }

            /* Оптимизированные вкладки */
            .tab-button {
                padding: 0.5rem 0.75rem; /* Увеличено */
                font-size: 0.75rem;
                min-height: 38px;
            }

            /* Улучшенные заголовки */
            h1 {
                font-size: 1.625rem; /* Увеличено */
            }

            h2 {
                font-size: 1.375rem; /* Увеличено */
            }

            h3 {
                font-size: 1.125rem; /* Увеличено */
            }

            /* Оптимизированные инпуты */
            .premium-input {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            /* Hide non-essential elements */
            [data-i18n="appSubtitle"] {
                display: none !important;
            }
        }

        /* ============================================
           LANDSCAPE ORIENTATION OPTIMIZATIONS
           ============================================ */
        @media (max-height: 500px) and (orientation: landscape) {
            .premium-card {
                padding: 0.75rem;
            }

            .stat-card {
                padding: 0.875rem;
            }

            img[alt="ORDINA Logo"] {
                height: 90px !important;
                max-height: 90px !important;
                min-height: 90px !important;
            }

            .theme-toggle-btn {
                width: 40px;
                height: 40px;
            }

            #fixed-header {
                position: sticky;
                top: 0;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            body {
                background: white !important;
            }

            .premium-card,
            .stat-card {
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                page-break-inside: avoid;
            }

            #theme-toggle,
            #calculator-btn,
            #shopping-list-btn,
            #logout-btn {
                display: none !important;
            }

            /* Radio player на мобильных - компактный */
            [role="region"][aria-label="Radio player"] {
                padding: 0.375rem 0.5rem !important;
                min-width: auto;
            }

            nav {
                display: none !important;
            }
        }
    </style>

    <script>
        // Calculator Logic
        let calculator = {
            currentValue: '0',
            previousValue: null,
            operation: null,
            shouldReset: false
        };

        const calcDisplay = document.getElementById('calc-display');
        const calcButtons = document.querySelectorAll('.calc-btn');

        function updateDisplay() {
            calcDisplay.value = calculator.currentValue;
        }

        function calculate(a, b, op) {
            const num1 = parseFloat(a);
            const num2 = parseFloat(b);
            switch (op) {
                case '+': return (num1 + num2).toString();
                case '−': return (num1 - num2).toString();
                case '×': return (num1 * num2).toString();
                case '÷': return num2 !== 0 ? (num1 / num2).toString() : 'Error';
                default: return '0';
            }
        }

        calcButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const value = btn.dataset.value;

                if (value >= '0' && value <= '9' || value === '.') {
                    if (calculator.shouldReset) {
                        calculator.currentValue = '0';
                        calculator.shouldReset = false;
                    }
                    if (calculator.currentValue === '0') {
                        calculator.currentValue = value === '.' ? '0.' : value;
                    } else {
                        if (value === '.' && calculator.currentValue.includes('.')) return;
                        calculator.currentValue += value;
                    }
                } else if (value === 'clear') {
                    calculator.currentValue = '0';
                    calculator.previousValue = null;
                    calculator.operation = null;
                } else if (value === 'clearEntry') {
                    calculator.currentValue = '0';
                } else if (value === 'backspace') {
                    calculator.currentValue = calculator.currentValue.length > 1
                        ? calculator.currentValue.slice(0, -1)
                        : '0';
                } else if (['+', '−', '×', '÷'].includes(value)) {
                    if (calculator.previousValue !== null && calculator.operation) {
                        calculator.currentValue = calculate(calculator.previousValue, calculator.currentValue, calculator.operation);
                    }
                    calculator.previousValue = calculator.currentValue;
                    calculator.operation = value;
                    calculator.shouldReset = true;
                } else if (value === '=') {
                    if (calculator.previousValue !== null && calculator.operation) {
                        calculator.currentValue = calculate(calculator.previousValue, calculator.currentValue, calculator.operation);
                        calculator.previousValue = null;
                        calculator.operation = null;
                    }
                    calculator.shouldReset = true;
                }

                updateDisplay();
            });
        });

        // Calculator Modal
        document.getElementById('calculator-btn').addEventListener('click', () => {
            document.getElementById('calculator-modal').showModal();
        });
        document.getElementById('close-calculator').addEventListener('click', () => {
            document.getElementById('calculator-modal').close();
        });

        // Shopping List Logic
        let shoppingList = JSON.parse(localStorage.getItem('shoppingList') || '[]');

        function calculateTotal() {
            const total = shoppingList.reduce((sum, item) => {
                return sum + (item.price || 0) * (item.quantity || 1);
            }, 0);
            document.getElementById('shopping-total').textContent = total.toFixed(2) + ' AZN';
        }

        function renderShoppingList() {
            const tbody = document.getElementById('shopping-list-items');
            tbody.innerHTML = shoppingList.map((item, index) => {
                const total = (item.price || 0) * (item.quantity || 1);
                return `
                    <tr class="${item.completed ? 'completed' : ''}">
                        <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                            <input type="number" value="${item.quantity || 1}" min="1" 
                                onchange="updateQuantity(${index}, this.value)" 
                                class="w-16 p-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-center">
                        </td>
                        <td class="px-4 py-3">
                            <input type="text" value="${item.name || ''}" 
                                onblur="updateName(${index}, this.value)" 
                                class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                            <input type="number" value="${item.price || 0}" step="0.01" min="0" 
                                onchange="updatePrice(${index}, this.value)" 
                                class="w-24 p-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-right">
                        </td>
                        <td class="px-4 py-3 text-right text-sm font-semibold text-gray-900 dark:text-gray-100">${total.toFixed(2)} AZN</td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex gap-2 justify-center">
                                <input type="checkbox" ${item.completed ? 'checked' : ''} 
                                    onchange="toggleShoppingItem(${index})" 
                                    class="rounded cursor-pointer">
                                <button onclick="deleteShoppingItem(${index})" 
                                    class="px-2 py-1 text-red-600 hover:bg-red-50 dark:hover:bg-red-900 rounded text-sm">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            calculateTotal();
        }

        function toggleShoppingItem(index) {
            shoppingList[index].completed = !shoppingList[index].completed;
            renderShoppingList();
        }

        function updateQuantity(index, value) {
            shoppingList[index].quantity = parseInt(value) || 1;
            renderShoppingList();
        }

        function updateName(index, value) {
            if (value.trim()) {
                shoppingList[index].name = value.trim();
                renderShoppingList();
            }
        }

        function updatePrice(index, value) {
            shoppingList[index].price = parseFloat(value) || 0;
            renderShoppingList();
        }

        function deleteShoppingItem(index) {
            if (confirm('Удалить этот товар?')) {
                shoppingList.splice(index, 1);
                renderShoppingList();
            }
        }

        // Add shopping item
        document.getElementById('add-shopping-item').addEventListener('click', () => {
            const nameInput = document.getElementById('item-name');
            const quantityInput = document.getElementById('item-quantity');
            const priceInput = document.getElementById('item-price');

            const name = nameInput.value.trim();
            const quantity = parseInt(quantityInput.value) || 1;
            const price = parseFloat(priceInput.value) || 0;

            if (name) {
                shoppingList.push({
                    name,
                    quantity,
                    price,
                    completed: false
                });
                renderShoppingList();
                nameInput.value = '';
                quantityInput.value = '1';
                priceInput.value = '';
            }
        });

        document.getElementById('item-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('add-shopping-item').click();
            }
        });

        // Copy shopping list
        document.getElementById('copy-shopping-list').addEventListener('click', () => {
            const notCompleted = shoppingList.filter(item => !item.completed);
            const completed = shoppingList.filter(item => item.completed);

            const t = translations[currentLang];
            let text = `📋 ${t.shoppingListTitle.toUpperCase()}\n`;
            text += '═'.repeat(40) + '\n\n';

            if (notCompleted.length > 0) {
                text += `${t.toPurchase}:\n`;
                text += '─'.repeat(40) + '\n';
                notCompleted.forEach((item, idx) => {
                    const total = (item.price || 0) * (item.quantity || 1);
                    text += `${idx + 1}. ${item.name || 'Товар'}\n`;
                    text += `   ${item.quantity || 1} шт. × ${(item.price || 0).toFixed(2)} AZN = ${total.toFixed(2)} AZN\n\n`;
                });

                const notCompletedTotal = notCompleted.reduce((sum, item) =>
                    sum + (item.price || 0) * (item.quantity || 1), 0);
                text += `${t.shoppingListTotal}: ${notCompletedTotal.toFixed(2)} AZN\n\n`;
            }

            if (completed.length > 0) {
                text += `✅ ${t.purchased}:\n`;
                text += '─'.repeat(40) + '\n';
                completed.forEach((item, idx) => {
                    const total = (item.price || 0) * (item.quantity || 1);
                    text += `${idx + 1}. ${item.name || 'Товар'}\n`;
                    text += `   ${item.quantity || 1} шт. × ${(item.price || 0).toFixed(2)} AZN = ${total.toFixed(2)} AZN\n\n`;
                });

                const completedTotal = completed.reduce((sum, item) =>
                    sum + (item.price || 0) * (item.quantity || 1), 0);
                text += `${t.shoppingListTotal}: ${completedTotal.toFixed(2)} AZN\n\n`;
            }

            const grandTotal = shoppingList.reduce((sum, item) =>
                sum + (item.price || 0) * (item.quantity || 1), 0);
            text += '═'.repeat(40) + '\n';
            text += `${t.generalTotal}: ${grandTotal.toFixed(2)} AZN\n`;
            text += '═'.repeat(40);

            navigator.clipboard.writeText(text).then(() => {
                showToast('Список скопирован в буфер обмена!');
            });
        });

        // Shopping List Modal
        document.getElementById('shopping-list-btn').addEventListener('click', () => {
            renderShoppingList();
            document.getElementById('shopping-list-modal').showModal();
        });
        document.getElementById('close-shopping-list').addEventListener('click', () => {
            document.getElementById('shopping-list-modal').close();
        });

        // Make functions globally accessible
        window.toggleShoppingItem = toggleShoppingItem;
        window.updateQuantity = updateQuantity;
        window.updateName = updateName;
        window.updatePrice = updatePrice;
        window.deleteShoppingItem = deleteShoppingItem;

        // ============================================
        // KEYBOARD SHORTCUTS - Premium UX Enhancement
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Ignore if user is typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Ctrl/Cmd + E: Add Expense
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                document.getElementById('add-expense-btn')?.click();
            }

            // Ctrl/Cmd + T: Add Task
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                document.getElementById('add-daily-task-btn')?.click();
            }

            // Ctrl/Cmd + D: Add Debt
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                document.getElementById('add-debt-btn')?.click();
            }

            // Ctrl/Cmd + R: Add Recurring Expense
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                document.getElementById('add-recurring-expense-btn')?.click();
            }

            // Escape: Close any open modal
            if (e.key === 'Escape') {
                document.querySelectorAll('dialog[open]').forEach(dialog => dialog.close());
            }

            // Ctrl/Cmd + K: Focus search (if exists)
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.querySelector('input[type="search"], input[placeholder*="поиск"], input[placeholder*="search"]');
                searchInput?.focus();
            }
        });

        // Show keyboard shortcuts hint on first load
        if (!localStorage.getItem('keyboardShortcutsShown')) {
            setTimeout(() => {
                showToast(currentLang === 'ru' ? '💡 Используйте Ctrl+E/T/D/R для быстрых действий' :
                    currentLang === 'az' ? '💡 Sürətli əməliyyatlar üçün Ctrl+E/T/D/R istifadə edin' :
                        '💡 Use Ctrl+E/T/D/R for quick actions', 'success');
                localStorage.setItem('keyboardShortcutsShown', 'true');
            }, 3000);
        }

        // ============================================
        // PERFORMANCE OPTIMIZATION - Debounce Helper
        // ============================================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Apply debounce to search/filter functions if they exist
        if (typeof window.filterExpenses === 'function') {
            window.filterExpenses = debounce(window.filterExpenses, 300);
        }
        if (typeof window.searchTasks === 'function') {
            window.searchTasks = debounce(window.searchTasks, 300);
        }

        // Initialize Particles.js
        if (typeof particlesJS !== 'undefined') {
            // Определяем цвет частиц в зависимости от темы
            const isDark = document.documentElement.classList.contains('dark');
            const particleColor = isDark ? '#ffffff' : '#B8941F';
            
            particlesJS('particles-js', {
                particles: {
                    number: { value: 60, density: { enable: true, value_area: 800 } },
                    color: { value: particleColor },
                    shape: { type: 'circle' },
                    opacity: { value: isDark ? 0.3 : 0.35, random: true },
                    size: { value: isDark ? 2.5 : 3, random: true },
                    line_linked: { 
                        enable: true, 
                        distance: 150, 
                        color: particleColor, 
                        opacity: isDark ? 0.2 : 0.25, 
                        width: 1.5 
                    },
                    move: { 
                        enable: true, 
                        speed: 1.5, 
                        direction: 'none', 
                        random: true, 
                        straight: false, 
                        out_mode: 'out', 
                        bounce: false 
                    }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { 
                        onhover: { enable: true, mode: 'grab' }, 
                        onclick: { enable: true, mode: 'push' }, 
                        resize: true 
                    },
                    modes: { 
                        grab: { distance: 140, line_linked: { opacity: 0.6 } },
                        push: { particles_nb: 4 } 
                    }
                },
                retina_detect: true
            });
        }

        console.log('✨ ORDINA CANDY loaded successfully!');
        console.log('🎨 Ultra-modern glassmorphism design activated');
        console.log('🎹 Keyboard shortcuts: Ctrl+E (Expense), Ctrl+T (Task), Ctrl+D (Debt), Ctrl+R (Recurring)');
    </script>

</body>

</html>