# Code Standards

Ориентация на Svelte best practices и единообразие кода. Детали тестов — в `Quality_and_Maintenance.md`.

## Общие принципы

1. **TypeScript strict:** Все новые и изменяемые файлы — с типами; избегать `any` без явной причины (допустимо временно при маппинге Firestore snapshot с пометкой).
2. **Один источник правды:** Доменное состояние — только в stores; побочные эффекты (Firebase, fetch) — только в services.
3. **Локализация:** Строки интерфейса — через i18n; ключи в `src/locales/*.json`; не хардкодить пользовательские строки в компонентах.
4. **Именование:** Понятные имена переменных и функций; компоненты — PascalCase; файлы компонентов — PascalCase.svelte; stores/services/utils — camelCase.ts.

## Svelte

- **Компоненты:** Логика в `<script lang="ts">`; стили в `<style>` (предпочтительно scoped). Избегать излишней вложенности и дублирования логики; выносить повторяющуюся логику в store или утилиту.
- **Stores:** Читать через `$store` в разметке; обновлять через методы store (`update`, set-методы). Не мутировать состояние store снаружи без вызова методов store.
- **События:** Взаимодействие родитель–потомок — через `on:event` и `dispatch`; глобальное состояние — через stores. Для модалок использовать `uiStore.activeModal` и пропсы контекста.
- **Доступность:** Семантические теги (button, nav, main, heading); aria-атрибуты где нужно; фокус в модалках. Не полагаться только на визуальные подсказки.
- **Производительность:** Для длинных списков использовать VirtualList; не подписываться на весь store, если нужна только часть (предпочитать derived или локальные переменные при необходимости).

## TypeScript

- **Типы сущностей:** Все модели данных — в `src/lib/types/index.ts`. При добавлении полей в Firestore добавлять/обновлять интерфейсы и при необходимости New*/Update* типы.
- **Импорты типов:** Использовать `import type` для типов где возможно.
- **Сервисы и stores:** Сигнатуры методов хранить стабильными; при смене контракта обновлять все вызовы и при необходимости документацию.

## Стили

- **Tailwind:** Использовать утилитарные классы для раскладки и отступов; кастомные значения — через tailwind.config или CSS-переменные при необходимости.
- **Глобальные стили:** Только в `src/styles/` и импорте из `main`/app.css; не дублировать глобальные правила в компонентах.
- **Тема:** Переключение светлая/тёмная через класс или data-атрибут на корне; стили компонентов опираются на эту метку и контраст (см. themeValidator, accessibility).

## Тесты

- **Unit/интеграция:** Рядом с кодом (`*.test.ts`) или в том же каталоге; Vitest + jsdom. Покрывать критические утилиты, сервисы, stores и логику carry-over/export.
- **E2E:** В `tests/e2e/`; Playwright; использовать хелперы из `tests/e2e/helpers.ts`. Для надёжного выбора элементов предпочитать `data-testid` (см. `tests/e2e/README.md`).
- **Свойства (property-based):** Где уместно — fast-check для инвариантов (форматирование, конвертация валют, carry-over).
- **A11y:** axe-core в E2E и при необходимости в unit; требования — WCAG 2.1 AA.

## Линтинг

- **Конфиг:** используется `.eslintrc.cjs` (TypeScript ESLint). В `package.json` нет отдельного `lint`-скрипта.
- **Важно:** ESLint v9 требует `eslint.config.js`; при запуске `npx eslint .` с v9 будет ошибка миграции. Для линтинга либо добавить новый flat-config, либо запускать ESLint v8.

## Ошибки и логирование

- **Обработка ошибок:** Глобальный обработчик — в `main.ts` (`initGlobalErrorHandler`); компоненты — ErrorBoundary. В сервисах перехватывать ошибки и при необходимости логировать через `logger`; не глотать ошибки без логирования.
- **Логирование:** Использовать `src/lib/utils/logger.ts`; в production консоль отключена (Vite build: drop_console). Не оставлять лишних console.log в коммитах.

## Запрещённые практики

- Прямой импорт Firebase в компонентах (кроме инициализации auth/listeners в App.svelte).
- Глобальные переменные для доменного состояния вместо stores.
- Хардкод строк интерфейса без i18n.
- Изменение структуры Firestore без обновления типов и документации.
- Удаление или переименование основных методов stores без обновления всех потребителей.

При противоречии с другими документами приоритет у `Skeleton.md`. Дополнительно — `docs/ARCHITECTURE.md`, `docs/COMPONENTS.md`.
